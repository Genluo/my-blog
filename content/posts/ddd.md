+++
date = '2025-09-01T10:16:15+08:00'
draft = false
title = 'é¢†åŸŸé©±åŠ¨è®¾è®¡'
description = 'æœåŠ¡ç«¯ä¸­çš„é¢†åŸŸé©±åŠ¨è®¾è®¡çš„åº”ç”¨åŠå…¶è§£æ'
tags = ['æœåŠ¡ç«¯']
+++

## å¥‘æœº

æœ€è¿‘å› ä¸ºä¸€äº›å¥‘æœºçœ‹äº†ä¸‹äº’åŠ¨å°æ¸¸æˆçš„æœåŠ¡ç«¯ï¼Œæ·±å…¥äº†è§£äº†ä¸‹ç°åœ¨äº’åŠ¨æ¸¸æˆæœåŠ¡ç«¯çš„æ¶æ„ï¼ŒåŒæ—¶ä¹Ÿå°è¯•åœ¨è¿™ä¸ªæ¶æ„çš„åŸºç¡€ä¸Šä½¿ç”¨ AI è¿›è¡Œä¸€äº›æ¸¸æˆä¸šåŠ¡åŠŸèƒ½å¼€å‘ï¼Œå…¶ä¸­å°è±¡æœ€æ·±çš„æœåŠ¡ç«¯çš„ä¸€ä¸ªç§°ä¹‹ä¸ºåŸºåº§çš„æ¶æ„è®¾è®¡ï¼Œè¿™ä¸ªåŸºåº§æ¶æ„æ·±åº¦ä½¿ç”¨ `DDD` é¢†åŸŸè®¾è®¡æ€æƒ³è¿›è¡ŒæŠ½è±¡å®ç°ï¼Œåœ¨æ¸¸æˆä¸šåŠ¡éå¸¸çµæ´»ï¼Œå¤ç”¨æ€§éå¸¸é«˜ï¼Œæ‰€ä»¥æƒ³çœ‹ä¸‹åœ¨`NodeJS` ä¸­é’ˆå¯¹ `DDD`é¢†åŸŸé©±åŠ¨è®¾è®¡æ˜¯å¦æœ‰ä¸€å®šçš„å®è·µã€‚ä¸‹é¢ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ä¸ºä»€ä¹ˆæ˜¯`DDD`ï¼Ÿå¦ä¸€ä¸ª `NodeJS`ä¸­ä¸€äº›å®è·µ

## `DDD`

### ä»€ä¹ˆæ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆdomain driving designï¼‰

é¢†åŸŸé©±åŠ¨è®¾è®¡æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ–¹æ³•ï¼Œç”¨äºè¡¨ç¤ºå’Œç»„ç»‡ç‰¹å®šé¢†åŸŸä¸­çš„çŸ¥è¯†å’Œä¸šåŠ¡é€»è¾‘ã€‚å®ƒä¸»è¦é€šè¿‡åˆ›å»ºæŠ½è±¡çš„æ¨¡å‹å¯¹è±¡æ¥æ¨¡æ‹Ÿç°å®ä¸–ç•Œçš„å®ä½“åŠå…¶å…³ç³»ï¼Œå¸®åŠ©å¼€å‘äººå‘˜ç†è§£å’Œå®ç°å¤æ‚ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘ã€‚åœ¨é¢†åŸŸé©±åŠ¨è®¾è®¡ä¸­ï¼Œé€šå¸¸ä¼šåŒ…å«ä»¥ä¸‹å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š

1. **å®ä½“ï¼ˆEntityï¼‰**ï¼šå…·æœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œé€šå¸¸è¡¨ç¤ºä¸šåŠ¡ä¸­çš„ä¸€ä¸ªç‹¬ç«‹çš„æ¦‚å¿µæˆ–å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªè®¢å•ç³»ç»Ÿä¸­ï¼Œè®¢å•å’Œå®¢æˆ·å¯ä»¥è¢«è§†ä¸ºå®ä½“ã€‚

2. **å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰**ï¼šæ²¡æœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œé€šå¸¸ç”¨äºæè¿°æŸä¸ªå®ä½“çš„å±æ€§æˆ–ç»†èŠ‚ã€‚å®ƒä»¬æ˜¯ä¸å¯å˜çš„ï¼Œä¸¤ä¸ªå€¼å¯¹è±¡å¦‚æœå…·æœ‰ç›¸åŒçš„å±æ€§å€¼ï¼Œåˆ™è®¤ä¸ºæ˜¯ç›¸ç­‰çš„ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåœ°å€å¯ä»¥ä½œä¸ºä¸€ä¸ªå€¼å¯¹è±¡ã€‚

3. **èšåˆï¼ˆAggregateï¼‰**ï¼šä¸€ç»„ç›¸å…³çš„å¯¹è±¡ï¼ˆå®ä½“å’Œå€¼å¯¹è±¡ï¼‰çš„é›†åˆï¼Œå®ƒä»¬è¢«è§†ä¸ºä¸€ä¸ªå•å…ƒè¿›è¡Œæ•°æ®ä¿®æ”¹ã€‚èšåˆæœ‰ä¸€ä¸ªæ ¹å®ä½“ï¼ˆAggregate Rootï¼‰ï¼Œé€šè¿‡æ ¹å®ä½“æ¥ç®¡ç†èšåˆçš„ç”Ÿå‘½å‘¨æœŸã€‚

4. **é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰**ï¼šå°è£…é¢†åŸŸé€»è¾‘çš„æ“ä½œï¼Œè¿™äº›æ“ä½œä¸å±äºä»»ä½•ä¸€ä¸ªå®ä½“æˆ–å€¼å¯¹è±¡ã€‚å®ƒä»¬é€šå¸¸ç”¨äºè¡¨ç¤ºè·¨è¶Šå¤šä¸ªå®ä½“æˆ–å€¼å¯¹è±¡çš„ä¸šåŠ¡é€»è¾‘ã€‚

5. **ä»“å‚¨ï¼ˆRepositoryï¼‰**ï¼šæä¾›è®¿é—®æŒä¹…åŒ–å­˜å‚¨ä¸­å¯¹è±¡çš„æ–¹æ³•ï¼Œé€šå¸¸ç”¨äºè·å–å’Œä¿å­˜èšåˆæ ¹ã€‚

#### ä»€ä¹ˆæ˜¯èšåˆæ ¹

æŒ‡çš„æ˜¯ä¸€ä¸ªèšåˆä¸­å…·æœ‰å”¯ä¸€æ ‡è¯†çš„æ ¸å¿ƒå®ä½“ï¼Œè¯¥å®ä½“è´Ÿè´£æ§åˆ¶æ•´ä¸ªèšåˆçš„ç”Ÿå‘½å‘¨æœŸå’Œä¸€è‡´æ€§ã€‚

1. **æ§åˆ¶è®¿é—®**ï¼šèšåˆæ ¹æ˜¯èšåˆå†…çš„å”¯ä¸€å…¥å£ç‚¹ï¼Œå¤–éƒ¨å¯¹è±¡åªèƒ½é€šè¿‡èšåˆæ ¹æ¥è®¿é—®æˆ–æ“ä½œèšåˆä¸­çš„å…¶å®ƒå¯¹è±¡ã€‚è¿™æœ‰åŠ©äºä¿æŒèšåˆå†…éƒ¨çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚

2. **ç®¡ç†ç”Ÿå‘½å‘¨æœŸ**ï¼šèšåˆæ ¹è´Ÿè´£ç®¡ç†èšåˆå†…æ‰€æœ‰å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤æ“ä½œã€‚é€šè¿‡èšåˆæ ¹ï¼Œå¯ä»¥ç¡®ä¿å¯¹èšåˆä¸­æ•°æ®çš„ä»»ä½•ä¿®æ”¹éƒ½æ˜¯åˆæ³•å’Œä¸€è‡´çš„ã€‚

3. **ä¸€è‡´æ€§è¾¹ç•Œ**ï¼šèšåˆå®šä¹‰äº†ä¸€ä¸ªä¸€è‡´æ€§è¾¹ç•Œï¼Œå…¶ä¸­çš„æ‰€æœ‰å¯¹è±¡åœ¨äº‹åŠ¡ä¸­åº”è¯¥ä¿æŒä¸€è‡´ã€‚å› æ­¤ï¼Œèšåˆæ ¹é€šè¿‡ç¡®ä¿åœ¨å…¶èŒƒå›´å†…çš„æ“ä½œéƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ¥ç»´æŒè¿™ç§è¾¹ç•Œã€‚

4. **å”¯ä¸€æ€§**ï¼šæ¯ä¸ªèšåˆéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„èšåˆæ ¹ã€‚é€šå¸¸ï¼Œèšåˆæ ¹å…·æœ‰å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨æ¥æ ‡è¯†å’Œè®¿é—®è¯¥èšåˆã€‚

5. **æŒä¹…åŒ–ç®¡ç†**ï¼šé€šè¿‡ä»“å‚¨ï¼ˆRepositoryï¼‰æ¨¡å¼ï¼Œèšåˆæ ¹é€šå¸¸æ˜¯æŒä¹…åŒ–æ“ä½œï¼ˆå¦‚ä¿å­˜å’Œæ£€ç´¢ï¼‰çš„ä¸»è¦å¯¹è±¡ã€‚è¿™æ„å‘³ç€ä»“å‚¨é€šå¸¸åªç›´æ¥å¤„ç†èšåˆæ ¹ï¼Œè€Œä¸æ˜¯èšåˆå†…çš„å…¶å®ƒå¯¹è±¡ã€‚

### é¢†åŸŸé©±åŠ¨è®¾è®¡ä¼˜ç¼ºç‚¹

é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDomain-Driven Design, DDDï¼‰æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ–¹æ³•ï¼Œæ—¨åœ¨é€šè¿‡ç´§å¯†ç»“åˆä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯å®ç°æ¥æ„å»ºå¤æ‚è½¯ä»¶ç³»ç»Ÿã€‚ä»¥ä¸‹æ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡çš„ä¸€äº›ä¼˜ç¼ºç‚¹ï¼š

#### ä¼˜ç‚¹

1. **æ›´å¥½åœ°ç†è§£ä¸šåŠ¡**ï¼š
   - DDDå¼ºè°ƒä¸é¢†åŸŸä¸“å®¶çš„å¯†åˆ‡åˆä½œï¼Œä½¿å¼€å‘å›¢é˜Ÿå¯¹ä¸šåŠ¡éœ€æ±‚æœ‰æ›´æ·±å…¥çš„ç†è§£ã€‚è¿™æœ‰åŠ©äºåˆ›å»ºæ›´ç¬¦åˆä¸šåŠ¡éœ€æ±‚çš„ç³»ç»Ÿã€‚

2. **æ¸…æ™°çš„æ¨¡å‹**ï¼š
   - é€šè¿‡ä½¿ç”¨ç»Ÿä¸€è¯­è¨€å’Œé¢†åŸŸæ¨¡å‹ï¼Œæ‰€æœ‰å›¢é˜Ÿæˆå‘˜ï¼ˆåŒ…æ‹¬æŠ€æœ¯äººå‘˜å’ŒéæŠ€æœ¯äººå‘˜ï¼‰éƒ½å¯ä»¥åœ¨åŒä¸€è¯­å¢ƒä¸‹æ²Ÿé€šï¼Œä»è€Œå‡å°‘è¯¯è§£ã€‚

3. **çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§**ï¼š
   - DDDé¼“åŠ±æ¨¡å—åŒ–è®¾è®¡ï¼Œå¦‚ç•Œé™ä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰å’Œèšåˆï¼ˆAggregateï¼‰ï¼Œè¿™äº›è®¾è®¡æœ‰åŠ©äºç®€åŒ–ç³»ç»Ÿçš„ç»´æŠ¤å’Œæ‰©å±•ã€‚

4. **å…³æ³¨æ ¸å¿ƒé¢†åŸŸ**ï¼š
   - é€šè¿‡è¯†åˆ«å’Œèšç„¦äºæ ¸å¿ƒé¢†åŸŸï¼ŒDDDå¸®åŠ©å›¢é˜Ÿå°†èµ„æºé›†ä¸­åœ¨å¯¹ä¸šåŠ¡æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œä»è€Œæé«˜ç«äº‰åŠ›ã€‚

5. **æ”¯æŒå¤æ‚ç³»ç»Ÿå¼€å‘**ï¼š
   - DDDä¸ºå¤„ç†å¤æ‚é¢†åŸŸé€»è¾‘æä¾›äº†æœ‰åŠ›çš„æ–¹æ³•å’Œå·¥å…·ï¼Œå¯ä»¥æœ‰æ•ˆåœ°ç®¡ç†å¤æ‚æ€§ã€‚

#### ç¼ºç‚¹

1. **å­¦ä¹ æ›²çº¿é™¡å³­**ï¼š
   - å¯¹è®¸å¤šå¼€å‘äººå‘˜å’Œç»„ç»‡æ¥è¯´ï¼ŒDDDçš„æ¦‚å¿µå’ŒæŠ€æœ¯æœ¯è¯­å¯èƒ½è¾ƒä¸ºé™Œç”Ÿï¼Œåˆå§‹å­¦ä¹ å’Œå®æ–½æˆæœ¬è¾ƒé«˜ã€‚

2. **æ—¶é—´å’Œèµ„æºæŠ•å…¥å¤§**ï¼š
   - ç”±äºéœ€è¦æ·±åº¦çš„é¢†åŸŸåˆ†æå’ŒæŒç»­çš„å›¢é˜Ÿåä½œï¼ŒDDDå¯èƒ½æ¯”ä¼ ç»Ÿæ–¹æ³•èŠ±è´¹æ›´å¤šæ—¶é—´å’Œèµ„æºã€‚

3. **ä¸é€‚åˆæ‰€æœ‰é¡¹ç›®**ï¼š
   - å¯¹äºç®€å•æˆ–å°å‹é¡¹ç›®ï¼ŒDDDå¯èƒ½è¿‡äºå¤æ‚å’Œå†—ä½™ï¼ŒæŠ•å…¥çš„æˆæœ¬å’Œæ”¶ç›Šä¸æˆæ¯”ä¾‹ã€‚

4. **éœ€æ±‚ç¨³å®šæ€§è¦æ±‚é«˜**ï¼š
   - DDDæ›´é€‚åˆäºéœ€æ±‚ç›¸å¯¹ç¨³å®šä¸”å¯¹ä¸šåŠ¡é€»è¾‘è¦æ±‚é«˜çš„é¡¹ç›®ã€‚å¯¹äºéœ€æ±‚é¢‘ç¹å˜åŒ–çš„é¡¹ç›®ï¼Œå¯èƒ½éœ€è¦ç»å¸¸é‡æ„ã€‚

5. **å¯¹å›¢é˜Ÿåä½œè¦æ±‚é«˜**ï¼š
   - æˆåŠŸå®æ–½DDDéœ€è¦å›¢é˜Ÿæˆå‘˜ä¹‹é—´è‰¯å¥½çš„æ²Ÿé€šå’Œåä½œï¼Œè¿™å¯¹å›¢é˜Ÿçš„ç»„ç»‡æ–‡åŒ–å’Œæ²Ÿé€šèƒ½åŠ›æå‡ºäº†è¾ƒé«˜è¦æ±‚ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦é¢†åŸŸæ¨¡å‹

åœ¨ä¼ ç»Ÿçš„è½¯ä»¶å¼€å‘ä¸­,æˆ‘ä»¬å¸¸å¸¸é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š

#### 1. è´«è¡€æ¨¡å‹çš„å›°å¢ƒ

ä¼ ç»Ÿçš„å¼€å‘æ–¹å¼å¾€å¾€é‡‡ç”¨"è´«è¡€æ¨¡å‹"ï¼ˆAnemic Domain Modelï¼‰ï¼Œå³ï¼š

- **æ•°æ®å¯¹è±¡åªåŒ…å«å­—æ®µå’Œç®€å•çš„ getter/setter**ï¼Œæ²¡æœ‰ä»»ä½•ä¸šåŠ¡é€»è¾‘
- **æ‰€æœ‰ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨ Service å±‚**ï¼Œå½¢æˆåºå¤§çš„æœåŠ¡ç±»
- **æ•°æ®å’Œè¡Œä¸ºåˆ†ç¦»**ï¼Œå¯¼è‡´ä»£ç éš¾ä»¥ç†è§£å’Œç»´æŠ¤

#### 2. ä¸šåŠ¡é€»è¾‘æ•£ä¹±

- **ç¼ºä¹ç»Ÿä¸€çš„ä¸šåŠ¡è§„åˆ™ç®¡ç†**ï¼šåŒæ ·çš„ä¸šåŠ¡é€»è¾‘å¯èƒ½åœ¨å¤šä¸ªåœ°æ–¹é‡å¤å®ç°
- **éš¾ä»¥ä¿è¯ä¸€è‡´æ€§**ï¼šè®¢å•åˆ›å»ºã€ä¿®æ”¹ã€å–æ¶ˆç­‰æ“ä½œä¸­çš„ä¸šåŠ¡è§„åˆ™å¯èƒ½ä¸ä¸€è‡´
- **ç»´æŠ¤æˆæœ¬é«˜**ï¼šä¿®æ”¹ä¸€ä¸ªä¸šåŠ¡è§„åˆ™éœ€è¦åœ¨å¤šä¸ªåœ°æ–¹æŸ¥æ‰¾å’Œä¿®æ”¹

#### 3. æŠ€æœ¯ä¸ä¸šåŠ¡è„±èŠ‚

- **ä»£ç éš¾ä»¥åæ˜ ä¸šåŠ¡æ„å›¾**ï¼šå¼€å‘äººå‘˜çœ‹åˆ°çš„æ˜¯è¡¨ã€å­—æ®µã€SQLï¼Œè€Œä¸æ˜¯è®¢å•ã€æ”¯ä»˜ã€å‘è´§ç­‰ä¸šåŠ¡æ¦‚å¿µ
- **ä¸é¢†åŸŸä¸“å®¶æ²Ÿé€šå›°éš¾**ï¼šæŠ€æœ¯æœ¯è¯­å’Œä¸šåŠ¡æœ¯è¯­æ— æ³•å¯¹åº”ï¼Œå®¹æ˜“äº§ç”Ÿç†è§£åå·®
- **éœ€æ±‚å˜æ›´ä»£ä»·å¤§**ï¼šä¸šåŠ¡è°ƒæ•´æ—¶ï¼Œéœ€è¦ä»åº•å±‚æ•°æ®ç»“æ„å¼€å§‹é‡æ–°è®¾è®¡

#### é¢†åŸŸæ¨¡å‹å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜

é¢†åŸŸæ¨¡å‹é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³ä¸Šè¿°é—®é¢˜ï¼š

##### 1. å°è£…ä¸šåŠ¡é€»è¾‘

  ```javascript
  // å……è¡€æ¨¡å‹ç¤ºä¾‹
  class Order {
    constructor(id, userId) {
      this.id = id;
      this.userId = userId;
      this.items = [];
      this.status = 'PENDING';
    }

    // ä¸šåŠ¡é€»è¾‘å°è£…åœ¨å®ä½“å†…éƒ¨
    addItem(product, quantity) {
      if (this.status !== 'PENDING') {
        throw new Error('åªèƒ½å‘å¾…å¤„ç†è®¢å•æ·»åŠ å•†å“');
      }
      if (quantity <= 0) {
        throw new Error('å•†å“æ•°é‡å¿…é¡»å¤§äº0');
      }
      this.items.push({ product, quantity });
    }

    submit() {
      if (this.items.length === 0) {
        throw new Error('è®¢å•ä¸èƒ½ä¸ºç©º');
      }
      this.status = 'SUBMITTED';
      // è§¦å‘é¢†åŸŸäº‹ä»¶
      this.addDomainEvent(new OrderSubmittedEvent(this));
    }

    calculateTotal() {
      return this.items.reduce((sum, item) =>
        sum + item.product.price * item.quantity, 0);
    }
  }
  ```

##### 2. ç»Ÿä¸€è¯­è¨€ï¼ˆUbiquitous Languageï¼‰

- ä»£ç ä¸­çš„ç±»åã€æ–¹æ³•åç›´æ¥å¯¹åº”ä¸šåŠ¡æ¦‚å¿µ
- å¼€å‘äººå‘˜å’Œé¢†åŸŸä¸“å®¶ä½¿ç”¨ç›¸åŒçš„æœ¯è¯­
- ä»£ç å³æ–‡æ¡£ï¼Œä¸šåŠ¡è§„åˆ™æ¸…æ™°å¯è§

##### 3. ç»´æŠ¤ä¸šåŠ¡ä¸å˜æ€§ï¼ˆInvariantsï¼‰

- é€šè¿‡èšåˆæ ¹æ§åˆ¶çŠ¶æ€å˜æ›´
- ç¡®ä¿å¯¹è±¡å§‹ç»ˆå¤„äºæœ‰æ•ˆçŠ¶æ€
- ä¸šåŠ¡è§„åˆ™åœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰å’Œç»´æŠ¤

##### 4. é™ä½è®¤çŸ¥è´Ÿæ‹…

- æ¯ä¸ªé¢†åŸŸå¯¹è±¡èŒè´£æ¸…æ™°
- ä¸šåŠ¡é€»è¾‘å†…èšï¼Œæ˜“äºç†è§£å’Œæµ‹è¯•
- ä¿®æ”¹å½±å“èŒƒå›´å¯æ§

#### å®è·µä»·å€¼

å¼•å…¥é¢†åŸŸæ¨¡å‹åï¼Œå¸¦æ¥çš„å®é™…ä»·å€¼ï¼š

1. **ä»£ç å¯è¯»æ€§æå‡**ï¼šæ–°äººå¯ä»¥é€šè¿‡é˜…è¯»é¢†åŸŸæ¨¡å‹å¿«é€Ÿç†è§£ä¸šåŠ¡
2. **ç»´æŠ¤æˆæœ¬é™ä½**ï¼šä¸šåŠ¡è§„åˆ™é›†ä¸­ç®¡ç†ï¼Œä¿®æ”¹å½±å“èŒƒå›´æ˜ç¡®
3. **æµ‹è¯•æ›´å®¹æ˜“**ï¼šé¢†åŸŸå¯¹è±¡å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼Œä¸ä¾èµ–æ•°æ®åº“å’Œå¤–éƒ¨æœåŠ¡
4. **åº”å¯¹å¤æ‚åº¦**ï¼šå½“ä¸šåŠ¡é€»è¾‘å˜å¾—å¤æ‚æ—¶ï¼Œé¢†åŸŸæ¨¡å‹çš„ä¼˜åŠ¿æ›´åŠ æ˜æ˜¾
5. **é•¿æœŸä»·å€¼**ï¼šéšç€é¡¹ç›®æ¼”è¿›ï¼Œé¢†åŸŸæ¨¡å‹å¸®åŠ©ä¿æŒä»£ç è´¨é‡å’Œæ¶æ„æ¸…æ™°åº¦

> **æ€»ç»“**ï¼šé¢†åŸŸæ¨¡å‹ä¸æ˜¯é“¶å¼¹ï¼Œä½†å¯¹äºä¸šåŠ¡é€»è¾‘å¤æ‚çš„ç³»ç»Ÿæ¥è¯´ï¼Œå®ƒæä¾›äº†ä¸€ç§æ›´åŠ è´´è¿‘ä¸šåŠ¡ã€æ˜“äºç»´æŠ¤çš„ä»£ç ç»„ç»‡æ–¹å¼ã€‚é€šè¿‡å°†æ•°æ®å’Œè¡Œä¸ºç»“åˆï¼Œé¢†åŸŸæ¨¡å‹è®©ä»£ç çœŸæ­£æˆä¸ºä¸šåŠ¡çŸ¥è¯†çš„è¡¨è¾¾

### ä¸¾ä¾‹

ä¸‹é¢é€šè¿‡ä¸€ä¸ªæ¸¸æˆä¸­çš„"å® ç‰©å–‚å…»å‡çº§"æ¨¡å‹æ¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨DDDè¿›è¡Œè®¾è®¡

#### ä¸šåŠ¡åœºæ™¯

åœ¨ä¸€ä¸ªå® ç‰©å…»æˆæ¸¸æˆä¸­ï¼Œç©å®¶å¯ä»¥ï¼š

- å–‚å…»å® ç‰©è·å¾—ç»éªŒå€¼
- å® ç‰©ç»éªŒå€¼è¾¾åˆ°ä¸€å®šæ•°é‡åè¿›è¡Œå‡çº§
- å® ç‰©å‡çº§åæœ‰å¯¹åº”çš„å¥–åŠ±ç‰©
- æœ€ç»ˆæ ¹æ®å® ç‰©çš„å¥–åŠ±ç‰©å‘æ”¾å¯¹åº”çš„å¥–åŠ±

#### ä¸šåŠ¡æµç¨‹å›¾

```mermaid
stateDiagram-v2
    [*] --> å¾…å–‚å…»: å® ç‰©åˆå§‹çŠ¶æ€

    å¾…å–‚å…» --> å¢åŠ ç»éªŒ: ç©å®¶å–‚å…»é£Ÿç‰©

    å¢åŠ ç»éªŒ --> æ£€æŸ¥å‡çº§æ¡ä»¶: ç»éªŒå€¼ç´¯åŠ 

    æ£€æŸ¥å‡çº§æ¡ä»¶ --> å‡çº§ä¸­: ç»éªŒå€¼ >= æ‰€éœ€ç»éªŒ
    æ£€æŸ¥å‡çº§æ¡ä»¶ --> å¾…å–‚å…»: ç»éªŒå€¼ < æ‰€éœ€ç»éªŒ

    å‡çº§ä¸­ --> å±æ€§æå‡: æ¶ˆè€—ç»éªŒå€¼
    å±æ€§æå‡ --> å¥–åŠ±ç”Ÿæˆ: ç­‰çº§+1, å±æ€§å¢åŠ 

    å¥–åŠ±ç”Ÿæˆ --> æ£€æŸ¥å‡çº§æ¡ä»¶: ç»§ç»­æ£€æŸ¥æ˜¯å¦èƒ½å†æ¬¡å‡çº§

    å¥–åŠ±ç”Ÿæˆ --> å‘æ”¾å¥–åŠ±: æ‰€æœ‰å‡çº§å®Œæˆ

    å‘æ”¾å¥–åŠ± --> å¾…å–‚å…»: å¥–åŠ±å‘æ”¾å®Œæ¯•

    note right of æ£€æŸ¥å‡çº§æ¡ä»¶
        ä¸åŒå“è´¨å® ç‰©
        æ‰€éœ€ç»éªŒä¸åŒ
        - æ™®é€š: 1.0x
        - ç¨€æœ‰: 1.2x
        - å²è¯—: 1.5x
    end note

    note right of å±æ€§æå‡
        å±æ€§å¢é•¿å…¬å¼
        HP: +10 * å“è´¨å€ç‡
        Attack: +5 * å“è´¨å€ç‡
    end note
```

**çŠ¶æ€è¯´æ˜**ï¼š

1. **å¾…å–‚å…»**ï¼šå® ç‰©çš„æ­£å¸¸çŠ¶æ€ï¼Œç­‰å¾…ç©å®¶æŠ•å–‚é£Ÿç‰©
2. **å¢åŠ ç»éªŒ**ï¼šå–‚å…»åç»éªŒå€¼å¢åŠ çš„ç¬æ—¶çŠ¶æ€
3. **æ£€æŸ¥å‡çº§æ¡ä»¶**ï¼šåˆ¤æ–­å½“å‰ç»éªŒæ˜¯å¦è¶³å¤Ÿå‡çº§ï¼ˆæ”¯æŒè¿ç»­å‡çº§ï¼‰
4. **å‡çº§ä¸­**ï¼šæ¶ˆè€—ç»éªŒå€¼ï¼Œè¿›è¡Œç­‰çº§æå‡
5. **å±æ€§æå‡**ï¼šæ ¹æ®å“è´¨å€ç‡è®¡ç®—æ–°çš„å±æ€§å€¼
6. **å¥–åŠ±ç”Ÿæˆ**ï¼šåŸºäºå‡çº§ç»“æœç”Ÿæˆå¥–åŠ±ç‰©å“
7. **å‘æ”¾å¥–åŠ±**ï¼šå°†å¥–åŠ±ç‰©å“å‘æ”¾ç»™ç©å®¶

#### ä¼ ç»Ÿå®ç°æ–¹å¼

```javascript
// æ•°æ®æ¨¡å‹
class Pet {
  id;
  name;
  level;
  exp;
  quality; // å“è´¨ï¼šæ™®é€šã€ç¨€æœ‰ã€å²è¯—
  hp;
  attack;
}

// Serviceå±‚å¤„ç†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
class PetService {
  async feed(petId, foodValue) {
    // 1. æŸ¥è¯¢å® ç‰©
    const pet = await db.query('SELECT * FROM pets WHERE id = ?', [petId]);

    // 2. è®¡ç®—ç»éªŒå€¼
    pet.exp += foodValue;

    // 3. æ£€æŸ¥æ˜¯å¦å‡çº§ï¼ˆé€»è¾‘åˆ†æ•£ï¼‰
    let levelUpCount = 0;
    while (pet.exp >= this.getRequiredExp(pet.level, pet.quality)) {
      pet.exp -= this.getRequiredExp(pet.level, pet.quality);
      pet.level += 1;
      levelUpCount++;
    }

    // 4. å‡çº§åå±æ€§è®¡ç®—ï¼ˆé€»è¾‘å¤æ‚ä¸”å®¹æ˜“å‡ºé”™ï¼‰
    if (levelUpCount > 0) {
      pet.hp += levelUpCount * 10 * this.getQualityMultiplier(pet.quality);
      pet.attack += levelUpCount * 5 * this.getQualityMultiplier(pet.quality);

      // 5. å‘é€é€šçŸ¥
      await this.sendLevelUpNotification(petId, pet.level);
    }

    // 6. ä¿å­˜
    await db.query('UPDATE pets SET level=?, exp=?, hp=?, attack=? WHERE id=?',
      [pet.level, pet.exp, pet.hp, pet.attack, petId]);

    return pet;
  }

  getRequiredExp(level, quality) {
    // å‡çº§æ‰€éœ€ç»éªŒè®¡ç®—é€»è¾‘
    const base = 100 * level;
    return quality === 'epic' ? base * 1.5 :
           quality === 'rare' ? base * 1.2 : base;
  }

  getQualityMultiplier(quality) {
    return quality === 'epic' ? 1.5 :
           quality === 'rare' ? 1.2 : 1.0;
  }
}
```

**é—®é¢˜**ï¼š

- ä¸šåŠ¡é€»è¾‘å…¨åœ¨Serviceå±‚ï¼Œä»£ç è‡ƒè‚¿
- Petåªæ˜¯æ•°æ®å®¹å™¨ï¼Œæ²¡æœ‰è¡Œä¸º
- å‡çº§è§„åˆ™ã€å±æ€§è®¡ç®—æ•£è½å„å¤„
- éš¾ä»¥ä¿è¯å® ç‰©çŠ¶æ€çš„ä¸€è‡´æ€§
- æµ‹è¯•å›°éš¾ï¼Œéœ€è¦mockæ•°æ®åº“

#### DDDå®ç°æ–¹å¼

##### 1. å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰- ç»éªŒå€¼

```javascript
// å€¼å¯¹è±¡ï¼šç»éªŒå€¼
class Experience {
  constructor(current, level, quality) {
    if (current < 0) throw new Error('ç»éªŒå€¼ä¸èƒ½ä¸ºè´Ÿ');
    this.current = current;
    this.level = level;
    this.quality = quality;
  }

  // è·å–å‡çº§æ‰€éœ€ç»éªŒ
  getRequiredForNextLevel() {
    const baseExp = 100 * this.level;
    const multiplier = {
      'common': 1.0,
      'rare': 1.2,
      'epic': 1.5
    }[this.quality] || 1.0;

    return Math.floor(baseExp * multiplier);
  }

  // æ·»åŠ ç»éªŒï¼Œè¿”å›æ–°çš„Experienceå¯¹è±¡ï¼ˆå€¼å¯¹è±¡ä¸å¯å˜ï¼‰
  add(value) {
    return new Experience(
      this.current + value,
      this.level,
      this.quality
    );
  }

  // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
  canLevelUp() {
    return this.current >= this.getRequiredForNextLevel();
  }

  // æ¶ˆè€—å‡çº§æ‰€éœ€ç»éªŒ
  consumeForLevelUp() {
    const required = this.getRequiredForNextLevel();
    return new Experience(
      this.current - required,
      this.level + 1,
      this.quality
    );
  }
}
```

##### 2. å€¼å¯¹è±¡ - å® ç‰©å±æ€§

```javascript
// å€¼å¯¹è±¡ï¼šå±æ€§
class PetStats {
  constructor(hp, attack, level, quality) {
    this.hp = hp;
    this.attack = attack;
    this.level = level;
    this.quality = quality;
  }

  // å‡çº§åçš„å±æ€§
  levelUp() {
    const multiplier = {
      'common': 1.0,
      'rare': 1.2,
      'epic': 1.5
    }[this.quality] || 1.0;

    return new PetStats(
      this.hp + Math.floor(10 * multiplier),
      this.attack + Math.floor(5 * multiplier),
      this.level + 1,
      this.quality
    );
  }
}
```

##### 3. é¢†åŸŸäº‹ä»¶

```javascript
// é¢†åŸŸäº‹ä»¶ï¼šå® ç‰©å‡çº§äº‹ä»¶
class PetLeveledUpEvent {
  constructor(petId, oldLevel, newLevel, stats) {
    this.petId = petId;
    this.oldLevel = oldLevel;
    this.newLevel = newLevel;
    this.stats = stats;
    this.occurredAt = new Date();
  }
}

// é¢†åŸŸäº‹ä»¶ï¼šå® ç‰©å–‚å…»äº‹ä»¶
class PetFedEvent {
  constructor(petId, foodValue, gainedExp) {
    this.petId = petId;
    this.foodValue = foodValue;
    this.gainedExp = gainedExp;
    this.occurredAt = new Date();
  }
}
```

##### 4. å®ä½“/èšåˆæ ¹ - å® ç‰©

```javascript
// èšåˆæ ¹ï¼šå® ç‰©
class Pet {
  constructor(id, name, quality, experience, stats) {
    this.id = id;
    this.name = name;
    this.quality = quality; // 'common', 'rare', 'epic'
    this.experience = experience; // Experienceå€¼å¯¹è±¡
    this.stats = stats; // PetStatså€¼å¯¹è±¡
    this.domainEvents = []; // é¢†åŸŸäº‹ä»¶åˆ—è¡¨
  }

  // å–‚å…»å® ç‰©
  feed(foodValue) {
    if (foodValue <= 0) {
      throw new Error('é£Ÿç‰©ä»·å€¼å¿…é¡»å¤§äº0');
    }

    // æ·»åŠ ç»éªŒ
    const oldExp = this.experience;
    this.experience = this.experience.add(foodValue);

    // è®°å½•å–‚å…»äº‹ä»¶
    this.addDomainEvent(new PetFedEvent(
      this.id,
      foodValue,
      foodValue
    ));

    // å°è¯•å‡çº§
    this.tryLevelUp();
  }

  // å°è¯•å‡çº§ï¼ˆç§æœ‰ä¸šåŠ¡é€»è¾‘ï¼‰
  tryLevelUp() {
    let levelUpCount = 0;

    // å¾ªç¯å‡çº§ï¼ˆå¤„ç†ä¸€æ¬¡å–‚å…»å¤šæ¬¡å‡çº§çš„æƒ…å†µï¼‰
    while (this.experience.canLevelUp()) {
      const oldLevel = this.stats.level;

      // æ¶ˆè€—ç»éªŒ
      this.experience = this.experience.consumeForLevelUp();

      // æå‡å±æ€§
      this.stats = this.stats.levelUp();

      levelUpCount++;

      // è§¦å‘å‡çº§äº‹ä»¶
      this.addDomainEvent(new PetLeveledUpEvent(
        this.id,
        oldLevel,
        this.stats.level,
        {
          hp: this.stats.hp,
          attack: this.stats.attack
        }
      ));
    }

    return levelUpCount;
  }

  // æ·»åŠ é¢†åŸŸäº‹ä»¶
  addDomainEvent(event) {
    this.domainEvents.push(event);
  }

  // è·å–å¹¶æ¸…ç©ºé¢†åŸŸäº‹ä»¶
  pullDomainEvents() {
    const events = [...this.domainEvents];
    this.domainEvents = [];
    return events;
  }

  // è·å–å½“å‰ç­‰çº§
  getLevel() {
    return this.stats.level;
  }

  // è·å–å½“å‰ç»éªŒè¿›åº¦ï¼ˆç™¾åˆ†æ¯”ï¼‰
  getExpProgress() {
    const required = this.experience.getRequiredForNextLevel();
    return (this.experience.current / required * 100).toFixed(2);
  }
}
```

##### 5. ä»“å‚¨æ¥å£

```javascript
// ä»“å‚¨æ¥å£
class IPetRepository {
  async findById(petId) {
    throw new Error('Not implemented');
  }

  async save(pet) {
    throw new Error('Not implemented');
  }
}

// ä»“å‚¨å®ç°
class PetRepository extends IPetRepository {
  constructor(db) {
    super();
    this.db = db;
  }

  async findById(petId) {
    const data = await this.db.query(
      'SELECT * FROM pets WHERE id = ?',
      [petId]
    );

    if (!data) return null;

    // ä»æ•°æ®é‡å»ºé¢†åŸŸå¯¹è±¡
    return new Pet(
      data.id,
      data.name,
      data.quality,
      new Experience(data.exp, data.level, data.quality),
      new PetStats(data.hp, data.attack, data.level, data.quality)
    );
  }

  async save(pet) {
    // ä¿å­˜èšåˆæ ¹
    await this.db.query(
      `UPDATE pets SET
        level = ?,
        exp = ?,
        hp = ?,
        attack = ?
      WHERE id = ?`,
      [
        pet.stats.level,
        pet.experience.current,
        pet.stats.hp,
        pet.stats.attack,
        pet.id
      ]
    );

    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    const events = pet.pullDomainEvents();
    for (const event of events) {
      await this.publishEvent(event);
    }
  }

  async publishEvent(event) {
    // å‘å¸ƒäº‹ä»¶åˆ°äº‹ä»¶æ€»çº¿
    // ä¾‹å¦‚ï¼šå‘é€é€šçŸ¥ã€æ›´æ–°æ’è¡Œæ¦œç­‰
    console.log('Domain Event:', event);
  }
}
```

##### 6. åº”ç”¨æœåŠ¡ï¼ˆç®€æ´çš„ä¸šåŠ¡é€»è¾‘ç¼–æ’å±‚ï¼‰

```javascript
// åº”ç”¨æœåŠ¡ï¼šåªè´Ÿè´£ç¼–æ’ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
class PetApplicationService {
  constructor(petRepository) {
    this.petRepository = petRepository;
  }

  async feedPet(petId, foodValue) {
    // 1. åŠ è½½èšåˆæ ¹
    const pet = await this.petRepository.findById(petId);

    if (!pet) {
      throw new Error('å® ç‰©ä¸å­˜åœ¨');
    }

    // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆåœ¨é¢†åŸŸæ¨¡å‹ä¸­ï¼‰
    pet.feed(foodValue);

    // 3. æŒä¹…åŒ–
    await this.petRepository.save(pet);

    // 4. è¿”å›ç»“æœ
    return {
      level: pet.getLevel(),
      exp: pet.experience.current,
      expProgress: pet.getExpProgress(),
      hp: pet.stats.hp,
      attack: pet.stats.attack
    };
  }
}
```

##### 7. ä½¿ç”¨ç¤ºä¾‹

```javascript
// ä½¿ç”¨
const petService = new PetApplicationService(petRepository);

// å–‚å…»å® ç‰©
const result = await petService.feedPet('pet-123', 250);
console.log(`å® ç‰©å‡çº§åˆ°${result.level}çº§ï¼Œç»éªŒè¿›åº¦${result.expProgress}%`);

// ä¸šåŠ¡é€»è¾‘éƒ½åœ¨é¢†åŸŸæ¨¡å‹ä¸­ï¼Œåº”ç”¨æœåŠ¡éå¸¸ç®€æ´
```

#### æ›´è¿›ä¸€æ­¥

åœ¨å®é™…ä¸šåŠ¡ä¸­,æˆ‘ä»¬å¸¸å¸¸éœ€è¦åœ¨ä¿æŒæ ¸å¿ƒæµç¨‹ä¸å˜çš„æƒ…å†µä¸‹,å…è®¸ä¸åŒçš„ä¸šåŠ¡åœºæ™¯æœ‰å®šåˆ¶åŒ–çš„é€»è¾‘ã€‚è¿™æ—¶å¯ä»¥è¿›ä¸€æ­¥é€šè¿‡**æ‰©å±•ç‚¹æ¨¡å¼**æ¥å®ç°ã€‚

##### ä¸šåŠ¡åœºæ™¯æ‰©å±•

å‡è®¾æˆ‘ä»¬çš„å® ç‰©ç³»ç»Ÿéœ€è¦æ”¯æŒä¸åŒç±»å‹çš„å–‚å…»ç­–ç•¥ï¼š

- **æ™®é€šå® ç‰©**ï¼šç›´æ¥è·å¾—ç»éªŒ
- **VIPå® ç‰©**ï¼šè·å¾—ç»éªŒåŠ æˆ,å¹¶æœ‰é¢å¤–çš„å±æ€§æå‡
- **ä¼ è¯´å® ç‰©**ï¼šå–‚å…»æ—¶è§¦å‘ç‰¹æ®Šæ•ˆæœ,å¯èƒ½è·å¾—é¢å¤–å¥–åŠ±

##### å®Œæ•´ç±»å‹å®šä¹‰

é¦–å…ˆ,å®šä¹‰å®Œæ•´çš„ç±»å‹ç³»ç»Ÿï¼š

```typescript
// ============= åŸºç¡€ç±»å‹å®šä¹‰ =============

// å¥–åŠ±ç±»å‹
type RewardType = 'gold' | 'diamond' | 'special_item' | 'rare_event';

// å¥–åŠ±æ¥å£
interface Reward {
  type: RewardType;
  amount?: number;
  itemId?: string;
  eventId?: string;
  reason: string;
}

// è¿å‡»çŠ¶æ€
type ComboStatus = 'GOOD' | 'GREAT!' | 'AMAZING!';

// å® ç‰©ç­‰çº§è¯„çº§
type PetRank = 'Cçº§æ™®é€š' | 'Bçº§ç¨€æœ‰' | 'Açº§å²è¯—' | 'Sçº§ä¼ è¯´';

// VIPç­‰çº§
type VipLevel = 1 | 2 | 3;

// ============= æ‰©å±•å­—æ®µç±»å‹å®šä¹‰ =============

// VIPç‰¹æƒä¿¡æ¯
interface VipPrivilege {
  savedFeeds: number;
  message: string;
}

// è¿å‡»ä¿¡æ¯
interface ComboInfo {
  comboCount: number;
  comboBonus: number;
  nextComboAt: number;
  comboStatus: ComboStatus;
}

// æ¯æ—¥é™åˆ¶ä¿¡æ¯
interface DailyLimit {
  remaining: number;
  total: number;
  resetAt: number;
}

// ç‰¹æ®Šäº‹ä»¶ä¿¡æ¯
interface SpecialEvents {
  triggered: boolean;
  events: Reward[];
  message: string;
}

// ä¼ è¯´ç»Ÿè®¡ä¿¡æ¯
interface LegendaryStats {
  totalBonus: number;
  legendaryBonus: number;
  efficiency: string;
  rank: PetRank;
}

// ============= è¿”å›ç»“æœç±»å‹å®šä¹‰ =============

// åŸºç¡€è¿”å›ç»“æœæ¥å£
interface BaseFeedingResponse {
  level: number;
  exp: number;
  expProgress: string;
  hp: number;
  attack: number;
  levelUpCount: number;
  rewards: Reward[];
}

// æ™®é€šç­–ç•¥æ‰©å±•å­—æ®µ
interface NormalFeedingExtensions {
  feedCount: number;
  totalExpGained: number;
}

// VIPç­–ç•¥æ‰©å±•å­—æ®µ
interface VipFeedingExtensions {
  vipLevel: VipLevel;
  expBonus: number;
  bonusRate: string;
  vipPrivilege: VipPrivilege;
}

// ä¼ è¯´ç­–ç•¥æ‰©å±•å­—æ®µ
interface LegendaryFeedingExtensions {
  comboInfo: ComboInfo;
  dailyLimit: DailyLimit;
  specialEvents?: SpecialEvents;
  legendaryStats: LegendaryStats;
}

// ç»„åˆè¿”å›ç±»å‹
type NormalFeedingResponse = BaseFeedingResponse & NormalFeedingExtensions;
type VipFeedingResponse = BaseFeedingResponse & VipFeedingExtensions;
type LegendaryFeedingResponse = BaseFeedingResponse & LegendaryFeedingExtensions;

// ============= ä¸Šä¸‹æ–‡ç±»å‹å®šä¹‰ =============

interface FeedingContext {
  foodValue: number;
  expBonus: number;
  actualFoodValue: number;
}

// ============= äº‹ä»¶ç®¡ç†å™¨æ¥å£ =============

interface EventManager {
  publish(event: any): Promise<void>;
}

// ============= Pet ç›¸å…³æ¥å£ï¼ˆç®€åŒ–ç‰ˆï¼‰ =============

interface Pet {
  id: string;
  name: string;
  quality: string;
  experience: any;
  stats: any;
  feed(foodValue: number): void;
  getLevel(): number;
  getExpProgress(): string;
}

interface IPetRepository {
  findById(petId: string): Promise<Pet | null>;
  save(pet: Pet): Promise<void>;
}
```

##### è¿”å›ç»“æœå°è£…ç±»

```typescript
// è¿”å›ç»“æœåŸºç±»
class FeedingResult<T extends Record<string, any> = {}> {
  level: number;
  exp: number;
  expProgress: string;
  hp: number;
  attack: number;
  levelUpCount: number;
  rewards: Reward[];
  private extensions: T = {} as T;

  constructor(pet: Pet, levelUpCount: number, rewards: Reward[]) {
    this.level = pet.getLevel();
    this.exp = pet.experience.current;
    this.expProgress = pet.getExpProgress();
    this.hp = pet.stats.hp;
    this.attack = pet.stats.attack;
    this.levelUpCount = levelUpCount;
    this.rewards = rewards;
  }

  // æ·»åŠ æ‰©å±•æ•°æ®ï¼ˆç±»å‹å®‰å…¨ï¼‰
  addExtension<K extends keyof T>(key: K, value: T[K]): void {
    this.extensions[key] = value;
  }

  // è½¬æ¢ä¸ºå“åº”å¯¹è±¡
  toResponse(): BaseFeedingResponse & T {
    return {
      level: this.level,
      exp: this.exp,
      expProgress: this.expProgress,
      hp: this.hp,
      attack: this.attack,
      levelUpCount: this.levelUpCount,
      rewards: this.rewards,
      ...this.extensions
    } as BaseFeedingResponse & T;
  }
}
```

##### ç­–ç•¥æ¥å£å®šä¹‰

```typescript
// å–‚å…»ç­–ç•¥æ‰©å±•ç‚¹æ¥å£
interface IFeedingStrategy<TResponse extends BaseFeedingResponse = BaseFeedingResponse> {
  // æ‰©å±•ç‚¹1ï¼šè®¡ç®—ç»éªŒåŠ æˆ
  calculateExpBonus(pet: Pet, foodValue: number): number;

  // æ‰©å±•ç‚¹2ï¼šå–‚å…»å‰çš„æ ¡éªŒé€»è¾‘
  beforeFeed(pet: Pet, foodValue: number): Promise<boolean>;

  // æ‰©å±•ç‚¹3ï¼šå–‚å…»åçš„é¢å¤–å¤„ç†
  afterFeed(pet: Pet, levelUpCount: number): Promise<void>;

  // æ‰©å±•ç‚¹4ï¼šç”Ÿæˆå¥–åŠ±
  generateRewards(pet: Pet, levelUpCount: number): Reward[];

  // æ‰©å±•ç‚¹5ï¼šæ‰©å±•è¿”å›ç»“æœ
  extendResult(result: FeedingResult<any>, pet: Pet, context: FeedingContext): void;
}

// æŠ½è±¡åŸºç¡€ç­–ç•¥ç±»ï¼ˆæä¾›é»˜è®¤å®ç°ï¼‰
abstract class BaseFeedingStrategy<TResponse extends BaseFeedingResponse = BaseFeedingResponse>
  implements IFeedingStrategy<TResponse> {

  abstract calculateExpBonus(pet: Pet, foodValue: number): number;

  async beforeFeed(pet: Pet, foodValue: number): Promise<boolean> {
    // é»˜è®¤å®ç°ï¼šå…è®¸å–‚å…»
    return true;
  }

  async afterFeed(pet: Pet, levelUpCount: number): Promise<void> {
    // é»˜è®¤å®ç°ï¼šä¸åšä»»ä½•å¤„ç†
  }

  abstract generateRewards(pet: Pet, levelUpCount: number): Reward[];

  extendResult(result: FeedingResult<any>, pet: Pet, context: FeedingContext): void {
    // é»˜è®¤å®ç°ï¼šä¸åšä»»ä½•æ‰©å±•
  }
}
```

##### åº”ç”¨æœåŠ¡ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰

```typescript
// åŸºç¡€å–‚å…»åº”ç”¨æœåŠ¡ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰
class BasePetFeedingService<TResponse extends BaseFeedingResponse = BaseFeedingResponse> {
  constructor(
    private readonly petRepository: IPetRepository,
    private readonly feedingStrategy: IFeedingStrategy<TResponse>
  ) {}

  // æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰å–‚å…»æµç¨‹éª¨æ¶
  async feedPet(petId: string, foodValue: number): Promise<TResponse> {
    // 1. åŠ è½½èšåˆæ ¹
    const pet = await this.petRepository.findById(petId);
    if (!pet) {
      throw new Error('å® ç‰©ä¸å­˜åœ¨');
    }

    // 2. æ‰©å±•ç‚¹ï¼šå–‚å…»å‰æ ¡éªŒ
    const canFeed = await this.feedingStrategy.beforeFeed(pet, foodValue);
    if (!canFeed) {
      throw new Error('å½“å‰æ— æ³•å–‚å…»å® ç‰©');
    }

    // 3. æ‰©å±•ç‚¹ï¼šè®¡ç®—ç»éªŒåŠ æˆ
    const expBonus = this.feedingStrategy.calculateExpBonus(pet, foodValue);
    const actualFoodValue = foodValue + expBonus;

    // 4. æ‰§è¡Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘
    const oldLevel = pet.getLevel();
    pet.feed(actualFoodValue);
    const newLevel = pet.getLevel();
    const levelUpCount = newLevel - oldLevel;

    // 5. æ‰©å±•ç‚¹ï¼šç”Ÿæˆå¥–åŠ±
    const rewards = this.feedingStrategy.generateRewards(pet, levelUpCount);

    // 6. æŒä¹…åŒ–
    await this.petRepository.save(pet);

    // 7. æ‰©å±•ç‚¹ï¼šå–‚å…»åå¤„ç†
    await this.feedingStrategy.afterFeed(pet, levelUpCount);

    // 8. æ„å»ºåŸºç¡€è¿”å›ç»“æœ
    const result = new FeedingResult(pet, levelUpCount, rewards);

    // 9. æ‰©å±•ç‚¹ï¼šæ‰©å±•è¿”å›ç»“æœ
    const context: FeedingContext = { foodValue, expBonus, actualFoodValue };
    this.feedingStrategy.extendResult(result, pet, context);

    // 10. è¿”å›ç»“æœ
    return result.toResponse() as TResponse;
  }
}
```

##### ä¸šåŠ¡å®ç°æ‰©å±•ç‚¹

###### 1. æ™®é€šå® ç‰©å–‚å…»ç­–ç•¥

```typescript
// æ™®é€šå® ç‰©å–‚å…»ç­–ç•¥
class NormalFeedingStrategy extends BaseFeedingStrategy<NormalFeedingResponse> {
  calculateExpBonus(pet: Pet, foodValue: number): number {
    // æ™®é€šå® ç‰©æ²¡æœ‰åŠ æˆ
    return 0;
  }

  generateRewards(pet: Pet, levelUpCount: number): Reward[] {
    // æ¯å‡1çº§ç»™100é‡‘å¸
    if (levelUpCount === 0) return [];

    return [{
      type: 'gold' as const,
      amount: 100 * levelUpCount,
      reason: 'å® ç‰©å‡çº§å¥–åŠ±'
    }];
  }

  extendResult(
    result: FeedingResult<NormalFeedingExtensions>,
    pet: Pet,
    context: FeedingContext
  ): void {
    // æ™®é€šç­–ç•¥æ·»åŠ åŸºç¡€ç»Ÿè®¡ä¿¡æ¯
    result.addExtension('feedCount', 1);
    result.addExtension('totalExpGained', context.actualFoodValue);
  }
}
```

###### 2. VIPå® ç‰©å–‚å…»ç­–ç•¥

```typescript
// VIPå® ç‰©å–‚å…»ç­–ç•¥
class VipFeedingStrategy extends BaseFeedingStrategy<VipFeedingResponse> {
  constructor(private readonly vipLevel: VipLevel) {
    super();
  }

  calculateExpBonus(pet: Pet, foodValue: number): number {
    // VIPç©å®¶è·å¾—ç»éªŒåŠ æˆ
    const bonusRates: Record<VipLevel, number> = {
      1: 0.1,  // VIP1: 10%åŠ æˆ
      2: 0.2,  // VIP2: 20%åŠ æˆ
      3: 0.3   // VIP3: 30%åŠ æˆ
    };

    return Math.floor(foodValue * bonusRates[this.vipLevel]);
  }

  generateRewards(pet: Pet, levelUpCount: number): Reward[] {
    if (levelUpCount === 0) return [];

    const rewards: Reward[] = [];

    // åŸºç¡€é‡‘å¸å¥–åŠ±
    rewards.push({
      type: 'gold' as const,
      amount: 100 * levelUpCount,
      reason: 'å® ç‰©å‡çº§å¥–åŠ±'
    });

    // VIPé¢å¤–å¥–åŠ±
    rewards.push({
      type: 'diamond' as const,
      amount: 10 * levelUpCount * this.vipLevel,
      reason: 'VIPä¸“å±å‡çº§å¥–åŠ±'
    });

    return rewards;
  }

  async afterFeed(pet: Pet, levelUpCount: number): Promise<void> {
    if (levelUpCount > 0) {
      // VIPç©å®¶å‡çº§åå‘é€ç‰¹æ®Šé€šçŸ¥
      console.log(`ğŸ‰ æ­å–œVIP${this.vipLevel}ç©å®¶ï¼Œå® ç‰©${pet.name}å‡çº§åˆ°${pet.getLevel()}çº§ï¼`);
    }
  }

  extendResult(
    result: FeedingResult<VipFeedingExtensions>,
    pet: Pet,
    context: FeedingContext
  ): void {
    // VIPç­–ç•¥æ·»åŠ VIPç‰¹æƒä¿¡æ¯
    result.addExtension('vipLevel', this.vipLevel);
    result.addExtension('expBonus', context.expBonus);
    result.addExtension('bonusRate', `${(context.expBonus / context.foodValue * 100).toFixed(1)}%`);

    // è®¡ç®—VIPç‰¹æƒèŠ‚çœçš„æ—¶é—´ï¼ˆå‡è®¾ï¼‰
    const savedFeeds = Math.floor(context.expBonus / context.foodValue);
    result.addExtension('vipPrivilege', {
      savedFeeds,
      message: `VIP${this.vipLevel}ç‰¹æƒä¸ºæ‚¨èŠ‚çœäº†${savedFeeds}æ¬¡å–‚å…»`
    });
  }
}
```

###### 3. ä¼ è¯´å® ç‰©å–‚å…»ç­–ç•¥

```typescript
// ä¼ è¯´å® ç‰©å–‚å…»ç­–ç•¥
class LegendaryFeedingStrategy extends BaseFeedingStrategy<LegendaryFeedingResponse> {
  private comboCount: number = 0; // è¿å‡»æ¬¡æ•°
  private lastFeedTime: number | null = null;

  constructor(private readonly eventManager: EventManager) {
    super();
  }

  async beforeFeed(pet: Pet, foodValue: number): Promise<boolean> {
    // ä¼ è¯´å® ç‰©æ¯å¤©åªèƒ½å–‚å…»3æ¬¡
    const feedCountToday = await this.getFeedCountToday(pet.id);
    if (feedCountToday >= 3) {
      return false;
    }

    // è®¡ç®—è¿å‡»
    const now = Date.now();
    if (this.lastFeedTime && now - this.lastFeedTime < 5000) {
      this.comboCount++;
    } else {
      this.comboCount = 1;
    }
    this.lastFeedTime = now;

    return true;
  }

  calculateExpBonus(pet: Pet, foodValue: number): number {
    // è¿å‡»åŠ æˆï¼šæ¯è¿å‡»ä¸€æ¬¡å¢åŠ 20%ç»éªŒ
    const comboBonus = Math.floor(foodValue * 0.2 * (this.comboCount - 1));

    // ä¼ è¯´å® ç‰©åŸºç¡€åŠ æˆ50%
    const legendaryBonus = Math.floor(foodValue * 0.5);

    return comboBonus + legendaryBonus;
  }

  generateRewards(pet: Pet, levelUpCount: number): Reward[] {
    if (levelUpCount === 0) return [];

    const rewards: Reward[] = [];

    // åŸºç¡€å¥–åŠ±
    rewards.push({
      type: 'gold' as const,
      amount: 100 * levelUpCount,
      reason: 'å® ç‰©å‡çº§å¥–åŠ±'
    });

    // ä¼ è¯´çº§å¤§é¢é’»çŸ³å¥–åŠ±
    rewards.push({
      type: 'diamond' as const,
      amount: 50 * levelUpCount,
      reason: 'ä¼ è¯´å® ç‰©å‡çº§å¥–åŠ±'
    });

    // è¿å‡»å¥–åŠ±
    if (this.comboCount >= 3) {
      rewards.push({
        type: 'special_item' as const,
        itemId: 'legendary_food',
        amount: 1,
        reason: `${this.comboCount}è¿å‡»ç‰¹æ®Šå¥–åŠ±`
      });
    }

    // è§¦å‘ç¨€æœ‰äº‹ä»¶ï¼ˆæ¦‚ç‡ï¼‰
    if (Math.random() < 0.1) {
      rewards.push({
        type: 'rare_event' as const,
        eventId: 'treasure_hunt',
        reason: 'è§¦å‘ä¼ è¯´äº‹ä»¶ï¼šå¯»å®ä¹‹æ—…'
      });
    }

    return rewards;
  }

  async afterFeed(pet: Pet, levelUpCount: number): Promise<void> {
    // å‘å¸ƒä¼ è¯´å® ç‰©å–‚å…»äº‹ä»¶ï¼ˆä¾›å…¶ä»–ç³»ç»Ÿç›‘å¬ï¼‰
    await this.eventManager.publish({
      type: 'LegendaryPetFed',
      petId: pet.id,
      level: pet.getLevel(),
      comboCount: this.comboCount,
      timestamp: Date.now()
    });

    if (levelUpCount > 0) {
      console.log(`âš¡ ä¼ è¯´å® ç‰©${pet.name}å‡çº§ï¼å½“å‰${this.comboCount}è¿å‡»ï¼`);
    }
  }

  private async getFeedCountToday(petId: string): Promise<number> {
    // ä»ç¼“å­˜æˆ–æ•°æ®åº“è·å–ä»Šæ—¥å–‚å…»æ¬¡æ•°
    // è¿™é‡Œç®€åŒ–å¤„ç†
    return 0;
  }

  extendResult(
    result: FeedingResult<LegendaryFeedingExtensions>,
    pet: Pet,
    context: FeedingContext
  ): void {
    // ä¼ è¯´å® ç‰©æ·»åŠ ä¸°å¯Œçš„æ‰©å±•ä¿¡æ¯

    // 1. è¿å‡»ç³»ç»Ÿä¿¡æ¯
    const comboStatus: ComboStatus =
      this.comboCount >= 3 ? 'AMAZING!' :
      this.comboCount >= 2 ? 'GREAT!' : 'GOOD';

    result.addExtension('comboInfo', {
      comboCount: this.comboCount,
      comboBonus: Math.floor(context.foodValue * 0.2 * (this.comboCount - 1)),
      nextComboAt: this.lastFeedTime! + 5000,
      comboStatus
    });

    // 2. ä»Šæ—¥å‰©ä½™å–‚å…»æ¬¡æ•°
    result.addExtension('dailyLimit', {
      remaining: 2, // ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æŸ¥è¯¢
      total: 3,
      resetAt: new Date().setHours(24, 0, 0, 0)
    });

    // 3. ç‰¹æ®Šäº‹ä»¶è§¦å‘è®°å½•
    const specialRewards = result.rewards.filter(r =>
      r.type === 'rare_event' || r.type === 'special_item'
    );
    if (specialRewards.length > 0) {
      result.addExtension('specialEvents', {
        triggered: true,
        events: specialRewards,
        message: 'âš¡ æ­å–œè§¦å‘ä¼ è¯´äº‹ä»¶ï¼'
      });
    }

    // 4. ä¼ è¯´å® ç‰©ä¸“å±ç»Ÿè®¡
    result.addExtension('legendaryStats', {
      totalBonus: context.expBonus,
      legendaryBonus: Math.floor(context.foodValue * 0.5),
      efficiency: `${((context.actualFoodValue / context.foodValue - 1) * 100).toFixed(0)}%`,
      rank: this.calculateRank(pet.getLevel())
    });
  }

  private calculateRank(level: number): PetRank {
    if (level >= 50) return 'Sçº§ä¼ è¯´';
    if (level >= 30) return 'Açº§å²è¯—';
    if (level >= 20) return 'Bçº§ç¨€æœ‰';
    return 'Cçº§æ™®é€š';
  }
}
```

##### ä½¿ç”¨ç¤ºä¾‹

```typescript
// æ ¹æ®ä¸åŒä¸šåŠ¡åœºæ™¯é€‰æ‹©ç­–ç•¥

// 1. æ™®é€šç©å®¶å–‚å…»ï¼ˆè¿”å›ç±»å‹ä¸º NormalFeedingResponseï¼‰
const normalService = new BasePetFeedingService<NormalFeedingResponse>(
  petRepository,
  new NormalFeedingStrategy()
);
const result1: NormalFeedingResponse = await normalService.feedPet('pet-123', 100);
console.log('æ™®é€šç©å®¶ç»“æœ:', result1);
/* è¾“å‡º:
{
  level: 5,
  exp: 50,
  expProgress: '50.00%',
  hp: 150,
  attack: 75,
  levelUpCount: 1,
  rewards: [{ type: 'gold', amount: 100, reason: 'å® ç‰©å‡çº§å¥–åŠ±' }],
  feedCount: 1,
  totalExpGained: 100
}
*/

// 2. VIPç©å®¶å–‚å…»ï¼ˆè¿”å›ç±»å‹ä¸º VipFeedingResponseï¼‰
const vipService = new BasePetFeedingService<VipFeedingResponse>(
  petRepository,
  new VipFeedingStrategy(2) // VIPç­‰çº§2
);
const result2: VipFeedingResponse = await vipService.feedPet('pet-456', 100);
console.log('VIPç©å®¶ç»“æœ:', result2);
/* è¾“å‡º:
{
  level: 5,
  exp: 70,
  expProgress: '70.00%',
  hp: 150,
  attack: 75,
  levelUpCount: 1,
  rewards: [
    { type: 'gold', amount: 100, reason: 'å® ç‰©å‡çº§å¥–åŠ±' },
    { type: 'diamond', amount: 20, reason: 'VIPä¸“å±å‡çº§å¥–åŠ±' }
  ],
  vipLevel: 2,
  expBonus: 20,
  bonusRate: '20.0%',
  vipPrivilege: {
    savedFeeds: 0,
    message: 'VIP2ç‰¹æƒä¸ºæ‚¨èŠ‚çœäº†0æ¬¡å–‚å…»'
  }
}
*/

// 3. ä¼ è¯´å® ç‰©å–‚å…»ï¼ˆè¿å‡»3æ¬¡ï¼Œè¿”å›ç±»å‹ä¸º LegendaryFeedingResponseï¼‰
const legendaryService = new BasePetFeedingService<LegendaryFeedingResponse>(
  petRepository,
  new LegendaryFeedingStrategy(eventManager)
);
const result3: LegendaryFeedingResponse = await legendaryService.feedPet('pet-789', 100);
console.log('ä¼ è¯´å® ç‰©ç»“æœ:', result3);
/* è¾“å‡º:
{
  level: 6,
  exp: 100,
  expProgress: '83.33%',
  hp: 180,
  attack: 90,
  levelUpCount: 1,
  rewards: [
    { type: 'gold', amount: 100, reason: 'å® ç‰©å‡çº§å¥–åŠ±' },
    { type: 'diamond', amount: 50, reason: 'ä¼ è¯´å® ç‰©å‡çº§å¥–åŠ±' },
    { type: 'special_item', itemId: 'legendary_food', amount: 1, reason: '3è¿å‡»ç‰¹æ®Šå¥–åŠ±' }
  ],
  comboInfo: {
    comboCount: 3,
    comboBonus: 40,
    nextComboAt: 1696852345000,
    comboStatus: 'AMAZING!'
  },
  dailyLimit: {
    remaining: 2,
    total: 3,
    resetAt: 1696867200000
  },
  specialEvents: {
    triggered: true,
    events: [
      { type: 'special_item', itemId: 'legendary_food', amount: 1, reason: '3è¿å‡»ç‰¹æ®Šå¥–åŠ±' }
    ],
    message: 'âš¡ æ­å–œè§¦å‘ä¼ è¯´äº‹ä»¶ï¼'
  },
  legendaryStats: {
    totalBonus: 90,
    legendaryBonus: 50,
    efficiency: '90%',
    rank: 'Cçº§æ™®é€š'
  }
}
*/
```

##### æ‰©å±•ç‚¹æ¨¡å¼çš„ä¼˜åŠ¿

1. **å¼€é—­åŸåˆ™**ï¼š
   - æ ¸å¿ƒæµç¨‹ï¼ˆ`feedPet`æ–¹æ³•ï¼‰ä¿æŒç¨³å®š,æ— éœ€ä¿®æ”¹
   - æ–°å¢ä¸šåŠ¡ç±»å‹åªéœ€å®ç°æ–°çš„ç­–ç•¥ç±»

2. **èŒè´£æ¸…æ™°**ï¼š
   - `BasePetFeedingService`ï¼šè´Ÿè´£æµç¨‹ç¼–æ’
   - ç­–ç•¥ç±»ï¼šè´Ÿè´£å…·ä½“ä¸šåŠ¡é€»è¾‘
   - é¢†åŸŸæ¨¡å‹ï¼šè´Ÿè´£æ ¸å¿ƒä¸šåŠ¡è§„åˆ™
   - `FeedingResult`ï¼šè´Ÿè´£ç»“æ„åŒ–è¿”å›æ•°æ®

3. **è¿”å›ç»“æœå¯æ‰©å±•**ï¼š
   - å®šä¹‰äº†ç»Ÿä¸€çš„ `FeedingResult` æ¥å£
   - æ¯ä¸ªç­–ç•¥å¯ä»¥é€šè¿‡ `extendResult` æ·»åŠ è‡ªå·±çš„æ‰©å±•å­—æ®µ
   - å®¢æˆ·ç«¯è·å¾—å®Œæ•´ä¸”ç±»å‹å®‰å…¨çš„å“åº”æ•°æ®
   - é¿å…äº†è¿”å›ç»“æœçš„"ä¸Šå¸å¯¹è±¡"é—®é¢˜

4. **æ˜“äºæµ‹è¯•**ï¼š

   ```javascript
   // å¯ä»¥è½»æ¾mockç­–ç•¥è¿›è¡Œæµ‹è¯•
   test('å–‚å…»æµç¨‹åº”è¯¥è°ƒç”¨æ‰€æœ‰æ‰©å±•ç‚¹', async () => {
     const mockStrategy = {
       beforeFeed: jest.fn().mockResolvedValue(true),
       calculateExpBonus: jest.fn().mockReturnValue(50),
       generateRewards: jest.fn().mockReturnValue([]),
       afterFeed: jest.fn()
     };

     const service = new BasePetFeedingService(mockRepo, mockStrategy);
     await service.feedPet('pet-1', 100);

     expect(mockStrategy.beforeFeed).toHaveBeenCalled();
     expect(mockStrategy.calculateExpBonus).toHaveBeenCalled();
     expect(mockStrategy.generateRewards).toHaveBeenCalled();
     expect(mockStrategy.afterFeed).toHaveBeenCalled();
   });
   ```

4. **çµæ´»ç»„åˆ**ï¼š

   ```javascript
   // å¯ä»¥é€šè¿‡ç»„åˆæ¨¡å¼æ”¯æŒå¤šç§ç­–ç•¥å åŠ 
   class CompositeStrategy extends IFeedingStrategy {
     constructor(strategies) {
       super();
       this.strategies = strategies;
     }

     calculateExpBonus(pet, foodValue) {
       return this.strategies.reduce(
         (total, strategy) => total + strategy.calculateExpBonus(pet, foodValue),
         0
       );
     }

     async afterFeed(pet, levelUpCount) {
       for (const strategy of this.strategies) {
         await strategy.afterFeed(pet, levelUpCount);
       }
     }
   }

   // åŒæ—¶åº”ç”¨VIPå’ŒèŠ‚æ—¥åŒå€ç»éªŒ
   const compositeService = new BasePetFeedingService(
     petRepository,
     new CompositeStrategy([
       new VipFeedingStrategy(3),
       new HolidayBonusStrategy()
     ])
   );
   ```

5. **è¿è¡Œæ—¶åˆ‡æ¢**ï¼š

   ```javascript
   // å¯ä»¥æ ¹æ®è¿è¡Œæ—¶æ¡ä»¶åŠ¨æ€é€‰æ‹©ç­–ç•¥
   function createFeedingService(user, pet) {
     let strategy;

     if (pet.quality === 'legendary') {
       strategy = new LegendaryFeedingStrategy(eventManager);
     } else if (user.vipLevel > 0) {
       strategy = new VipFeedingStrategy(user.vipLevel);
     } else {
       strategy = new NormalFeedingStrategy();
     }

     return new BasePetFeedingService(petRepository, strategy);
   }
   ```

##### æ¶æ„ç¤ºæ„å›¾

```mermaid
classDiagram
    class BasePetFeedingService {
        -petRepository
        -feedingStrategy
        +feedPet(petId, foodValue)
    }

    class IFeedingStrategy {
        <<interface>>
        +calculateExpBonus(pet, foodValue)
        +beforeFeed(pet, foodValue)
        +afterFeed(pet, levelUpCount)
        +generateRewards(pet, levelUpCount)
    }

    class NormalFeedingStrategy {
        +calculateExpBonus()
        +generateRewards()
    }

    class VipFeedingStrategy {
        -vipLevel
        +calculateExpBonus()
        +generateRewards()
        +afterFeed()
    }

    class LegendaryFeedingStrategy {
        -eventManager
        -comboCount
        +beforeFeed()
        +calculateExpBonus()
        +generateRewards()
        +afterFeed()
    }

    BasePetFeedingService --> IFeedingStrategy : ä¾èµ–
    IFeedingStrategy <|.. NormalFeedingStrategy : å®ç°
    IFeedingStrategy <|.. VipFeedingStrategy : å®ç°
    IFeedingStrategy <|.. LegendaryFeedingStrategy : å®ç°
```

é€šè¿‡è¿™ç§æ‰©å±•ç‚¹è®¾è®¡,æˆ‘ä»¬å®ç°äº†ï¼š

- **ç»Ÿä¸€æµç¨‹**ï¼šæ‰€æœ‰å® ç‰©å–‚å…»éƒ½éµå¾ªç›¸åŒçš„æµç¨‹éª¨æ¶
- **å·®å¼‚åŒ–å®šåˆ¶**ï¼šä¸åŒä¸šåŠ¡åœºæ™¯å¯ä»¥å®šåˆ¶è‡ªå·±çš„é€»è¾‘
- **è§£è€¦æ‰©å±•**ï¼šæ–°å¢ä¸šåŠ¡ç±»å‹ä¸å½±å“ç°æœ‰ä»£ç 
- **ä¾¿äºç»´æŠ¤**ï¼šæ¯ä¸ªç­–ç•¥èŒè´£å•ä¸€,æ˜“äºç†è§£å’Œä¿®æ”¹

è¿™æ­£æ˜¯ DDD ä¸­"å°†å¯å˜çš„ä¸šåŠ¡é€»è¾‘ä¸ç¨³å®šçš„æµç¨‹åˆ†ç¦»"çš„æœ€ä½³å®è·µã€‚

##### é¡¹ç›®ç»“æ„

**ç›®å½•ç»“æ„**

base ä¸­åŒ…å«åŸºç¡€è®¾æ–½ï¼ˆinfrastructureï¼‰å’ŒåŠŸèƒ½ç»„ä»¶ï¼ˆcomponentï¼‰å’Œéª¨æ¶å®ç°ï¼ˆskeletonï¼‰

- åŸºç¡€è®¾æ–½ä¸»è¦æŒ‡çš„æ˜¯ä¸€äº›äºŒä¸‰æ–¹çš„ä¾èµ–çš„å°è£…ï¼Œé€šè¿‡å†…éƒ¨APIçš„å½¢å¼è¿›è¡Œæä¾›
- åŠŸèƒ½ç»„ä»¶å°±æ˜¯ä¸€äº›ç›¸å¯¹å®Œæ•´ï¼Œç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—
- éª¨æ¶å®ç°ä¸€èˆ¬æ˜¯ä¸€äº›åŠŸèƒ½æ¥ç»´åº¦çš„é€šç”¨éª¨æ¶é€»è¾‘å®ç°ï¼ŒåŒ…å«æ¥å£è¯·æ±‚æ¥çš„å‚æ•°æ ¡éªŒã€æ ¸å¿ƒå¤„ç†ã€ç»“æ„å°è£…è¿”å›ç­‰

sdk æ˜¯æ¥å£å®šä¹‰å’Œå¥‘çº¦å±‚ï¼Œbase ä¸­é’ˆå¯¹SDK ä¸­å®šä¹‰çš„æ¥å£è¿›è¡Œå®ç°ï¼Œsdk ä¸­ä¸»è¦åŒ…å«ç³»ç»Ÿçš„æ‰€æœ‰æ¥å£ã€ç­–ç•¥æ‰©å±•ç‚¹ã€æ•°æ®æ¨¡å‹ã€å¸¸é‡å’Œå·¥å…·ç±»

module åˆ™æ˜¯å…·ä½“çš„æ¸¸æˆä¸šåŠ¡å®ç°ï¼Œä¼šå¼•ç”¨SDKï¼Œä½†æ˜¯ä¸ç›´æ¥å¼•ç”¨baseï¼Œå®Œæˆå…·ä½“çš„ç­–ç•¥æ‰©å±•ç‚¹çš„é‡å†™ï¼Œä»è€Œå®ç°å®šåˆ¶åŒ–çš„ä¸šåŠ¡åŠŸèƒ½

```txt
.
â”œâ”€â”€ base
â”‚   â”œâ”€â”€ component
â”‚   â”œâ”€â”€ infrastructure
â”‚   â””â”€â”€ skeleton
â”œâ”€â”€ sdk
â””â”€â”€ module
    â””â”€â”€ gameBusiness
```

**ä¾èµ–å…³ç³»å›¾**

```mermaid
flowchart TB
 subgraph subGraph0["ä¸šåŠ¡æ¨¡å—å±‚ (module)"]
        PM["promotion-module"]
        P618["promotion618"]
        P1111["promotion1111"]
  end
 subgraph subGraph1["SDKå±‚ (sdk)"]
        SDK["sdk"]
        SDK_COMMON["sdk/common"]
        SDK_COMPONENT["sdk/component"]
        SDK_INFRA["sdk/infrastructure"]
        SDK_SKELETON["sdk/skeleton"]
  end
 subgraph subGraph2["åŸºç¡€å®ç°å±‚ (base)"]
        BASE["base"]
        BASE_INFRA["infrastructure"]
        BASE_COMPONENT["component"]
        BASE_SKELETON["skeleton"]
        BASE_DRAW["draw"]
        BASE_PET["pet"]
  end
    PM --> P618 & P1111
    SDK --> SDK_COMMON & SDK_COMPONENT & SDK_INFRA & SDK_SKELETON
    BASE --> BASE_INFRA & BASE_COMPONENT & BASE_SKELETON
    BASE_COMPONENT --> BASE_DRAW
    BASE_SKELETON --> BASE_PET
    PM -. ä¾èµ– .-> SDK
    P618 -. ä¾èµ– .-> SDK
    P1111 -. ä¾èµ– .-> SDK
    BASE_INFRA -. ä¾èµ– .-> SDK
    BASE_COMPONENT -. ä¾èµ– .-> SDK & BASE_INFRA
    BASE_SKELETON -. ä¾èµ– .-> SDK & BASE_INFRA


```

#### DDDæ–¹å¼çš„ä¼˜åŠ¿

é€šè¿‡ä¸Šé¢çš„å¯¹æ¯”å¯ä»¥çœ‹åˆ°ï¼š

1. **ä¸šåŠ¡é€»è¾‘å†…èš**ï¼š
   - ç»éªŒè®¡ç®—ã€å‡çº§åˆ¤æ–­ã€å±æ€§æå‡éƒ½å°è£…åœ¨å¯¹åº”çš„é¢†åŸŸå¯¹è±¡ä¸­
   - Serviceå±‚å˜å¾—éå¸¸è–„ï¼Œåªè´Ÿè´£ç¼–æ’

2. **æ˜“äºæµ‹è¯•**ï¼š

   ```javascript
   // å•å…ƒæµ‹è¯•ä¸éœ€è¦æ•°æ®åº“
   test('å® ç‰©å–‚å…»ååº”è¯¥è·å¾—ç»éªŒ', () => {
     const pet = new Pet(
       '1',
       'Pikachu',
       'rare',
       new Experience(0, 1, 'rare'),
       new PetStats(100, 50, 1, 'rare')
     );

     pet.feed(100);

     expect(pet.experience.current).toBe(100);
   });

   test('å²è¯—å® ç‰©å‡çº§æ‰€éœ€ç»éªŒæ›´å¤š', () => {
     const exp1 = new Experience(0, 1, 'common');
     const exp2 = new Experience(0, 1, 'epic');

     expect(exp2.getRequiredForNextLevel())
       .toBeGreaterThan(exp1.getRequiredForNextLevel());
   });
   ```

3. **ä¸šåŠ¡è§„åˆ™æ¸…æ™°å¯è§**ï¼š
   - ä»£ç ç›´æ¥è¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µï¼š`pet.feed()`, `experience.canLevelUp()`
   - æ–°äººå¯ä»¥é€šè¿‡é˜…è¯»é¢†åŸŸæ¨¡å‹å¿«é€Ÿç†è§£ä¸šåŠ¡

4. **æ˜“äºæ‰©å±•**ï¼š
   - æ·»åŠ æ–°å“è´¨çš„å® ç‰©ï¼Ÿåªéœ€ä¿®æ”¹å€¼å¯¹è±¡ä¸­çš„é…ç½®
   - ä¿®æ”¹å‡çº§å…¬å¼ï¼Ÿåªåœ¨Experienceä¸­ä¿®æ”¹
   - æ·»åŠ æ–°çš„å® ç‰©è¡Œä¸ºï¼Ÿåœ¨Petå®ä½“ä¸­æ·»åŠ æ–¹æ³•

5. **äº‹ä»¶é©±åŠ¨**ï¼š
   - é€šè¿‡é¢†åŸŸäº‹ä»¶è§£è€¦å‰¯ä½œç”¨ï¼ˆé€šçŸ¥ã€æ—¥å¿—ã€ç»Ÿè®¡ç­‰ï¼‰
   - ä¾¿äºå®ç°å¤æ‚çš„ä¸šåŠ¡æµç¨‹

6. **çŠ¶æ€ä¸€è‡´æ€§**ï¼š
   - èšåˆæ ¹ä¿è¯å® ç‰©çŠ¶æ€çš„ä¸€è‡´æ€§
   - ä¸ä¼šå‡ºç°"ç»éªŒå·²æ‰£é™¤ä½†ç­‰çº§æœªæå‡"çš„æƒ…å†µ

## NodeJSä¸Šç°æœ‰çš„å®ç°

[white-label](https://github.com/stemmlerjs/white-label)æ˜¯åŸºäºæºç çº§åˆ«çš„ `Domain-Driven Design Demo`ï¼Œæœ‰éå¸¸é«˜çš„å‚è€ƒæ€§

[type-ddd](https://github.com/4lessandrodev/type-ddd) è¿™ä¸ªæ˜¯`NodeJS`ä¸­é’ˆå¯¹æ˜¯ `Domain-Driven Design` çš„ä¸€ä¸ªå°è£…ï¼Œä¸»è¦æ˜¯æä¾›`utils`ã€ `Entity`ã€`Value Objects`ã€`Factories`ã€`Aggregates`ã€`Repository`ã€`Domain events`ç­‰æ¥å»ºç«‹å¤æ‚çš„åº”ç”¨ï¼Œå¯ä»¥çœ‹ä¸‹é¡¹ç›®çš„ `README` æœ‰æœ€åŸºæœ¬çš„ç”¨æ³•ç¤ºä¾‹

é’ˆå¯¹è¿™ä¸¤ä¸ªé¡¹ç›®ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ `white-label`ï¼Œä¹‹åå®è·µè¿‡ç¨‹ä¸­åˆ™å¯ä»¥ä½¿ç”¨ `type-ddd` è¿›è¡Œå…·ä½“çš„ç¼–ç å®ç°

## å‚è€ƒèµ„æ–™

- DDDä¸­ç±»å‹æ¥å£ï¼š<https://github.com/4lessandrodev/type-ddd>
- DDDæ•™ç¨‹ï¼š<https://github.com/stemmlerjs/ddd-forum>
- NodeJS ä¸­çš„ç¤ºä¾‹ï¼š <https://github.com/stemmlerjs/white-label>
- Rich-Domain:<https://github.com/4lessandrodev/rich-domain>
