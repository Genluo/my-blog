<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>é¢†åŸŸé©±åŠ¨è®¾è®¡ | Genluo</title><meta name=keywords content="æœåŠ¡ç«¯"><meta name=description content="æœåŠ¡ç«¯ä¸­çš„é¢†åŸŸé©±åŠ¨è®¾è®¡çš„åº”ç”¨åŠå…¶è§£æ"><meta name=author content><link rel=canonical href=https://genluo.github.io/my-blog/posts/ddd/><link crossorigin=anonymous href=/my-blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://genluo.github.io/my-blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://genluo.github.io/my-blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://genluo.github.io/my-blog/favicon-32x32.png><link rel=apple-touch-icon href=https://genluo.github.io/my-blog/apple-touch-icon.png><link rel=mask-icon href=https://genluo.github.io/my-blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://genluo.github.io/my-blog/posts/ddd/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){mermaid.init({theme:"dark"},".language-mermaid")})</script><style>.language-mermaid{display:flex;justify-content:center}.post-content h4{font-size:20px!important}.post-content h5{font-size:18px!important}.post-content h6{font-size:16px!important}.language-mermaid code{display:flex;justify-content:center}</style><meta property="og:url" content="https://genluo.github.io/my-blog/posts/ddd/"><meta property="og:site_name" content="Genluo"><meta property="og:title" content="é¢†åŸŸé©±åŠ¨è®¾è®¡"><meta property="og:description" content="æœåŠ¡ç«¯ä¸­çš„é¢†åŸŸé©±åŠ¨è®¾è®¡çš„åº”ç”¨åŠå…¶è§£æ"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-01T10:16:15+08:00"><meta property="article:modified_time" content="2025-09-01T10:16:15+08:00"><meta property="article:tag" content="æœåŠ¡ç«¯"><meta name=twitter:card content="summary"><meta name=twitter:title content="é¢†åŸŸé©±åŠ¨è®¾è®¡"><meta name=twitter:description content="æœåŠ¡ç«¯ä¸­çš„é¢†åŸŸé©±åŠ¨è®¾è®¡çš„åº”ç”¨åŠå…¶è§£æ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://genluo.github.io/my-blog/posts/"},{"@type":"ListItem","position":2,"name":"é¢†åŸŸé©±åŠ¨è®¾è®¡","item":"https://genluo.github.io/my-blog/posts/ddd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"é¢†åŸŸé©±åŠ¨è®¾è®¡","name":"é¢†åŸŸé©±åŠ¨è®¾è®¡","description":"æœåŠ¡ç«¯ä¸­çš„é¢†åŸŸé©±åŠ¨è®¾è®¡çš„åº”ç”¨åŠå…¶è§£æ","keywords":["æœåŠ¡ç«¯"],"articleBody":"å¥‘æœº æœ€è¿‘å› ä¸ºä¸€äº›å¥‘æœºçœ‹äº†ä¸‹äº’åŠ¨å°æ¸¸æˆçš„æœåŠ¡ç«¯ï¼Œæ·±å…¥äº†è§£äº†ä¸‹ç°åœ¨äº’åŠ¨æ¸¸æˆæœåŠ¡ç«¯çš„æ¶æ„ï¼ŒåŒæ—¶ä¹Ÿå°è¯•åœ¨è¿™ä¸ªæ¶æ„çš„åŸºç¡€ä¸Šä½¿ç”¨ AI è¿›è¡Œä¸€äº›æ¸¸æˆä¸šåŠ¡åŠŸèƒ½å¼€å‘ï¼Œå…¶ä¸­å°è±¡æœ€æ·±çš„æœåŠ¡ç«¯çš„ä¸€ä¸ªç§°ä¹‹ä¸ºåŸºåº§çš„æ¶æ„è®¾è®¡ï¼Œè¿™ä¸ªåŸºåº§æ¶æ„æ·±åº¦ä½¿ç”¨ DDD é¢†åŸŸè®¾è®¡æ€æƒ³è¿›è¡ŒæŠ½è±¡å®ç°ï¼Œåœ¨æ¸¸æˆä¸šåŠ¡éå¸¸çµæ´»ï¼Œå¤ç”¨æ€§éå¸¸é«˜ï¼Œæ‰€ä»¥æƒ³çœ‹ä¸‹åœ¨NodeJS ä¸­é’ˆå¯¹ DDDé¢†åŸŸé©±åŠ¨è®¾è®¡æ˜¯å¦æœ‰ä¸€å®šçš„å®è·µã€‚ä¸‹é¢ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ä¸ºä»€ä¹ˆæ˜¯DDDï¼Ÿå¦ä¸€ä¸ª NodeJSä¸­ä¸€äº›å®è·µ\nDDD ä»€ä¹ˆæ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆdomain driving designï¼‰ é¢†åŸŸé©±åŠ¨è®¾è®¡æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ–¹æ³•ï¼Œç”¨äºè¡¨ç¤ºå’Œç»„ç»‡ç‰¹å®šé¢†åŸŸä¸­çš„çŸ¥è¯†å’Œä¸šåŠ¡é€»è¾‘ã€‚å®ƒä¸»è¦é€šè¿‡åˆ›å»ºæŠ½è±¡çš„æ¨¡å‹å¯¹è±¡æ¥æ¨¡æ‹Ÿç°å®ä¸–ç•Œçš„å®ä½“åŠå…¶å…³ç³»ï¼Œå¸®åŠ©å¼€å‘äººå‘˜ç†è§£å’Œå®ç°å¤æ‚ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘ã€‚åœ¨é¢†åŸŸé©±åŠ¨è®¾è®¡ä¸­ï¼Œé€šå¸¸ä¼šåŒ…å«ä»¥ä¸‹å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š\nå®ä½“ï¼ˆEntityï¼‰ï¼šå…·æœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œé€šå¸¸è¡¨ç¤ºä¸šåŠ¡ä¸­çš„ä¸€ä¸ªç‹¬ç«‹çš„æ¦‚å¿µæˆ–å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªè®¢å•ç³»ç»Ÿä¸­ï¼Œè®¢å•å’Œå®¢æˆ·å¯ä»¥è¢«è§†ä¸ºå®ä½“ã€‚\nå€¼å¯¹è±¡ï¼ˆValue Objectï¼‰ï¼šæ²¡æœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œé€šå¸¸ç”¨äºæè¿°æŸä¸ªå®ä½“çš„å±æ€§æˆ–ç»†èŠ‚ã€‚å®ƒä»¬æ˜¯ä¸å¯å˜çš„ï¼Œä¸¤ä¸ªå€¼å¯¹è±¡å¦‚æœå…·æœ‰ç›¸åŒçš„å±æ€§å€¼ï¼Œåˆ™è®¤ä¸ºæ˜¯ç›¸ç­‰çš„ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåœ°å€å¯ä»¥ä½œä¸ºä¸€ä¸ªå€¼å¯¹è±¡ã€‚\nèšåˆï¼ˆAggregateï¼‰ï¼šä¸€ç»„ç›¸å…³çš„å¯¹è±¡ï¼ˆå®ä½“å’Œå€¼å¯¹è±¡ï¼‰çš„é›†åˆï¼Œå®ƒä»¬è¢«è§†ä¸ºä¸€ä¸ªå•å…ƒè¿›è¡Œæ•°æ®ä¿®æ”¹ã€‚èšåˆæœ‰ä¸€ä¸ªæ ¹å®ä½“ï¼ˆAggregate Rootï¼‰ï¼Œé€šè¿‡æ ¹å®ä½“æ¥ç®¡ç†èšåˆçš„ç”Ÿå‘½å‘¨æœŸã€‚\né¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰ï¼šå°è£…é¢†åŸŸé€»è¾‘çš„æ“ä½œï¼Œè¿™äº›æ“ä½œä¸å±äºä»»ä½•ä¸€ä¸ªå®ä½“æˆ–å€¼å¯¹è±¡ã€‚å®ƒä»¬é€šå¸¸ç”¨äºè¡¨ç¤ºè·¨è¶Šå¤šä¸ªå®ä½“æˆ–å€¼å¯¹è±¡çš„ä¸šåŠ¡é€»è¾‘ã€‚\nä»“å‚¨ï¼ˆRepositoryï¼‰ï¼šæä¾›è®¿é—®æŒä¹…åŒ–å­˜å‚¨ä¸­å¯¹è±¡çš„æ–¹æ³•ï¼Œé€šå¸¸ç”¨äºè·å–å’Œä¿å­˜èšåˆæ ¹ã€‚\nä»€ä¹ˆæ˜¯èšåˆæ ¹ æŒ‡çš„æ˜¯ä¸€ä¸ªèšåˆä¸­å…·æœ‰å”¯ä¸€æ ‡è¯†çš„æ ¸å¿ƒå®ä½“ï¼Œè¯¥å®ä½“è´Ÿè´£æ§åˆ¶æ•´ä¸ªèšåˆçš„ç”Ÿå‘½å‘¨æœŸå’Œä¸€è‡´æ€§ã€‚\næ§åˆ¶è®¿é—®ï¼šèšåˆæ ¹æ˜¯èšåˆå†…çš„å”¯ä¸€å…¥å£ç‚¹ï¼Œå¤–éƒ¨å¯¹è±¡åªèƒ½é€šè¿‡èšåˆæ ¹æ¥è®¿é—®æˆ–æ“ä½œèšåˆä¸­çš„å…¶å®ƒå¯¹è±¡ã€‚è¿™æœ‰åŠ©äºä¿æŒèšåˆå†…éƒ¨çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚\nç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼šèšåˆæ ¹è´Ÿè´£ç®¡ç†èšåˆå†…æ‰€æœ‰å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤æ“ä½œã€‚é€šè¿‡èšåˆæ ¹ï¼Œå¯ä»¥ç¡®ä¿å¯¹èšåˆä¸­æ•°æ®çš„ä»»ä½•ä¿®æ”¹éƒ½æ˜¯åˆæ³•å’Œä¸€è‡´çš„ã€‚\nä¸€è‡´æ€§è¾¹ç•Œï¼šèšåˆå®šä¹‰äº†ä¸€ä¸ªä¸€è‡´æ€§è¾¹ç•Œï¼Œå…¶ä¸­çš„æ‰€æœ‰å¯¹è±¡åœ¨äº‹åŠ¡ä¸­åº”è¯¥ä¿æŒä¸€è‡´ã€‚å› æ­¤ï¼Œèšåˆæ ¹é€šè¿‡ç¡®ä¿åœ¨å…¶èŒƒå›´å†…çš„æ“ä½œéƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ¥ç»´æŒè¿™ç§è¾¹ç•Œã€‚\nå”¯ä¸€æ€§ï¼šæ¯ä¸ªèšåˆéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„èšåˆæ ¹ã€‚é€šå¸¸ï¼Œèšåˆæ ¹å…·æœ‰å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨æ¥æ ‡è¯†å’Œè®¿é—®è¯¥èšåˆã€‚\næŒä¹…åŒ–ç®¡ç†ï¼šé€šè¿‡ä»“å‚¨ï¼ˆRepositoryï¼‰æ¨¡å¼ï¼Œèšåˆæ ¹é€šå¸¸æ˜¯æŒä¹…åŒ–æ“ä½œï¼ˆå¦‚ä¿å­˜å’Œæ£€ç´¢ï¼‰çš„ä¸»è¦å¯¹è±¡ã€‚è¿™æ„å‘³ç€ä»“å‚¨é€šå¸¸åªç›´æ¥å¤„ç†èšåˆæ ¹ï¼Œè€Œä¸æ˜¯èšåˆå†…çš„å…¶å®ƒå¯¹è±¡ã€‚\né¢†åŸŸé©±åŠ¨è®¾è®¡ä¼˜ç¼ºç‚¹ é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDomain-Driven Design, DDDï¼‰æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ–¹æ³•ï¼Œæ—¨åœ¨é€šè¿‡ç´§å¯†ç»“åˆä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯å®ç°æ¥æ„å»ºå¤æ‚è½¯ä»¶ç³»ç»Ÿã€‚ä»¥ä¸‹æ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡çš„ä¸€äº›ä¼˜ç¼ºç‚¹ï¼š\nä¼˜ç‚¹ æ›´å¥½åœ°ç†è§£ä¸šåŠ¡ï¼š\nDDDå¼ºè°ƒä¸é¢†åŸŸä¸“å®¶çš„å¯†åˆ‡åˆä½œï¼Œä½¿å¼€å‘å›¢é˜Ÿå¯¹ä¸šåŠ¡éœ€æ±‚æœ‰æ›´æ·±å…¥çš„ç†è§£ã€‚è¿™æœ‰åŠ©äºåˆ›å»ºæ›´ç¬¦åˆä¸šåŠ¡éœ€æ±‚çš„ç³»ç»Ÿã€‚ æ¸…æ™°çš„æ¨¡å‹ï¼š\né€šè¿‡ä½¿ç”¨ç»Ÿä¸€è¯­è¨€å’Œé¢†åŸŸæ¨¡å‹ï¼Œæ‰€æœ‰å›¢é˜Ÿæˆå‘˜ï¼ˆåŒ…æ‹¬æŠ€æœ¯äººå‘˜å’ŒéæŠ€æœ¯äººå‘˜ï¼‰éƒ½å¯ä»¥åœ¨åŒä¸€è¯­å¢ƒä¸‹æ²Ÿé€šï¼Œä»è€Œå‡å°‘è¯¯è§£ã€‚ çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼š\nDDDé¼“åŠ±æ¨¡å—åŒ–è®¾è®¡ï¼Œå¦‚ç•Œé™ä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰å’Œèšåˆï¼ˆAggregateï¼‰ï¼Œè¿™äº›è®¾è®¡æœ‰åŠ©äºç®€åŒ–ç³»ç»Ÿçš„ç»´æŠ¤å’Œæ‰©å±•ã€‚ å…³æ³¨æ ¸å¿ƒé¢†åŸŸï¼š\né€šè¿‡è¯†åˆ«å’Œèšç„¦äºæ ¸å¿ƒé¢†åŸŸï¼ŒDDDå¸®åŠ©å›¢é˜Ÿå°†èµ„æºé›†ä¸­åœ¨å¯¹ä¸šåŠ¡æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œä»è€Œæé«˜ç«äº‰åŠ›ã€‚ æ”¯æŒå¤æ‚ç³»ç»Ÿå¼€å‘ï¼š\nDDDä¸ºå¤„ç†å¤æ‚é¢†åŸŸé€»è¾‘æä¾›äº†æœ‰åŠ›çš„æ–¹æ³•å’Œå·¥å…·ï¼Œå¯ä»¥æœ‰æ•ˆåœ°ç®¡ç†å¤æ‚æ€§ã€‚ ç¼ºç‚¹ å­¦ä¹ æ›²çº¿é™¡å³­ï¼š\nå¯¹è®¸å¤šå¼€å‘äººå‘˜å’Œç»„ç»‡æ¥è¯´ï¼ŒDDDçš„æ¦‚å¿µå’ŒæŠ€æœ¯æœ¯è¯­å¯èƒ½è¾ƒä¸ºé™Œç”Ÿï¼Œåˆå§‹å­¦ä¹ å’Œå®æ–½æˆæœ¬è¾ƒé«˜ã€‚ æ—¶é—´å’Œèµ„æºæŠ•å…¥å¤§ï¼š\nç”±äºéœ€è¦æ·±åº¦çš„é¢†åŸŸåˆ†æå’ŒæŒç»­çš„å›¢é˜Ÿåä½œï¼ŒDDDå¯èƒ½æ¯”ä¼ ç»Ÿæ–¹æ³•èŠ±è´¹æ›´å¤šæ—¶é—´å’Œèµ„æºã€‚ ä¸é€‚åˆæ‰€æœ‰é¡¹ç›®ï¼š\nå¯¹äºç®€å•æˆ–å°å‹é¡¹ç›®ï¼ŒDDDå¯èƒ½è¿‡äºå¤æ‚å’Œå†—ä½™ï¼ŒæŠ•å…¥çš„æˆæœ¬å’Œæ”¶ç›Šä¸æˆæ¯”ä¾‹ã€‚ éœ€æ±‚ç¨³å®šæ€§è¦æ±‚é«˜ï¼š\nDDDæ›´é€‚åˆäºéœ€æ±‚ç›¸å¯¹ç¨³å®šä¸”å¯¹ä¸šåŠ¡é€»è¾‘è¦æ±‚é«˜çš„é¡¹ç›®ã€‚å¯¹äºéœ€æ±‚é¢‘ç¹å˜åŒ–çš„é¡¹ç›®ï¼Œå¯èƒ½éœ€è¦ç»å¸¸é‡æ„ã€‚ å¯¹å›¢é˜Ÿåä½œè¦æ±‚é«˜ï¼š\næˆåŠŸå®æ–½DDDéœ€è¦å›¢é˜Ÿæˆå‘˜ä¹‹é—´è‰¯å¥½çš„æ²Ÿé€šå’Œåä½œï¼Œè¿™å¯¹å›¢é˜Ÿçš„ç»„ç»‡æ–‡åŒ–å’Œæ²Ÿé€šèƒ½åŠ›æå‡ºäº†è¾ƒé«˜è¦æ±‚ã€‚ ä¸ºä»€ä¹ˆéœ€è¦é¢†åŸŸæ¨¡å‹ åœ¨ä¼ ç»Ÿçš„è½¯ä»¶å¼€å‘ä¸­,æˆ‘ä»¬å¸¸å¸¸é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š\n1. è´«è¡€æ¨¡å‹çš„å›°å¢ƒ ä¼ ç»Ÿçš„å¼€å‘æ–¹å¼å¾€å¾€é‡‡ç”¨\"è´«è¡€æ¨¡å‹\"ï¼ˆAnemic Domain Modelï¼‰ï¼Œå³ï¼š\næ•°æ®å¯¹è±¡åªåŒ…å«å­—æ®µå’Œç®€å•çš„ getter/setterï¼Œæ²¡æœ‰ä»»ä½•ä¸šåŠ¡é€»è¾‘ æ‰€æœ‰ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨ Service å±‚ï¼Œå½¢æˆåºå¤§çš„æœåŠ¡ç±» æ•°æ®å’Œè¡Œä¸ºåˆ†ç¦»ï¼Œå¯¼è‡´ä»£ç éš¾ä»¥ç†è§£å’Œç»´æŠ¤ 2. ä¸šåŠ¡é€»è¾‘æ•£ä¹± ç¼ºä¹ç»Ÿä¸€çš„ä¸šåŠ¡è§„åˆ™ç®¡ç†ï¼šåŒæ ·çš„ä¸šåŠ¡é€»è¾‘å¯èƒ½åœ¨å¤šä¸ªåœ°æ–¹é‡å¤å®ç° éš¾ä»¥ä¿è¯ä¸€è‡´æ€§ï¼šè®¢å•åˆ›å»ºã€ä¿®æ”¹ã€å–æ¶ˆç­‰æ“ä½œä¸­çš„ä¸šåŠ¡è§„åˆ™å¯èƒ½ä¸ä¸€è‡´ ç»´æŠ¤æˆæœ¬é«˜ï¼šä¿®æ”¹ä¸€ä¸ªä¸šåŠ¡è§„åˆ™éœ€è¦åœ¨å¤šä¸ªåœ°æ–¹æŸ¥æ‰¾å’Œä¿®æ”¹ 3. æŠ€æœ¯ä¸ä¸šåŠ¡è„±èŠ‚ ä»£ç éš¾ä»¥åæ˜ ä¸šåŠ¡æ„å›¾ï¼šå¼€å‘äººå‘˜çœ‹åˆ°çš„æ˜¯è¡¨ã€å­—æ®µã€SQLï¼Œè€Œä¸æ˜¯è®¢å•ã€æ”¯ä»˜ã€å‘è´§ç­‰ä¸šåŠ¡æ¦‚å¿µ ä¸é¢†åŸŸä¸“å®¶æ²Ÿé€šå›°éš¾ï¼šæŠ€æœ¯æœ¯è¯­å’Œä¸šåŠ¡æœ¯è¯­æ— æ³•å¯¹åº”ï¼Œå®¹æ˜“äº§ç”Ÿç†è§£åå·® éœ€æ±‚å˜æ›´ä»£ä»·å¤§ï¼šä¸šåŠ¡è°ƒæ•´æ—¶ï¼Œéœ€è¦ä»åº•å±‚æ•°æ®ç»“æ„å¼€å§‹é‡æ–°è®¾è®¡ é¢†åŸŸæ¨¡å‹å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ é¢†åŸŸæ¨¡å‹é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³ä¸Šè¿°é—®é¢˜ï¼š\n1. å°è£…ä¸šåŠ¡é€»è¾‘ // å……è¡€æ¨¡å‹ç¤ºä¾‹ class Order { constructor(id, userId) { this.id = id; this.userId = userId; this.items = []; this.status = 'PENDING'; } // ä¸šåŠ¡é€»è¾‘å°è£…åœ¨å®ä½“å†…éƒ¨ addItem(product, quantity) { if (this.status !== 'PENDING') { throw new Error('åªèƒ½å‘å¾…å¤„ç†è®¢å•æ·»åŠ å•†å“'); } if (quantity \u003c= 0) { throw new Error('å•†å“æ•°é‡å¿…é¡»å¤§äº0'); } this.items.push({ product, quantity }); } submit() { if (this.items.length === 0) { throw new Error('è®¢å•ä¸èƒ½ä¸ºç©º'); } this.status = 'SUBMITTED'; // è§¦å‘é¢†åŸŸäº‹ä»¶ this.addDomainEvent(new OrderSubmittedEvent(this)); } calculateTotal() { return this.items.reduce((sum, item) =\u003e sum + item.product.price * item.quantity, 0); } } 2. ç»Ÿä¸€è¯­è¨€ï¼ˆUbiquitous Languageï¼‰ ä»£ç ä¸­çš„ç±»åã€æ–¹æ³•åç›´æ¥å¯¹åº”ä¸šåŠ¡æ¦‚å¿µ å¼€å‘äººå‘˜å’Œé¢†åŸŸä¸“å®¶ä½¿ç”¨ç›¸åŒçš„æœ¯è¯­ ä»£ç å³æ–‡æ¡£ï¼Œä¸šåŠ¡è§„åˆ™æ¸…æ™°å¯è§ 3. ç»´æŠ¤ä¸šåŠ¡ä¸å˜æ€§ï¼ˆInvariantsï¼‰ é€šè¿‡èšåˆæ ¹æ§åˆ¶çŠ¶æ€å˜æ›´ ç¡®ä¿å¯¹è±¡å§‹ç»ˆå¤„äºæœ‰æ•ˆçŠ¶æ€ ä¸šåŠ¡è§„åˆ™åœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰å’Œç»´æŠ¤ 4. é™ä½è®¤çŸ¥è´Ÿæ‹… æ¯ä¸ªé¢†åŸŸå¯¹è±¡èŒè´£æ¸…æ™° ä¸šåŠ¡é€»è¾‘å†…èšï¼Œæ˜“äºç†è§£å’Œæµ‹è¯• ä¿®æ”¹å½±å“èŒƒå›´å¯æ§ å®è·µä»·å€¼ å¼•å…¥é¢†åŸŸæ¨¡å‹åï¼Œå¸¦æ¥çš„å®é™…ä»·å€¼ï¼š\nä»£ç å¯è¯»æ€§æå‡ï¼šæ–°äººå¯ä»¥é€šè¿‡é˜…è¯»é¢†åŸŸæ¨¡å‹å¿«é€Ÿç†è§£ä¸šåŠ¡ ç»´æŠ¤æˆæœ¬é™ä½ï¼šä¸šåŠ¡è§„åˆ™é›†ä¸­ç®¡ç†ï¼Œä¿®æ”¹å½±å“èŒƒå›´æ˜ç¡® æµ‹è¯•æ›´å®¹æ˜“ï¼šé¢†åŸŸå¯¹è±¡å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼Œä¸ä¾èµ–æ•°æ®åº“å’Œå¤–éƒ¨æœåŠ¡ åº”å¯¹å¤æ‚åº¦ï¼šå½“ä¸šåŠ¡é€»è¾‘å˜å¾—å¤æ‚æ—¶ï¼Œé¢†åŸŸæ¨¡å‹çš„ä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ é•¿æœŸä»·å€¼ï¼šéšç€é¡¹ç›®æ¼”è¿›ï¼Œé¢†åŸŸæ¨¡å‹å¸®åŠ©ä¿æŒä»£ç è´¨é‡å’Œæ¶æ„æ¸…æ™°åº¦ æ€»ç»“ï¼šé¢†åŸŸæ¨¡å‹ä¸æ˜¯é“¶å¼¹ï¼Œä½†å¯¹äºä¸šåŠ¡é€»è¾‘å¤æ‚çš„ç³»ç»Ÿæ¥è¯´ï¼Œå®ƒæä¾›äº†ä¸€ç§æ›´åŠ è´´è¿‘ä¸šåŠ¡ã€æ˜“äºç»´æŠ¤çš„ä»£ç ç»„ç»‡æ–¹å¼ã€‚é€šè¿‡å°†æ•°æ®å’Œè¡Œä¸ºç»“åˆï¼Œé¢†åŸŸæ¨¡å‹è®©ä»£ç çœŸæ­£æˆä¸ºä¸šåŠ¡çŸ¥è¯†çš„è¡¨è¾¾\nä¸¾ä¾‹ ä¸‹é¢é€šè¿‡ä¸€ä¸ªæ¸¸æˆä¸­çš„\"å® ç‰©å–‚å…»å‡çº§\"æ¨¡å‹æ¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨DDDè¿›è¡Œè®¾è®¡\nä¸šåŠ¡åœºæ™¯ åœ¨ä¸€ä¸ªå® ç‰©å…»æˆæ¸¸æˆä¸­ï¼Œç©å®¶å¯ä»¥ï¼š\nå–‚å…»å® ç‰©è·å¾—ç»éªŒå€¼ å® ç‰©ç»éªŒå€¼è¾¾åˆ°ä¸€å®šæ•°é‡åè¿›è¡Œå‡çº§ å® ç‰©å‡çº§åæœ‰å¯¹åº”çš„å¥–åŠ±ç‰© æœ€ç»ˆæ ¹æ®å® ç‰©çš„å¥–åŠ±ç‰©å‘æ”¾å¯¹åº”çš„å¥–åŠ± ä¸šåŠ¡æµç¨‹å›¾ stateDiagram-v2 [*] --\u003e å¾…å–‚å…»: å® ç‰©åˆå§‹çŠ¶æ€ å¾…å–‚å…» --\u003e å¢åŠ ç»éªŒ: ç©å®¶å–‚å…»é£Ÿç‰© å¢åŠ ç»éªŒ --\u003e æ£€æŸ¥å‡çº§æ¡ä»¶: ç»éªŒå€¼ç´¯åŠ  æ£€æŸ¥å‡çº§æ¡ä»¶ --\u003e å‡çº§ä¸­: ç»éªŒå€¼ \u003e= æ‰€éœ€ç»éªŒ æ£€æŸ¥å‡çº§æ¡ä»¶ --\u003e å¾…å–‚å…»: ç»éªŒå€¼ \u003c æ‰€éœ€ç»éªŒ å‡çº§ä¸­ --\u003e å±æ€§æå‡: æ¶ˆè€—ç»éªŒå€¼ å±æ€§æå‡ --\u003e å¥–åŠ±ç”Ÿæˆ: ç­‰çº§+1, å±æ€§å¢åŠ  å¥–åŠ±ç”Ÿæˆ --\u003e æ£€æŸ¥å‡çº§æ¡ä»¶: ç»§ç»­æ£€æŸ¥æ˜¯å¦èƒ½å†æ¬¡å‡çº§ å¥–åŠ±ç”Ÿæˆ --\u003e å‘æ”¾å¥–åŠ±: æ‰€æœ‰å‡çº§å®Œæˆ å‘æ”¾å¥–åŠ± --\u003e å¾…å–‚å…»: å¥–åŠ±å‘æ”¾å®Œæ¯• note right of æ£€æŸ¥å‡çº§æ¡ä»¶ ä¸åŒå“è´¨å® ç‰© æ‰€éœ€ç»éªŒä¸åŒ - æ™®é€š: 1.0x - ç¨€æœ‰: 1.2x - å²è¯—: 1.5x end note note right of å±æ€§æå‡ å±æ€§å¢é•¿å…¬å¼ HP: +10 * å“è´¨å€ç‡ Attack: +5 * å“è´¨å€ç‡ end note çŠ¶æ€è¯´æ˜ï¼š\nå¾…å–‚å…»ï¼šå® ç‰©çš„æ­£å¸¸çŠ¶æ€ï¼Œç­‰å¾…ç©å®¶æŠ•å–‚é£Ÿç‰© å¢åŠ ç»éªŒï¼šå–‚å…»åç»éªŒå€¼å¢åŠ çš„ç¬æ—¶çŠ¶æ€ æ£€æŸ¥å‡çº§æ¡ä»¶ï¼šåˆ¤æ–­å½“å‰ç»éªŒæ˜¯å¦è¶³å¤Ÿå‡çº§ï¼ˆæ”¯æŒè¿ç»­å‡çº§ï¼‰ å‡çº§ä¸­ï¼šæ¶ˆè€—ç»éªŒå€¼ï¼Œè¿›è¡Œç­‰çº§æå‡ å±æ€§æå‡ï¼šæ ¹æ®å“è´¨å€ç‡è®¡ç®—æ–°çš„å±æ€§å€¼ å¥–åŠ±ç”Ÿæˆï¼šåŸºäºå‡çº§ç»“æœç”Ÿæˆå¥–åŠ±ç‰©å“ å‘æ”¾å¥–åŠ±ï¼šå°†å¥–åŠ±ç‰©å“å‘æ”¾ç»™ç©å®¶ ä¼ ç»Ÿå®ç°æ–¹å¼ // æ•°æ®æ¨¡å‹ class Pet { id; name; level; exp; quality; // å“è´¨ï¼šæ™®é€šã€ç¨€æœ‰ã€å²è¯— hp; attack; } // Serviceå±‚å¤„ç†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ class PetService { async feed(petId, foodValue) { // 1. æŸ¥è¯¢å® ç‰© const pet = await db.query('SELECT * FROM pets WHERE id = ?', [petId]); // 2. è®¡ç®—ç»éªŒå€¼ pet.exp += foodValue; // 3. æ£€æŸ¥æ˜¯å¦å‡çº§ï¼ˆé€»è¾‘åˆ†æ•£ï¼‰ let levelUpCount = 0; while (pet.exp \u003e= this.getRequiredExp(pet.level, pet.quality)) { pet.exp -= this.getRequiredExp(pet.level, pet.quality); pet.level += 1; levelUpCount++; } // 4. å‡çº§åå±æ€§è®¡ç®—ï¼ˆé€»è¾‘å¤æ‚ä¸”å®¹æ˜“å‡ºé”™ï¼‰ if (levelUpCount \u003e 0) { pet.hp += levelUpCount * 10 * this.getQualityMultiplier(pet.quality); pet.attack += levelUpCount * 5 * this.getQualityMultiplier(pet.quality); // 5. å‘é€é€šçŸ¥ await this.sendLevelUpNotification(petId, pet.level); } // 6. ä¿å­˜ await db.query('UPDATE pets SET level=?, exp=?, hp=?, attack=? WHERE id=?', [pet.level, pet.exp, pet.hp, pet.attack, petId]); return pet; } getRequiredExp(level, quality) { // å‡çº§æ‰€éœ€ç»éªŒè®¡ç®—é€»è¾‘ const base = 100 * level; return quality === 'epic' ? base * 1.5 : quality === 'rare' ? base * 1.2 : base; } getQualityMultiplier(quality) { return quality === 'epic' ? 1.5 : quality === 'rare' ? 1.2 : 1.0; } } é—®é¢˜ï¼š\nä¸šåŠ¡é€»è¾‘å…¨åœ¨Serviceå±‚ï¼Œä»£ç è‡ƒè‚¿ Petåªæ˜¯æ•°æ®å®¹å™¨ï¼Œæ²¡æœ‰è¡Œä¸º å‡çº§è§„åˆ™ã€å±æ€§è®¡ç®—æ•£è½å„å¤„ éš¾ä»¥ä¿è¯å® ç‰©çŠ¶æ€çš„ä¸€è‡´æ€§ æµ‹è¯•å›°éš¾ï¼Œéœ€è¦mockæ•°æ®åº“ DDDå®ç°æ–¹å¼ 1. å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰- ç»éªŒå€¼ // å€¼å¯¹è±¡ï¼šç»éªŒå€¼ class Experience { constructor(current, level, quality) { if (current \u003c 0) throw new Error('ç»éªŒå€¼ä¸èƒ½ä¸ºè´Ÿ'); this.current = current; this.level = level; this.quality = quality; } // è·å–å‡çº§æ‰€éœ€ç»éªŒ getRequiredForNextLevel() { const baseExp = 100 * this.level; const multiplier = { 'common': 1.0, 'rare': 1.2, 'epic': 1.5 }[this.quality] || 1.0; return Math.floor(baseExp * multiplier); } // æ·»åŠ ç»éªŒï¼Œè¿”å›æ–°çš„Experienceå¯¹è±¡ï¼ˆå€¼å¯¹è±¡ä¸å¯å˜ï¼‰ add(value) { return new Experience( this.current + value, this.level, this.quality ); } // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§ canLevelUp() { return this.current \u003e= this.getRequiredForNextLevel(); } // æ¶ˆè€—å‡çº§æ‰€éœ€ç»éªŒ consumeForLevelUp() { const required = this.getRequiredForNextLevel(); return new Experience( this.current - required, this.level + 1, this.quality ); } } 2. å€¼å¯¹è±¡ - å® ç‰©å±æ€§ // å€¼å¯¹è±¡ï¼šå±æ€§ class PetStats { constructor(hp, attack, level, quality) { this.hp = hp; this.attack = attack; this.level = level; this.quality = quality; } // å‡çº§åçš„å±æ€§ levelUp() { const multiplier = { 'common': 1.0, 'rare': 1.2, 'epic': 1.5 }[this.quality] || 1.0; return new PetStats( this.hp + Math.floor(10 * multiplier), this.attack + Math.floor(5 * multiplier), this.level + 1, this.quality ); } } 3. é¢†åŸŸäº‹ä»¶ // é¢†åŸŸäº‹ä»¶ï¼šå® ç‰©å‡çº§äº‹ä»¶ class PetLeveledUpEvent { constructor(petId, oldLevel, newLevel, stats) { this.petId = petId; this.oldLevel = oldLevel; this.newLevel = newLevel; this.stats = stats; this.occurredAt = new Date(); } } // é¢†åŸŸäº‹ä»¶ï¼šå® ç‰©å–‚å…»äº‹ä»¶ class PetFedEvent { constructor(petId, foodValue, gainedExp) { this.petId = petId; this.foodValue = foodValue; this.gainedExp = gainedExp; this.occurredAt = new Date(); } } 4. å®ä½“/èšåˆæ ¹ - å® ç‰© // èšåˆæ ¹ï¼šå® ç‰© class Pet { constructor(id, name, quality, experience, stats) { this.id = id; this.name = name; this.quality = quality; // 'common', 'rare', 'epic' this.experience = experience; // Experienceå€¼å¯¹è±¡ this.stats = stats; // PetStatså€¼å¯¹è±¡ this.domainEvents = []; // é¢†åŸŸäº‹ä»¶åˆ—è¡¨ } // å–‚å…»å® ç‰© feed(foodValue) { if (foodValue \u003c= 0) { throw new Error('é£Ÿç‰©ä»·å€¼å¿…é¡»å¤§äº0'); } // æ·»åŠ ç»éªŒ const oldExp = this.experience; this.experience = this.experience.add(foodValue); // è®°å½•å–‚å…»äº‹ä»¶ this.addDomainEvent(new PetFedEvent( this.id, foodValue, foodValue )); // å°è¯•å‡çº§ this.tryLevelUp(); } // å°è¯•å‡çº§ï¼ˆç§æœ‰ä¸šåŠ¡é€»è¾‘ï¼‰ tryLevelUp() { let levelUpCount = 0; // å¾ªç¯å‡çº§ï¼ˆå¤„ç†ä¸€æ¬¡å–‚å…»å¤šæ¬¡å‡çº§çš„æƒ…å†µï¼‰ while (this.experience.canLevelUp()) { const oldLevel = this.stats.level; // æ¶ˆè€—ç»éªŒ this.experience = this.experience.consumeForLevelUp(); // æå‡å±æ€§ this.stats = this.stats.levelUp(); levelUpCount++; // è§¦å‘å‡çº§äº‹ä»¶ this.addDomainEvent(new PetLeveledUpEvent( this.id, oldLevel, this.stats.level, { hp: this.stats.hp, attack: this.stats.attack } )); } return levelUpCount; } // æ·»åŠ é¢†åŸŸäº‹ä»¶ addDomainEvent(event) { this.domainEvents.push(event); } // è·å–å¹¶æ¸…ç©ºé¢†åŸŸäº‹ä»¶ pullDomainEvents() { const events = [...this.domainEvents]; this.domainEvents = []; return events; } // è·å–å½“å‰ç­‰çº§ getLevel() { return this.stats.level; } // è·å–å½“å‰ç»éªŒè¿›åº¦ï¼ˆç™¾åˆ†æ¯”ï¼‰ getExpProgress() { const required = this.experience.getRequiredForNextLevel(); return (this.experience.current / required * 100).toFixed(2); } } 5. ä»“å‚¨æ¥å£ // ä»“å‚¨æ¥å£ class IPetRepository { async findById(petId) { throw new Error('Not implemented'); } async save(pet) { throw new Error('Not implemented'); } } // ä»“å‚¨å®ç° class PetRepository extends IPetRepository { constructor(db) { super(); this.db = db; } async findById(petId) { const data = await this.db.query( 'SELECT * FROM pets WHERE id = ?', [petId] ); if (!data) return null; // ä»æ•°æ®é‡å»ºé¢†åŸŸå¯¹è±¡ return new Pet( data.id, data.name, data.quality, new Experience(data.exp, data.level, data.quality), new PetStats(data.hp, data.attack, data.level, data.quality) ); } async save(pet) { // ä¿å­˜èšåˆæ ¹ await this.db.query( `UPDATE pets SET level = ?, exp = ?, hp = ?, attack = ? WHERE id = ?`, [ pet.stats.level, pet.experience.current, pet.stats.hp, pet.stats.attack, pet.id ] ); // å‘å¸ƒé¢†åŸŸäº‹ä»¶ const events = pet.pullDomainEvents(); for (const event of events) { await this.publishEvent(event); } } async publishEvent(event) { // å‘å¸ƒäº‹ä»¶åˆ°äº‹ä»¶æ€»çº¿ // ä¾‹å¦‚ï¼šå‘é€é€šçŸ¥ã€æ›´æ–°æ’è¡Œæ¦œç­‰ console.log('Domain Event:', event); } } 6. åº”ç”¨æœåŠ¡ï¼ˆç®€æ´çš„ä¸šåŠ¡é€»è¾‘ç¼–æ’å±‚ï¼‰ // åº”ç”¨æœåŠ¡ï¼šåªè´Ÿè´£ç¼–æ’ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ class PetApplicationService { constructor(petRepository) { this.petRepository = petRepository; } async feedPet(petId, foodValue) { // 1. åŠ è½½èšåˆæ ¹ const pet = await this.petRepository.findById(petId); if (!pet) { throw new Error('å® ç‰©ä¸å­˜åœ¨'); } // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆåœ¨é¢†åŸŸæ¨¡å‹ä¸­ï¼‰ pet.feed(foodValue); // 3. æŒä¹…åŒ– await this.petRepository.save(pet); // 4. è¿”å›ç»“æœ return { level: pet.getLevel(), exp: pet.experience.current, expProgress: pet.getExpProgress(), hp: pet.stats.hp, attack: pet.stats.attack }; } } 7. ä½¿ç”¨ç¤ºä¾‹ // ä½¿ç”¨ const petService = new PetApplicationService(petRepository); // å–‚å…»å® ç‰© const result = await petService.feedPet('pet-123', 250); console.log(`å® ç‰©å‡çº§åˆ°${result.level}çº§ï¼Œç»éªŒè¿›åº¦${result.expProgress}%`); // ä¸šåŠ¡é€»è¾‘éƒ½åœ¨é¢†åŸŸæ¨¡å‹ä¸­ï¼Œåº”ç”¨æœåŠ¡éå¸¸ç®€æ´ æ›´è¿›ä¸€æ­¥ åœ¨å®é™…ä¸šåŠ¡ä¸­,æˆ‘ä»¬å¸¸å¸¸éœ€è¦åœ¨ä¿æŒæ ¸å¿ƒæµç¨‹ä¸å˜çš„æƒ…å†µä¸‹,å…è®¸ä¸åŒçš„ä¸šåŠ¡åœºæ™¯æœ‰å®šåˆ¶åŒ–çš„é€»è¾‘ã€‚è¿™æ—¶å¯ä»¥è¿›ä¸€æ­¥é€šè¿‡æ‰©å±•ç‚¹æ¨¡å¼æ¥å®ç°ã€‚\nä¸šåŠ¡åœºæ™¯æ‰©å±• å‡è®¾æˆ‘ä»¬çš„å® ç‰©ç³»ç»Ÿéœ€è¦æ”¯æŒä¸åŒç±»å‹çš„å–‚å…»ç­–ç•¥ï¼š\næ™®é€šå® ç‰©ï¼šç›´æ¥è·å¾—ç»éªŒ VIPå® ç‰©ï¼šè·å¾—ç»éªŒåŠ æˆ,å¹¶æœ‰é¢å¤–çš„å±æ€§æå‡ ä¼ è¯´å® ç‰©ï¼šå–‚å…»æ—¶è§¦å‘ç‰¹æ®Šæ•ˆæœ,å¯èƒ½è·å¾—é¢å¤–å¥–åŠ± å®Œæ•´ç±»å‹å®šä¹‰ é¦–å…ˆ,å®šä¹‰å®Œæ•´çš„ç±»å‹ç³»ç»Ÿï¼š\n// ============= åŸºç¡€ç±»å‹å®šä¹‰ ============= // å¥–åŠ±ç±»å‹ type RewardType = 'gold' | 'diamond' | 'special_item' | 'rare_event'; // å¥–åŠ±æ¥å£ interface Reward { type: RewardType; amount?: number; itemId?: string; eventId?: string; reason: string; } // è¿å‡»çŠ¶æ€ type ComboStatus = 'GOOD' | 'GREAT!' | 'AMAZING!'; // å® ç‰©ç­‰çº§è¯„çº§ type PetRank = 'Cçº§æ™®é€š' | 'Bçº§ç¨€æœ‰' | 'Açº§å²è¯—' | 'Sçº§ä¼ è¯´'; // VIPç­‰çº§ type VipLevel = 1 | 2 | 3; // ============= æ‰©å±•å­—æ®µç±»å‹å®šä¹‰ ============= // VIPç‰¹æƒä¿¡æ¯ interface VipPrivilege { savedFeeds: number; message: string; } // è¿å‡»ä¿¡æ¯ interface ComboInfo { comboCount: number; comboBonus: number; nextComboAt: number; comboStatus: ComboStatus; } // æ¯æ—¥é™åˆ¶ä¿¡æ¯ interface DailyLimit { remaining: number; total: number; resetAt: number; } // ç‰¹æ®Šäº‹ä»¶ä¿¡æ¯ interface SpecialEvents { triggered: boolean; events: Reward[]; message: string; } // ä¼ è¯´ç»Ÿè®¡ä¿¡æ¯ interface LegendaryStats { totalBonus: number; legendaryBonus: number; efficiency: string; rank: PetRank; } // ============= è¿”å›ç»“æœç±»å‹å®šä¹‰ ============= // åŸºç¡€è¿”å›ç»“æœæ¥å£ interface BaseFeedingResponse { level: number; exp: number; expProgress: string; hp: number; attack: number; levelUpCount: number; rewards: Reward[]; } // æ™®é€šç­–ç•¥æ‰©å±•å­—æ®µ interface NormalFeedingExtensions { feedCount: number; totalExpGained: number; } // VIPç­–ç•¥æ‰©å±•å­—æ®µ interface VipFeedingExtensions { vipLevel: VipLevel; expBonus: number; bonusRate: string; vipPrivilege: VipPrivilege; } // ä¼ è¯´ç­–ç•¥æ‰©å±•å­—æ®µ interface LegendaryFeedingExtensions { comboInfo: ComboInfo; dailyLimit: DailyLimit; specialEvents?: SpecialEvents; legendaryStats: LegendaryStats; } // ç»„åˆè¿”å›ç±»å‹ type NormalFeedingResponse = BaseFeedingResponse \u0026 NormalFeedingExtensions; type VipFeedingResponse = BaseFeedingResponse \u0026 VipFeedingExtensions; type LegendaryFeedingResponse = BaseFeedingResponse \u0026 LegendaryFeedingExtensions; // ============= ä¸Šä¸‹æ–‡ç±»å‹å®šä¹‰ ============= interface FeedingContext { foodValue: number; expBonus: number; actualFoodValue: number; } // ============= äº‹ä»¶ç®¡ç†å™¨æ¥å£ ============= interface EventManager { publish(event: any): Promise\u003cvoid\u003e; } // ============= Pet ç›¸å…³æ¥å£ï¼ˆç®€åŒ–ç‰ˆï¼‰ ============= interface Pet { id: string; name: string; quality: string; experience: any; stats: any; feed(foodValue: number): void; getLevel(): number; getExpProgress(): string; } interface IPetRepository { findById(petId: string): Promise\u003cPet | null\u003e; save(pet: Pet): Promise\u003cvoid\u003e; } è¿”å›ç»“æœå°è£…ç±» // è¿”å›ç»“æœåŸºç±» class FeedingResult\u003cT extends Record\u003cstring, any\u003e = {}\u003e { level: number; exp: number; expProgress: string; hp: number; attack: number; levelUpCount: number; rewards: Reward[]; private extensions: T = {} as T; constructor(pet: Pet, levelUpCount: number, rewards: Reward[]) { this.level = pet.getLevel(); this.exp = pet.experience.current; this.expProgress = pet.getExpProgress(); this.hp = pet.stats.hp; this.attack = pet.stats.attack; this.levelUpCount = levelUpCount; this.rewards = rewards; } // æ·»åŠ æ‰©å±•æ•°æ®ï¼ˆç±»å‹å®‰å…¨ï¼‰ addExtension\u003cK extends keyof T\u003e(key: K, value: T[K]): void { this.extensions[key] = value; } // è½¬æ¢ä¸ºå“åº”å¯¹è±¡ toResponse(): BaseFeedingResponse \u0026 T { return { level: this.level, exp: this.exp, expProgress: this.expProgress, hp: this.hp, attack: this.attack, levelUpCount: this.levelUpCount, rewards: this.rewards, ...this.extensions } as BaseFeedingResponse \u0026 T; } } ç­–ç•¥æ¥å£å®šä¹‰ // å–‚å…»ç­–ç•¥æ‰©å±•ç‚¹æ¥å£ interface IFeedingStrategy\u003cTResponse extends BaseFeedingResponse = BaseFeedingResponse\u003e { // æ‰©å±•ç‚¹1ï¼šè®¡ç®—ç»éªŒåŠ æˆ calculateExpBonus(pet: Pet, foodValue: number): number; // æ‰©å±•ç‚¹2ï¼šå–‚å…»å‰çš„æ ¡éªŒé€»è¾‘ beforeFeed(pet: Pet, foodValue: number): Promise\u003cboolean\u003e; // æ‰©å±•ç‚¹3ï¼šå–‚å…»åçš„é¢å¤–å¤„ç† afterFeed(pet: Pet, levelUpCount: number): Promise\u003cvoid\u003e; // æ‰©å±•ç‚¹4ï¼šç”Ÿæˆå¥–åŠ± generateRewards(pet: Pet, levelUpCount: number): Reward[]; // æ‰©å±•ç‚¹5ï¼šæ‰©å±•è¿”å›ç»“æœ extendResult(result: FeedingResult\u003cany\u003e, pet: Pet, context: FeedingContext): void; } // æŠ½è±¡åŸºç¡€ç­–ç•¥ç±»ï¼ˆæä¾›é»˜è®¤å®ç°ï¼‰ abstract class BaseFeedingStrategy\u003cTResponse extends BaseFeedingResponse = BaseFeedingResponse\u003e implements IFeedingStrategy\u003cTResponse\u003e { abstract calculateExpBonus(pet: Pet, foodValue: number): number; async beforeFeed(pet: Pet, foodValue: number): Promise\u003cboolean\u003e { // é»˜è®¤å®ç°ï¼šå…è®¸å–‚å…» return true; } async afterFeed(pet: Pet, levelUpCount: number): Promise\u003cvoid\u003e { // é»˜è®¤å®ç°ï¼šä¸åšä»»ä½•å¤„ç† } abstract generateRewards(pet: Pet, levelUpCount: number): Reward[]; extendResult(result: FeedingResult\u003cany\u003e, pet: Pet, context: FeedingContext): void { // é»˜è®¤å®ç°ï¼šä¸åšä»»ä½•æ‰©å±• } } åº”ç”¨æœåŠ¡ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰ // åŸºç¡€å–‚å…»åº”ç”¨æœåŠ¡ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰ class BasePetFeedingService\u003cTResponse extends BaseFeedingResponse = BaseFeedingResponse\u003e { constructor( private readonly petRepository: IPetRepository, private readonly feedingStrategy: IFeedingStrategy\u003cTResponse\u003e ) {} // æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰å–‚å…»æµç¨‹éª¨æ¶ async feedPet(petId: string, foodValue: number): Promise\u003cTResponse\u003e { // 1. åŠ è½½èšåˆæ ¹ const pet = await this.petRepository.findById(petId); if (!pet) { throw new Error('å® ç‰©ä¸å­˜åœ¨'); } // 2. æ‰©å±•ç‚¹ï¼šå–‚å…»å‰æ ¡éªŒ const canFeed = await this.feedingStrategy.beforeFeed(pet, foodValue); if (!canFeed) { throw new Error('å½“å‰æ— æ³•å–‚å…»å® ç‰©'); } // 3. æ‰©å±•ç‚¹ï¼šè®¡ç®—ç»éªŒåŠ æˆ const expBonus = this.feedingStrategy.calculateExpBonus(pet, foodValue); const actualFoodValue = foodValue + expBonus; // 4. æ‰§è¡Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ const oldLevel = pet.getLevel(); pet.feed(actualFoodValue); const newLevel = pet.getLevel(); const levelUpCount = newLevel - oldLevel; // 5. æ‰©å±•ç‚¹ï¼šç”Ÿæˆå¥–åŠ± const rewards = this.feedingStrategy.generateRewards(pet, levelUpCount); // 6. æŒä¹…åŒ– await this.petRepository.save(pet); // 7. æ‰©å±•ç‚¹ï¼šå–‚å…»åå¤„ç† await this.feedingStrategy.afterFeed(pet, levelUpCount); // 8. æ„å»ºåŸºç¡€è¿”å›ç»“æœ const result = new FeedingResult(pet, levelUpCount, rewards); // 9. æ‰©å±•ç‚¹ï¼šæ‰©å±•è¿”å›ç»“æœ const context: FeedingContext = { foodValue, expBonus, actualFoodValue }; this.feedingStrategy.extendResult(result, pet, context); // 10. è¿”å›ç»“æœ return result.toResponse() as TResponse; } } ä¸šåŠ¡å®ç°æ‰©å±•ç‚¹ 1. æ™®é€šå® ç‰©å–‚å…»ç­–ç•¥ // æ™®é€šå® ç‰©å–‚å…»ç­–ç•¥ class NormalFeedingStrategy extends BaseFeedingStrategy\u003cNormalFeedingResponse\u003e { calculateExpBonus(pet: Pet, foodValue: number): number { // æ™®é€šå® ç‰©æ²¡æœ‰åŠ æˆ return 0; } generateRewards(pet: Pet, levelUpCount: number): Reward[] { // æ¯å‡1çº§ç»™100é‡‘å¸ if (levelUpCount === 0) return []; return [{ type: 'gold' as const, amount: 100 * levelUpCount, reason: 'å® ç‰©å‡çº§å¥–åŠ±' }]; } extendResult( result: FeedingResult\u003cNormalFeedingExtensions\u003e, pet: Pet, context: FeedingContext ): void { // æ™®é€šç­–ç•¥æ·»åŠ åŸºç¡€ç»Ÿè®¡ä¿¡æ¯ result.addExtension('feedCount', 1); result.addExtension('totalExpGained', context.actualFoodValue); } } 2. VIPå® ç‰©å–‚å…»ç­–ç•¥ // VIPå® ç‰©å–‚å…»ç­–ç•¥ class VipFeedingStrategy extends BaseFeedingStrategy\u003cVipFeedingResponse\u003e { constructor(private readonly vipLevel: VipLevel) { super(); } calculateExpBonus(pet: Pet, foodValue: number): number { // VIPç©å®¶è·å¾—ç»éªŒåŠ æˆ const bonusRates: Record\u003cVipLevel, number\u003e = { 1: 0.1, // VIP1: 10%åŠ æˆ 2: 0.2, // VIP2: 20%åŠ æˆ 3: 0.3 // VIP3: 30%åŠ æˆ }; return Math.floor(foodValue * bonusRates[this.vipLevel]); } generateRewards(pet: Pet, levelUpCount: number): Reward[] { if (levelUpCount === 0) return []; const rewards: Reward[] = []; // åŸºç¡€é‡‘å¸å¥–åŠ± rewards.push({ type: 'gold' as const, amount: 100 * levelUpCount, reason: 'å® ç‰©å‡çº§å¥–åŠ±' }); // VIPé¢å¤–å¥–åŠ± rewards.push({ type: 'diamond' as const, amount: 10 * levelUpCount * this.vipLevel, reason: 'VIPä¸“å±å‡çº§å¥–åŠ±' }); return rewards; } async afterFeed(pet: Pet, levelUpCount: number): Promise\u003cvoid\u003e { if (levelUpCount \u003e 0) { // VIPç©å®¶å‡çº§åå‘é€ç‰¹æ®Šé€šçŸ¥ console.log(`ğŸ‰ æ­å–œVIP${this.vipLevel}ç©å®¶ï¼Œå® ç‰©${pet.name}å‡çº§åˆ°${pet.getLevel()}çº§ï¼`); } } extendResult( result: FeedingResult\u003cVipFeedingExtensions\u003e, pet: Pet, context: FeedingContext ): void { // VIPç­–ç•¥æ·»åŠ VIPç‰¹æƒä¿¡æ¯ result.addExtension('vipLevel', this.vipLevel); result.addExtension('expBonus', context.expBonus); result.addExtension('bonusRate', `${(context.expBonus / context.foodValue * 100).toFixed(1)}%`); // è®¡ç®—VIPç‰¹æƒèŠ‚çœçš„æ—¶é—´ï¼ˆå‡è®¾ï¼‰ const savedFeeds = Math.floor(context.expBonus / context.foodValue); result.addExtension('vipPrivilege', { savedFeeds, message: `VIP${this.vipLevel}ç‰¹æƒä¸ºæ‚¨èŠ‚çœäº†${savedFeeds}æ¬¡å–‚å…»` }); } } 3. ä¼ è¯´å® ç‰©å–‚å…»ç­–ç•¥ // ä¼ è¯´å® ç‰©å–‚å…»ç­–ç•¥ class LegendaryFeedingStrategy extends BaseFeedingStrategy\u003cLegendaryFeedingResponse\u003e { private comboCount: number = 0; // è¿å‡»æ¬¡æ•° private lastFeedTime: number | null = null; constructor(private readonly eventManager: EventManager) { super(); } async beforeFeed(pet: Pet, foodValue: number): Promise\u003cboolean\u003e { // ä¼ è¯´å® ç‰©æ¯å¤©åªèƒ½å–‚å…»3æ¬¡ const feedCountToday = await this.getFeedCountToday(pet.id); if (feedCountToday \u003e= 3) { return false; } // è®¡ç®—è¿å‡» const now = Date.now(); if (this.lastFeedTime \u0026\u0026 now - this.lastFeedTime \u003c 5000) { this.comboCount++; } else { this.comboCount = 1; } this.lastFeedTime = now; return true; } calculateExpBonus(pet: Pet, foodValue: number): number { // è¿å‡»åŠ æˆï¼šæ¯è¿å‡»ä¸€æ¬¡å¢åŠ 20%ç»éªŒ const comboBonus = Math.floor(foodValue * 0.2 * (this.comboCount - 1)); // ä¼ è¯´å® ç‰©åŸºç¡€åŠ æˆ50% const legendaryBonus = Math.floor(foodValue * 0.5); return comboBonus + legendaryBonus; } generateRewards(pet: Pet, levelUpCount: number): Reward[] { if (levelUpCount === 0) return []; const rewards: Reward[] = []; // åŸºç¡€å¥–åŠ± rewards.push({ type: 'gold' as const, amount: 100 * levelUpCount, reason: 'å® ç‰©å‡çº§å¥–åŠ±' }); // ä¼ è¯´çº§å¤§é¢é’»çŸ³å¥–åŠ± rewards.push({ type: 'diamond' as const, amount: 50 * levelUpCount, reason: 'ä¼ è¯´å® ç‰©å‡çº§å¥–åŠ±' }); // è¿å‡»å¥–åŠ± if (this.comboCount \u003e= 3) { rewards.push({ type: 'special_item' as const, itemId: 'legendary_food', amount: 1, reason: `${this.comboCount}è¿å‡»ç‰¹æ®Šå¥–åŠ±` }); } // è§¦å‘ç¨€æœ‰äº‹ä»¶ï¼ˆæ¦‚ç‡ï¼‰ if (Math.random() \u003c 0.1) { rewards.push({ type: 'rare_event' as const, eventId: 'treasure_hunt', reason: 'è§¦å‘ä¼ è¯´äº‹ä»¶ï¼šå¯»å®ä¹‹æ—…' }); } return rewards; } async afterFeed(pet: Pet, levelUpCount: number): Promise\u003cvoid\u003e { // å‘å¸ƒä¼ è¯´å® ç‰©å–‚å…»äº‹ä»¶ï¼ˆä¾›å…¶ä»–ç³»ç»Ÿç›‘å¬ï¼‰ await this.eventManager.publish({ type: 'LegendaryPetFed', petId: pet.id, level: pet.getLevel(), comboCount: this.comboCount, timestamp: Date.now() }); if (levelUpCount \u003e 0) { console.log(`âš¡ ä¼ è¯´å® ç‰©${pet.name}å‡çº§ï¼å½“å‰${this.comboCount}è¿å‡»ï¼`); } } private async getFeedCountToday(petId: string): Promise\u003cnumber\u003e { // ä»ç¼“å­˜æˆ–æ•°æ®åº“è·å–ä»Šæ—¥å–‚å…»æ¬¡æ•° // è¿™é‡Œç®€åŒ–å¤„ç† return 0; } extendResult( result: FeedingResult\u003cLegendaryFeedingExtensions\u003e, pet: Pet, context: FeedingContext ): void { // ä¼ è¯´å® ç‰©æ·»åŠ ä¸°å¯Œçš„æ‰©å±•ä¿¡æ¯ // 1. è¿å‡»ç³»ç»Ÿä¿¡æ¯ const comboStatus: ComboStatus = this.comboCount \u003e= 3 ? 'AMAZING!' : this.comboCount \u003e= 2 ? 'GREAT!' : 'GOOD'; result.addExtension('comboInfo', { comboCount: this.comboCount, comboBonus: Math.floor(context.foodValue * 0.2 * (this.comboCount - 1)), nextComboAt: this.lastFeedTime! + 5000, comboStatus }); // 2. ä»Šæ—¥å‰©ä½™å–‚å…»æ¬¡æ•° result.addExtension('dailyLimit', { remaining: 2, // ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æŸ¥è¯¢ total: 3, resetAt: new Date().setHours(24, 0, 0, 0) }); // 3. ç‰¹æ®Šäº‹ä»¶è§¦å‘è®°å½• const specialRewards = result.rewards.filter(r =\u003e r.type === 'rare_event' || r.type === 'special_item' ); if (specialRewards.length \u003e 0) { result.addExtension('specialEvents', { triggered: true, events: specialRewards, message: 'âš¡ æ­å–œè§¦å‘ä¼ è¯´äº‹ä»¶ï¼' }); } // 4. ä¼ è¯´å® ç‰©ä¸“å±ç»Ÿè®¡ result.addExtension('legendaryStats', { totalBonus: context.expBonus, legendaryBonus: Math.floor(context.foodValue * 0.5), efficiency: `${((context.actualFoodValue / context.foodValue - 1) * 100).toFixed(0)}%`, rank: this.calculateRank(pet.getLevel()) }); } private calculateRank(level: number): PetRank { if (level \u003e= 50) return 'Sçº§ä¼ è¯´'; if (level \u003e= 30) return 'Açº§å²è¯—'; if (level \u003e= 20) return 'Bçº§ç¨€æœ‰'; return 'Cçº§æ™®é€š'; } } ä½¿ç”¨ç¤ºä¾‹ // æ ¹æ®ä¸åŒä¸šåŠ¡åœºæ™¯é€‰æ‹©ç­–ç•¥ // 1. æ™®é€šç©å®¶å–‚å…»ï¼ˆè¿”å›ç±»å‹ä¸º NormalFeedingResponseï¼‰ const normalService = new BasePetFeedingService\u003cNormalFeedingResponse\u003e( petRepository, new NormalFeedingStrategy() ); const result1: NormalFeedingResponse = await normalService.feedPet('pet-123', 100); console.log('æ™®é€šç©å®¶ç»“æœ:', result1); /* è¾“å‡º: { level: 5, exp: 50, expProgress: '50.00%', hp: 150, attack: 75, levelUpCount: 1, rewards: [{ type: 'gold', amount: 100, reason: 'å® ç‰©å‡çº§å¥–åŠ±' }], feedCount: 1, totalExpGained: 100 } */ // 2. VIPç©å®¶å–‚å…»ï¼ˆè¿”å›ç±»å‹ä¸º VipFeedingResponseï¼‰ const vipService = new BasePetFeedingService\u003cVipFeedingResponse\u003e( petRepository, new VipFeedingStrategy(2) // VIPç­‰çº§2 ); const result2: VipFeedingResponse = await vipService.feedPet('pet-456', 100); console.log('VIPç©å®¶ç»“æœ:', result2); /* è¾“å‡º: { level: 5, exp: 70, expProgress: '70.00%', hp: 150, attack: 75, levelUpCount: 1, rewards: [ { type: 'gold', amount: 100, reason: 'å® ç‰©å‡çº§å¥–åŠ±' }, { type: 'diamond', amount: 20, reason: 'VIPä¸“å±å‡çº§å¥–åŠ±' } ], vipLevel: 2, expBonus: 20, bonusRate: '20.0%', vipPrivilege: { savedFeeds: 0, message: 'VIP2ç‰¹æƒä¸ºæ‚¨èŠ‚çœäº†0æ¬¡å–‚å…»' } } */ // 3. ä¼ è¯´å® ç‰©å–‚å…»ï¼ˆè¿å‡»3æ¬¡ï¼Œè¿”å›ç±»å‹ä¸º LegendaryFeedingResponseï¼‰ const legendaryService = new BasePetFeedingService\u003cLegendaryFeedingResponse\u003e( petRepository, new LegendaryFeedingStrategy(eventManager) ); const result3: LegendaryFeedingResponse = await legendaryService.feedPet('pet-789', 100); console.log('ä¼ è¯´å® ç‰©ç»“æœ:', result3); /* è¾“å‡º: { level: 6, exp: 100, expProgress: '83.33%', hp: 180, attack: 90, levelUpCount: 1, rewards: [ { type: 'gold', amount: 100, reason: 'å® ç‰©å‡çº§å¥–åŠ±' }, { type: 'diamond', amount: 50, reason: 'ä¼ è¯´å® ç‰©å‡çº§å¥–åŠ±' }, { type: 'special_item', itemId: 'legendary_food', amount: 1, reason: '3è¿å‡»ç‰¹æ®Šå¥–åŠ±' } ], comboInfo: { comboCount: 3, comboBonus: 40, nextComboAt: 1696852345000, comboStatus: 'AMAZING!' }, dailyLimit: { remaining: 2, total: 3, resetAt: 1696867200000 }, specialEvents: { triggered: true, events: [ { type: 'special_item', itemId: 'legendary_food', amount: 1, reason: '3è¿å‡»ç‰¹æ®Šå¥–åŠ±' } ], message: 'âš¡ æ­å–œè§¦å‘ä¼ è¯´äº‹ä»¶ï¼' }, legendaryStats: { totalBonus: 90, legendaryBonus: 50, efficiency: '90%', rank: 'Cçº§æ™®é€š' } } */ æ‰©å±•ç‚¹æ¨¡å¼çš„ä¼˜åŠ¿ å¼€é—­åŸåˆ™ï¼š\næ ¸å¿ƒæµç¨‹ï¼ˆfeedPetæ–¹æ³•ï¼‰ä¿æŒç¨³å®š,æ— éœ€ä¿®æ”¹ æ–°å¢ä¸šåŠ¡ç±»å‹åªéœ€å®ç°æ–°çš„ç­–ç•¥ç±» èŒè´£æ¸…æ™°ï¼š\nBasePetFeedingServiceï¼šè´Ÿè´£æµç¨‹ç¼–æ’ ç­–ç•¥ç±»ï¼šè´Ÿè´£å…·ä½“ä¸šåŠ¡é€»è¾‘ é¢†åŸŸæ¨¡å‹ï¼šè´Ÿè´£æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ FeedingResultï¼šè´Ÿè´£ç»“æ„åŒ–è¿”å›æ•°æ® è¿”å›ç»“æœå¯æ‰©å±•ï¼š\nå®šä¹‰äº†ç»Ÿä¸€çš„ FeedingResult æ¥å£ æ¯ä¸ªç­–ç•¥å¯ä»¥é€šè¿‡ extendResult æ·»åŠ è‡ªå·±çš„æ‰©å±•å­—æ®µ å®¢æˆ·ç«¯è·å¾—å®Œæ•´ä¸”ç±»å‹å®‰å…¨çš„å“åº”æ•°æ® é¿å…äº†è¿”å›ç»“æœçš„\"ä¸Šå¸å¯¹è±¡\"é—®é¢˜ æ˜“äºæµ‹è¯•ï¼š\n// å¯ä»¥è½»æ¾mockç­–ç•¥è¿›è¡Œæµ‹è¯• test('å–‚å…»æµç¨‹åº”è¯¥è°ƒç”¨æ‰€æœ‰æ‰©å±•ç‚¹', async () =\u003e { const mockStrategy = { beforeFeed: jest.fn().mockResolvedValue(true), calculateExpBonus: jest.fn().mockReturnValue(50), generateRewards: jest.fn().mockReturnValue([]), afterFeed: jest.fn() }; const service = new BasePetFeedingService(mockRepo, mockStrategy); await service.feedPet('pet-1', 100); expect(mockStrategy.beforeFeed).toHaveBeenCalled(); expect(mockStrategy.calculateExpBonus).toHaveBeenCalled(); expect(mockStrategy.generateRewards).toHaveBeenCalled(); expect(mockStrategy.afterFeed).toHaveBeenCalled(); }); çµæ´»ç»„åˆï¼š\n// å¯ä»¥é€šè¿‡ç»„åˆæ¨¡å¼æ”¯æŒå¤šç§ç­–ç•¥å åŠ  class CompositeStrategy extends IFeedingStrategy { constructor(strategies) { super(); this.strategies = strategies; } calculateExpBonus(pet, foodValue) { return this.strategies.reduce( (total, strategy) =\u003e total + strategy.calculateExpBonus(pet, foodValue), 0 ); } async afterFeed(pet, levelUpCount) { for (const strategy of this.strategies) { await strategy.afterFeed(pet, levelUpCount); } } } // åŒæ—¶åº”ç”¨VIPå’ŒèŠ‚æ—¥åŒå€ç»éªŒ const compositeService = new BasePetFeedingService( petRepository, new CompositeStrategy([ new VipFeedingStrategy(3), new HolidayBonusStrategy() ]) ); è¿è¡Œæ—¶åˆ‡æ¢ï¼š\n// å¯ä»¥æ ¹æ®è¿è¡Œæ—¶æ¡ä»¶åŠ¨æ€é€‰æ‹©ç­–ç•¥ function createFeedingService(user, pet) { let strategy; if (pet.quality === 'legendary') { strategy = new LegendaryFeedingStrategy(eventManager); } else if (user.vipLevel \u003e 0) { strategy = new VipFeedingStrategy(user.vipLevel); } else { strategy = new NormalFeedingStrategy(); } return new BasePetFeedingService(petRepository, strategy); } æ¶æ„ç¤ºæ„å›¾ classDiagram class BasePetFeedingService { -petRepository -feedingStrategy +feedPet(petId, foodValue) } class IFeedingStrategy { \u003c\u003e +calculateExpBonus(pet, foodValue) +beforeFeed(pet, foodValue) +afterFeed(pet, levelUpCount) +generateRewards(pet, levelUpCount) } class NormalFeedingStrategy { +calculateExpBonus() +generateRewards() } class VipFeedingStrategy { -vipLevel +calculateExpBonus() +generateRewards() +afterFeed() } class LegendaryFeedingStrategy { -eventManager -comboCount +beforeFeed() +calculateExpBonus() +generateRewards() +afterFeed() } BasePetFeedingService --\u003e IFeedingStrategy : ä¾èµ– IFeedingStrategy \u003c|.. NormalFeedingStrategy : å®ç° IFeedingStrategy \u003c|.. VipFeedingStrategy : å®ç° IFeedingStrategy \u003c|.. LegendaryFeedingStrategy : å®ç° é€šè¿‡è¿™ç§æ‰©å±•ç‚¹è®¾è®¡,æˆ‘ä»¬å®ç°äº†ï¼š\nç»Ÿä¸€æµç¨‹ï¼šæ‰€æœ‰å® ç‰©å–‚å…»éƒ½éµå¾ªç›¸åŒçš„æµç¨‹éª¨æ¶ å·®å¼‚åŒ–å®šåˆ¶ï¼šä¸åŒä¸šåŠ¡åœºæ™¯å¯ä»¥å®šåˆ¶è‡ªå·±çš„é€»è¾‘ è§£è€¦æ‰©å±•ï¼šæ–°å¢ä¸šåŠ¡ç±»å‹ä¸å½±å“ç°æœ‰ä»£ç  ä¾¿äºç»´æŠ¤ï¼šæ¯ä¸ªç­–ç•¥èŒè´£å•ä¸€,æ˜“äºç†è§£å’Œä¿®æ”¹ è¿™æ­£æ˜¯ DDD ä¸­\"å°†å¯å˜çš„ä¸šåŠ¡é€»è¾‘ä¸ç¨³å®šçš„æµç¨‹åˆ†ç¦»\"çš„æœ€ä½³å®è·µã€‚\né¡¹ç›®ç»“æ„ ç›®å½•ç»“æ„\nbase ä¸­åŒ…å«åŸºç¡€è®¾æ–½ï¼ˆinfrastructureï¼‰å’ŒåŠŸèƒ½ç»„ä»¶ï¼ˆcomponentï¼‰å’Œéª¨æ¶å®ç°ï¼ˆskeletonï¼‰\nåŸºç¡€è®¾æ–½ä¸»è¦æŒ‡çš„æ˜¯ä¸€äº›äºŒä¸‰æ–¹çš„ä¾èµ–çš„å°è£…ï¼Œé€šè¿‡å†…éƒ¨APIçš„å½¢å¼è¿›è¡Œæä¾› åŠŸèƒ½ç»„ä»¶å°±æ˜¯ä¸€äº›ç›¸å¯¹å®Œæ•´ï¼Œç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å— éª¨æ¶å®ç°ä¸€èˆ¬æ˜¯ä¸€äº›åŠŸèƒ½æ¥ç»´åº¦çš„é€šç”¨éª¨æ¶é€»è¾‘å®ç°ï¼ŒåŒ…å«æ¥å£è¯·æ±‚æ¥çš„å‚æ•°æ ¡éªŒã€æ ¸å¿ƒå¤„ç†ã€ç»“æ„å°è£…è¿”å›ç­‰ sdk æ˜¯æ¥å£å®šä¹‰å’Œå¥‘çº¦å±‚ï¼Œbase ä¸­é’ˆå¯¹SDK ä¸­å®šä¹‰çš„æ¥å£è¿›è¡Œå®ç°ï¼Œsdk ä¸­ä¸»è¦åŒ…å«ç³»ç»Ÿçš„æ‰€æœ‰æ¥å£ã€ç­–ç•¥æ‰©å±•ç‚¹ã€æ•°æ®æ¨¡å‹ã€å¸¸é‡å’Œå·¥å…·ç±»\nmodule åˆ™æ˜¯å…·ä½“çš„æ¸¸æˆä¸šåŠ¡å®ç°ï¼Œä¼šå¼•ç”¨SDKï¼Œä½†æ˜¯ä¸ç›´æ¥å¼•ç”¨baseï¼Œå®Œæˆå…·ä½“çš„ç­–ç•¥æ‰©å±•ç‚¹çš„é‡å†™ï¼Œä»è€Œå®ç°å®šåˆ¶åŒ–çš„ä¸šåŠ¡åŠŸèƒ½\n. â”œâ”€â”€ base â”‚ â”œâ”€â”€ component â”‚ â”œâ”€â”€ infrastructure â”‚ â””â”€â”€ skeleton â”œâ”€â”€ sdk â””â”€â”€ module â””â”€â”€ gameBusiness ä¾èµ–å…³ç³»å›¾\nflowchart TB subgraph subGraph0[\"ä¸šåŠ¡æ¨¡å—å±‚ (module)\"] PM[\"promotion-module\"] P618[\"promotion618\"] P1111[\"promotion1111\"] end subgraph subGraph1[\"SDKå±‚ (sdk)\"] SDK[\"sdk\"] SDK_COMMON[\"sdk/common\"] SDK_COMPONENT[\"sdk/component\"] SDK_INFRA[\"sdk/infrastructure\"] SDK_SKELETON[\"sdk/skeleton\"] end subgraph subGraph2[\"åŸºç¡€å®ç°å±‚ (base)\"] BASE[\"base\"] BASE_INFRA[\"infrastructure\"] BASE_COMPONENT[\"component\"] BASE_SKELETON[\"skeleton\"] BASE_DRAW[\"draw\"] BASE_PET[\"pet\"] end PM --\u003e P618 \u0026 P1111 SDK --\u003e SDK_COMMON \u0026 SDK_COMPONENT \u0026 SDK_INFRA \u0026 SDK_SKELETON BASE --\u003e BASE_INFRA \u0026 BASE_COMPONENT \u0026 BASE_SKELETON BASE_COMPONENT --\u003e BASE_DRAW BASE_SKELETON --\u003e BASE_PET PM -. ä¾èµ– .-\u003e SDK P618 -. ä¾èµ– .-\u003e SDK P1111 -. ä¾èµ– .-\u003e SDK BASE_INFRA -. ä¾èµ– .-\u003e SDK BASE_COMPONENT -. ä¾èµ– .-\u003e SDK \u0026 BASE_INFRA BASE_SKELETON -. ä¾èµ– .-\u003e SDK \u0026 BASE_INFRA DDDæ–¹å¼çš„ä¼˜åŠ¿ é€šè¿‡ä¸Šé¢çš„å¯¹æ¯”å¯ä»¥çœ‹åˆ°ï¼š\nä¸šåŠ¡é€»è¾‘å†…èšï¼š\nç»éªŒè®¡ç®—ã€å‡çº§åˆ¤æ–­ã€å±æ€§æå‡éƒ½å°è£…åœ¨å¯¹åº”çš„é¢†åŸŸå¯¹è±¡ä¸­ Serviceå±‚å˜å¾—éå¸¸è–„ï¼Œåªè´Ÿè´£ç¼–æ’ æ˜“äºæµ‹è¯•ï¼š\n// å•å…ƒæµ‹è¯•ä¸éœ€è¦æ•°æ®åº“ test('å® ç‰©å–‚å…»ååº”è¯¥è·å¾—ç»éªŒ', () =\u003e { const pet = new Pet( '1', 'Pikachu', 'rare', new Experience(0, 1, 'rare'), new PetStats(100, 50, 1, 'rare') ); pet.feed(100); expect(pet.experience.current).toBe(100); }); test('å²è¯—å® ç‰©å‡çº§æ‰€éœ€ç»éªŒæ›´å¤š', () =\u003e { const exp1 = new Experience(0, 1, 'common'); const exp2 = new Experience(0, 1, 'epic'); expect(exp2.getRequiredForNextLevel()) .toBeGreaterThan(exp1.getRequiredForNextLevel()); }); ä¸šåŠ¡è§„åˆ™æ¸…æ™°å¯è§ï¼š\nä»£ç ç›´æ¥è¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µï¼špet.feed(), experience.canLevelUp() æ–°äººå¯ä»¥é€šè¿‡é˜…è¯»é¢†åŸŸæ¨¡å‹å¿«é€Ÿç†è§£ä¸šåŠ¡ æ˜“äºæ‰©å±•ï¼š\næ·»åŠ æ–°å“è´¨çš„å® ç‰©ï¼Ÿåªéœ€ä¿®æ”¹å€¼å¯¹è±¡ä¸­çš„é…ç½® ä¿®æ”¹å‡çº§å…¬å¼ï¼Ÿåªåœ¨Experienceä¸­ä¿®æ”¹ æ·»åŠ æ–°çš„å® ç‰©è¡Œä¸ºï¼Ÿåœ¨Petå®ä½“ä¸­æ·»åŠ æ–¹æ³• äº‹ä»¶é©±åŠ¨ï¼š\né€šè¿‡é¢†åŸŸäº‹ä»¶è§£è€¦å‰¯ä½œç”¨ï¼ˆé€šçŸ¥ã€æ—¥å¿—ã€ç»Ÿè®¡ç­‰ï¼‰ ä¾¿äºå®ç°å¤æ‚çš„ä¸šåŠ¡æµç¨‹ çŠ¶æ€ä¸€è‡´æ€§ï¼š\nèšåˆæ ¹ä¿è¯å® ç‰©çŠ¶æ€çš„ä¸€è‡´æ€§ ä¸ä¼šå‡ºç°\"ç»éªŒå·²æ‰£é™¤ä½†ç­‰çº§æœªæå‡\"çš„æƒ…å†µ NodeJSä¸Šç°æœ‰çš„å®ç° white-labelæ˜¯åŸºäºæºç çº§åˆ«çš„ Domain-Driven Design Demoï¼Œæœ‰éå¸¸é«˜çš„å‚è€ƒæ€§\ntype-ddd è¿™ä¸ªæ˜¯NodeJSä¸­é’ˆå¯¹æ˜¯ Domain-Driven Design çš„ä¸€ä¸ªå°è£…ï¼Œä¸»è¦æ˜¯æä¾›utilsã€ Entityã€Value Objectsã€Factoriesã€Aggregatesã€Repositoryã€Domain eventsç­‰æ¥å»ºç«‹å¤æ‚çš„åº”ç”¨ï¼Œå¯ä»¥çœ‹ä¸‹é¡¹ç›®çš„ README æœ‰æœ€åŸºæœ¬çš„ç”¨æ³•ç¤ºä¾‹\né’ˆå¯¹è¿™ä¸¤ä¸ªé¡¹ç›®ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ white-labelï¼Œä¹‹åå®è·µè¿‡ç¨‹ä¸­åˆ™å¯ä»¥ä½¿ç”¨ type-ddd è¿›è¡Œå…·ä½“çš„ç¼–ç å®ç°\nå‚è€ƒèµ„æ–™ DDDä¸­ç±»å‹æ¥å£ï¼šhttps://github.com/4lessandrodev/type-ddd DDDæ•™ç¨‹ï¼šhttps://github.com/stemmlerjs/ddd-forum NodeJS ä¸­çš„ç¤ºä¾‹ï¼š https://github.com/stemmlerjs/white-label Rich-Domain:https://github.com/4lessandrodev/rich-domain ","wordCount":"3020","inLanguage":"en","datePublished":"2025-09-01T10:16:15+08:00","dateModified":"2025-09-01T10:16:15+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://genluo.github.io/my-blog/posts/ddd/"},"publisher":{"@type":"Organization","name":"Genluo","logo":{"@type":"ImageObject","url":"https://genluo.github.io/my-blog/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://genluo.github.io/my-blog/ accesskey=h title="Genluo (Alt + H)">Genluo</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://genluo.github.io/my-blog/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://genluo.github.io/my-blog/search/ title="æœç´¢ (Alt + /)" accesskey=/><span>æœç´¢</span></a></li><li><a href=https://genluo.github.io/my-blog/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://genluo.github.io/my-blog/about/ title=å…³äº><span>å…³äº</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://genluo.github.io/my-blog/>Home</a>&nbsp;Â»&nbsp;<a href=https://genluo.github.io/my-blog/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">é¢†åŸŸé©±åŠ¨è®¾è®¡</h1><div class=post-description>æœåŠ¡ç«¯ä¸­çš„é¢†åŸŸé©±åŠ¨è®¾è®¡çš„åº”ç”¨åŠå…¶è§£æ</div><div class=post-meta><span title='2025-09-01 10:16:15 +0800 +0800'>September 1, 2025</span>&nbsp;Â·&nbsp;<span>15 min</span>&nbsp;Â·&nbsp;<span>3020 words</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%a5%91%e6%9c%ba aria-label=å¥‘æœº>å¥‘æœº</a></li><li><a href=#ddd aria-label=DDD>DDD</a><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%af%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1domain-driving-design aria-label="ä»€ä¹ˆæ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆdomain driving designï¼‰">ä»€ä¹ˆæ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆdomain driving designï¼‰</a><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%af%e8%81%9a%e5%90%88%e6%a0%b9 aria-label=ä»€ä¹ˆæ˜¯èšåˆæ ¹>ä»€ä¹ˆæ˜¯èšåˆæ ¹</a></li></ul></li><li><a href=#%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1%e4%bc%98%e7%bc%ba%e7%82%b9 aria-label=é¢†åŸŸé©±åŠ¨è®¾è®¡ä¼˜ç¼ºç‚¹>é¢†åŸŸé©±åŠ¨è®¾è®¡ä¼˜ç¼ºç‚¹</a><ul><li><a href=#%e4%bc%98%e7%82%b9 aria-label=ä¼˜ç‚¹>ä¼˜ç‚¹</a></li><li><a href=#%e7%bc%ba%e7%82%b9 aria-label=ç¼ºç‚¹>ç¼ºç‚¹</a></li></ul></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e9%a2%86%e5%9f%9f%e6%a8%a1%e5%9e%8b aria-label=ä¸ºä»€ä¹ˆéœ€è¦é¢†åŸŸæ¨¡å‹>ä¸ºä»€ä¹ˆéœ€è¦é¢†åŸŸæ¨¡å‹</a><ul><li><a href=#1-%e8%b4%ab%e8%a1%80%e6%a8%a1%e5%9e%8b%e7%9a%84%e5%9b%b0%e5%a2%83 aria-label="1. è´«è¡€æ¨¡å‹çš„å›°å¢ƒ">1. è´«è¡€æ¨¡å‹çš„å›°å¢ƒ</a></li><li><a href=#2-%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91%e6%95%a3%e4%b9%b1 aria-label="2. ä¸šåŠ¡é€»è¾‘æ•£ä¹±">2. ä¸šåŠ¡é€»è¾‘æ•£ä¹±</a></li><li><a href=#3-%e6%8a%80%e6%9c%af%e4%b8%8e%e4%b8%9a%e5%8a%a1%e8%84%b1%e8%8a%82 aria-label="3. æŠ€æœ¯ä¸ä¸šåŠ¡è„±èŠ‚">3. æŠ€æœ¯ä¸ä¸šåŠ¡è„±èŠ‚</a></li><li><a href=#%e9%a2%86%e5%9f%9f%e6%a8%a1%e5%9e%8b%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e8%bf%99%e4%ba%9b%e9%97%ae%e9%a2%98 aria-label=é¢†åŸŸæ¨¡å‹å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜>é¢†åŸŸæ¨¡å‹å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜</a><ul><li><a href=#1-%e5%b0%81%e8%a3%85%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91 aria-label="1. å°è£…ä¸šåŠ¡é€»è¾‘">1. å°è£…ä¸šåŠ¡é€»è¾‘</a></li><li><a href=#2-%e7%bb%9f%e4%b8%80%e8%af%ad%e8%a8%80ubiquitous-language aria-label="2. ç»Ÿä¸€è¯­è¨€ï¼ˆUbiquitous Languageï¼‰">2. ç»Ÿä¸€è¯­è¨€ï¼ˆUbiquitous Languageï¼‰</a></li><li><a href=#3-%e7%bb%b4%e6%8a%a4%e4%b8%9a%e5%8a%a1%e4%b8%8d%e5%8f%98%e6%80%a7invariants aria-label="3. ç»´æŠ¤ä¸šåŠ¡ä¸å˜æ€§ï¼ˆInvariantsï¼‰">3. ç»´æŠ¤ä¸šåŠ¡ä¸å˜æ€§ï¼ˆInvariantsï¼‰</a></li><li><a href=#4-%e9%99%8d%e4%bd%8e%e8%ae%a4%e7%9f%a5%e8%b4%9f%e6%8b%85 aria-label="4. é™ä½è®¤çŸ¥è´Ÿæ‹…">4. é™ä½è®¤çŸ¥è´Ÿæ‹…</a></li></ul></li><li><a href=#%e5%ae%9e%e8%b7%b5%e4%bb%b7%e5%80%bc aria-label=å®è·µä»·å€¼>å®è·µä»·å€¼</a></li></ul></li><li><a href=#%e4%b8%be%e4%be%8b aria-label=ä¸¾ä¾‹>ä¸¾ä¾‹</a><ul><li><a href=#%e4%b8%9a%e5%8a%a1%e5%9c%ba%e6%99%af aria-label=ä¸šåŠ¡åœºæ™¯>ä¸šåŠ¡åœºæ™¯</a></li><li><a href=#%e4%b8%9a%e5%8a%a1%e6%b5%81%e7%a8%8b%e5%9b%be aria-label=ä¸šåŠ¡æµç¨‹å›¾>ä¸šåŠ¡æµç¨‹å›¾</a></li><li><a href=#%e4%bc%a0%e7%bb%9f%e5%ae%9e%e7%8e%b0%e6%96%b9%e5%bc%8f aria-label=ä¼ ç»Ÿå®ç°æ–¹å¼>ä¼ ç»Ÿå®ç°æ–¹å¼</a></li><li><a href=#ddd%e5%ae%9e%e7%8e%b0%e6%96%b9%e5%bc%8f aria-label=DDDå®ç°æ–¹å¼>DDDå®ç°æ–¹å¼</a><ul><li><a href=#1-%e5%80%bc%e5%af%b9%e8%b1%a1value-object--%e7%bb%8f%e9%aa%8c%e5%80%bc aria-label="1. å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰- ç»éªŒå€¼">1. å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰- ç»éªŒå€¼</a></li><li><a href=#2-%e5%80%bc%e5%af%b9%e8%b1%a1---%e5%ae%a0%e7%89%a9%e5%b1%9e%e6%80%a7 aria-label="2. å€¼å¯¹è±¡ - å® ç‰©å±æ€§">2. å€¼å¯¹è±¡ - å® ç‰©å±æ€§</a></li><li><a href=#3-%e9%a2%86%e5%9f%9f%e4%ba%8b%e4%bb%b6 aria-label="3. é¢†åŸŸäº‹ä»¶">3. é¢†åŸŸäº‹ä»¶</a></li><li><a href=#4-%e5%ae%9e%e4%bd%93%e8%81%9a%e5%90%88%e6%a0%b9---%e5%ae%a0%e7%89%a9 aria-label="4. å®ä½“/èšåˆæ ¹ - å® ç‰©">4. å®ä½“/èšåˆæ ¹ - å® ç‰©</a></li><li><a href=#5-%e4%bb%93%e5%82%a8%e6%8e%a5%e5%8f%a3 aria-label="5. ä»“å‚¨æ¥å£">5. ä»“å‚¨æ¥å£</a></li><li><a href=#6-%e5%ba%94%e7%94%a8%e6%9c%8d%e5%8a%a1%e7%ae%80%e6%b4%81%e7%9a%84%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91%e7%bc%96%e6%8e%92%e5%b1%82 aria-label="6. åº”ç”¨æœåŠ¡ï¼ˆç®€æ´çš„ä¸šåŠ¡é€»è¾‘ç¼–æ’å±‚ï¼‰">6. åº”ç”¨æœåŠ¡ï¼ˆç®€æ´çš„ä¸šåŠ¡é€»è¾‘ç¼–æ’å±‚ï¼‰</a></li><li><a href=#7-%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b aria-label="7. ä½¿ç”¨ç¤ºä¾‹">7. ä½¿ç”¨ç¤ºä¾‹</a></li></ul></li><li><a href=#%e6%9b%b4%e8%bf%9b%e4%b8%80%e6%ad%a5 aria-label=æ›´è¿›ä¸€æ­¥>æ›´è¿›ä¸€æ­¥</a><ul><li><a href=#%e4%b8%9a%e5%8a%a1%e5%9c%ba%e6%99%af%e6%89%a9%e5%b1%95 aria-label=ä¸šåŠ¡åœºæ™¯æ‰©å±•>ä¸šåŠ¡åœºæ™¯æ‰©å±•</a></li><li><a href=#%e5%ae%8c%e6%95%b4%e7%b1%bb%e5%9e%8b%e5%ae%9a%e4%b9%89 aria-label=å®Œæ•´ç±»å‹å®šä¹‰>å®Œæ•´ç±»å‹å®šä¹‰</a></li><li><a href=#%e8%bf%94%e5%9b%9e%e7%bb%93%e6%9e%9c%e5%b0%81%e8%a3%85%e7%b1%bb aria-label=è¿”å›ç»“æœå°è£…ç±»>è¿”å›ç»“æœå°è£…ç±»</a></li><li><a href=#%e7%ad%96%e7%95%a5%e6%8e%a5%e5%8f%a3%e5%ae%9a%e4%b9%89 aria-label=ç­–ç•¥æ¥å£å®šä¹‰>ç­–ç•¥æ¥å£å®šä¹‰</a></li><li><a href=#%e5%ba%94%e7%94%a8%e6%9c%8d%e5%8a%a1%e6%a8%a1%e6%9d%bf%e6%96%b9%e6%b3%95 aria-label=åº”ç”¨æœåŠ¡ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰>åº”ç”¨æœåŠ¡ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰</a></li><li><a href=#%e4%b8%9a%e5%8a%a1%e5%ae%9e%e7%8e%b0%e6%89%a9%e5%b1%95%e7%82%b9 aria-label=ä¸šåŠ¡å®ç°æ‰©å±•ç‚¹>ä¸šåŠ¡å®ç°æ‰©å±•ç‚¹</a><ul><li><a href=#1-%e6%99%ae%e9%80%9a%e5%ae%a0%e7%89%a9%e5%96%82%e5%85%bb%e7%ad%96%e7%95%a5 aria-label="1. æ™®é€šå® ç‰©å–‚å…»ç­–ç•¥">1. æ™®é€šå® ç‰©å–‚å…»ç­–ç•¥</a></li><li><a href=#2-vip%e5%ae%a0%e7%89%a9%e5%96%82%e5%85%bb%e7%ad%96%e7%95%a5 aria-label="2. VIPå® ç‰©å–‚å…»ç­–ç•¥">2. VIPå® ç‰©å–‚å…»ç­–ç•¥</a></li><li><a href=#3-%e4%bc%a0%e8%af%b4%e5%ae%a0%e7%89%a9%e5%96%82%e5%85%bb%e7%ad%96%e7%95%a5 aria-label="3. ä¼ è¯´å® ç‰©å–‚å…»ç­–ç•¥">3. ä¼ è¯´å® ç‰©å–‚å…»ç­–ç•¥</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b aria-label=ä½¿ç”¨ç¤ºä¾‹>ä½¿ç”¨ç¤ºä¾‹</a></li><li><a href=#%e6%89%a9%e5%b1%95%e7%82%b9%e6%a8%a1%e5%bc%8f%e7%9a%84%e4%bc%98%e5%8a%bf aria-label=æ‰©å±•ç‚¹æ¨¡å¼çš„ä¼˜åŠ¿>æ‰©å±•ç‚¹æ¨¡å¼çš„ä¼˜åŠ¿</a></li><li><a href=#%e6%9e%b6%e6%9e%84%e7%a4%ba%e6%84%8f%e5%9b%be aria-label=æ¶æ„ç¤ºæ„å›¾>æ¶æ„ç¤ºæ„å›¾</a></li><li><a href=#%e9%a1%b9%e7%9b%ae%e7%bb%93%e6%9e%84 aria-label=é¡¹ç›®ç»“æ„>é¡¹ç›®ç»“æ„</a></li></ul></li><li><a href=#ddd%e6%96%b9%e5%bc%8f%e7%9a%84%e4%bc%98%e5%8a%bf aria-label=DDDæ–¹å¼çš„ä¼˜åŠ¿>DDDæ–¹å¼çš„ä¼˜åŠ¿</a></li></ul></li></ul></li><li><a href=#nodejs%e4%b8%8a%e7%8e%b0%e6%9c%89%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=NodeJSä¸Šç°æœ‰çš„å®ç°>NodeJSä¸Šç°æœ‰çš„å®ç°</a></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=å‚è€ƒèµ„æ–™>å‚è€ƒèµ„æ–™</a></li></ul></div></details></div><div class=post-content><h2 id=å¥‘æœº>å¥‘æœº<a hidden class=anchor aria-hidden=true href=#å¥‘æœº>#</a></h2><p>æœ€è¿‘å› ä¸ºä¸€äº›å¥‘æœºçœ‹äº†ä¸‹äº’åŠ¨å°æ¸¸æˆçš„æœåŠ¡ç«¯ï¼Œæ·±å…¥äº†è§£äº†ä¸‹ç°åœ¨äº’åŠ¨æ¸¸æˆæœåŠ¡ç«¯çš„æ¶æ„ï¼ŒåŒæ—¶ä¹Ÿå°è¯•åœ¨è¿™ä¸ªæ¶æ„çš„åŸºç¡€ä¸Šä½¿ç”¨ AI è¿›è¡Œä¸€äº›æ¸¸æˆä¸šåŠ¡åŠŸèƒ½å¼€å‘ï¼Œå…¶ä¸­å°è±¡æœ€æ·±çš„æœåŠ¡ç«¯çš„ä¸€ä¸ªç§°ä¹‹ä¸ºåŸºåº§çš„æ¶æ„è®¾è®¡ï¼Œè¿™ä¸ªåŸºåº§æ¶æ„æ·±åº¦ä½¿ç”¨ <code>DDD</code> é¢†åŸŸè®¾è®¡æ€æƒ³è¿›è¡ŒæŠ½è±¡å®ç°ï¼Œåœ¨æ¸¸æˆä¸šåŠ¡éå¸¸çµæ´»ï¼Œå¤ç”¨æ€§éå¸¸é«˜ï¼Œæ‰€ä»¥æƒ³çœ‹ä¸‹åœ¨<code>NodeJS</code> ä¸­é’ˆå¯¹ <code>DDD</code>é¢†åŸŸé©±åŠ¨è®¾è®¡æ˜¯å¦æœ‰ä¸€å®šçš„å®è·µã€‚ä¸‹é¢ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ä¸ºä»€ä¹ˆæ˜¯<code>DDD</code>ï¼Ÿå¦ä¸€ä¸ª <code>NodeJS</code>ä¸­ä¸€äº›å®è·µ</p><h2 id=ddd><code>DDD</code><a hidden class=anchor aria-hidden=true href=#ddd>#</a></h2><h3 id=ä»€ä¹ˆæ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡domain-driving-design>ä»€ä¹ˆæ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆdomain driving designï¼‰<a hidden class=anchor aria-hidden=true href=#ä»€ä¹ˆæ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡domain-driving-design>#</a></h3><p>é¢†åŸŸé©±åŠ¨è®¾è®¡æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ–¹æ³•ï¼Œç”¨äºè¡¨ç¤ºå’Œç»„ç»‡ç‰¹å®šé¢†åŸŸä¸­çš„çŸ¥è¯†å’Œä¸šåŠ¡é€»è¾‘ã€‚å®ƒä¸»è¦é€šè¿‡åˆ›å»ºæŠ½è±¡çš„æ¨¡å‹å¯¹è±¡æ¥æ¨¡æ‹Ÿç°å®ä¸–ç•Œçš„å®ä½“åŠå…¶å…³ç³»ï¼Œå¸®åŠ©å¼€å‘äººå‘˜ç†è§£å’Œå®ç°å¤æ‚ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘ã€‚åœ¨é¢†åŸŸé©±åŠ¨è®¾è®¡ä¸­ï¼Œé€šå¸¸ä¼šåŒ…å«ä»¥ä¸‹å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><ol><li><p><strong>å®ä½“ï¼ˆEntityï¼‰</strong>ï¼šå…·æœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œé€šå¸¸è¡¨ç¤ºä¸šåŠ¡ä¸­çš„ä¸€ä¸ªç‹¬ç«‹çš„æ¦‚å¿µæˆ–å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªè®¢å•ç³»ç»Ÿä¸­ï¼Œè®¢å•å’Œå®¢æˆ·å¯ä»¥è¢«è§†ä¸ºå®ä½“ã€‚</p></li><li><p><strong>å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰</strong>ï¼šæ²¡æœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œé€šå¸¸ç”¨äºæè¿°æŸä¸ªå®ä½“çš„å±æ€§æˆ–ç»†èŠ‚ã€‚å®ƒä»¬æ˜¯ä¸å¯å˜çš„ï¼Œä¸¤ä¸ªå€¼å¯¹è±¡å¦‚æœå…·æœ‰ç›¸åŒçš„å±æ€§å€¼ï¼Œåˆ™è®¤ä¸ºæ˜¯ç›¸ç­‰çš„ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåœ°å€å¯ä»¥ä½œä¸ºä¸€ä¸ªå€¼å¯¹è±¡ã€‚</p></li><li><p><strong>èšåˆï¼ˆAggregateï¼‰</strong>ï¼šä¸€ç»„ç›¸å…³çš„å¯¹è±¡ï¼ˆå®ä½“å’Œå€¼å¯¹è±¡ï¼‰çš„é›†åˆï¼Œå®ƒä»¬è¢«è§†ä¸ºä¸€ä¸ªå•å…ƒè¿›è¡Œæ•°æ®ä¿®æ”¹ã€‚èšåˆæœ‰ä¸€ä¸ªæ ¹å®ä½“ï¼ˆAggregate Rootï¼‰ï¼Œé€šè¿‡æ ¹å®ä½“æ¥ç®¡ç†èšåˆçš„ç”Ÿå‘½å‘¨æœŸã€‚</p></li><li><p><strong>é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰</strong>ï¼šå°è£…é¢†åŸŸé€»è¾‘çš„æ“ä½œï¼Œè¿™äº›æ“ä½œä¸å±äºä»»ä½•ä¸€ä¸ªå®ä½“æˆ–å€¼å¯¹è±¡ã€‚å®ƒä»¬é€šå¸¸ç”¨äºè¡¨ç¤ºè·¨è¶Šå¤šä¸ªå®ä½“æˆ–å€¼å¯¹è±¡çš„ä¸šåŠ¡é€»è¾‘ã€‚</p></li><li><p><strong>ä»“å‚¨ï¼ˆRepositoryï¼‰</strong>ï¼šæä¾›è®¿é—®æŒä¹…åŒ–å­˜å‚¨ä¸­å¯¹è±¡çš„æ–¹æ³•ï¼Œé€šå¸¸ç”¨äºè·å–å’Œä¿å­˜èšåˆæ ¹ã€‚</p></li></ol><h4 id=ä»€ä¹ˆæ˜¯èšåˆæ ¹>ä»€ä¹ˆæ˜¯èšåˆæ ¹<a hidden class=anchor aria-hidden=true href=#ä»€ä¹ˆæ˜¯èšåˆæ ¹>#</a></h4><p>æŒ‡çš„æ˜¯ä¸€ä¸ªèšåˆä¸­å…·æœ‰å”¯ä¸€æ ‡è¯†çš„æ ¸å¿ƒå®ä½“ï¼Œè¯¥å®ä½“è´Ÿè´£æ§åˆ¶æ•´ä¸ªèšåˆçš„ç”Ÿå‘½å‘¨æœŸå’Œä¸€è‡´æ€§ã€‚</p><ol><li><p><strong>æ§åˆ¶è®¿é—®</strong>ï¼šèšåˆæ ¹æ˜¯èšåˆå†…çš„å”¯ä¸€å…¥å£ç‚¹ï¼Œå¤–éƒ¨å¯¹è±¡åªèƒ½é€šè¿‡èšåˆæ ¹æ¥è®¿é—®æˆ–æ“ä½œèšåˆä¸­çš„å…¶å®ƒå¯¹è±¡ã€‚è¿™æœ‰åŠ©äºä¿æŒèšåˆå†…éƒ¨çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚</p></li><li><p><strong>ç®¡ç†ç”Ÿå‘½å‘¨æœŸ</strong>ï¼šèšåˆæ ¹è´Ÿè´£ç®¡ç†èšåˆå†…æ‰€æœ‰å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤æ“ä½œã€‚é€šè¿‡èšåˆæ ¹ï¼Œå¯ä»¥ç¡®ä¿å¯¹èšåˆä¸­æ•°æ®çš„ä»»ä½•ä¿®æ”¹éƒ½æ˜¯åˆæ³•å’Œä¸€è‡´çš„ã€‚</p></li><li><p><strong>ä¸€è‡´æ€§è¾¹ç•Œ</strong>ï¼šèšåˆå®šä¹‰äº†ä¸€ä¸ªä¸€è‡´æ€§è¾¹ç•Œï¼Œå…¶ä¸­çš„æ‰€æœ‰å¯¹è±¡åœ¨äº‹åŠ¡ä¸­åº”è¯¥ä¿æŒä¸€è‡´ã€‚å› æ­¤ï¼Œèšåˆæ ¹é€šè¿‡ç¡®ä¿åœ¨å…¶èŒƒå›´å†…çš„æ“ä½œéƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ¥ç»´æŒè¿™ç§è¾¹ç•Œã€‚</p></li><li><p><strong>å”¯ä¸€æ€§</strong>ï¼šæ¯ä¸ªèšåˆéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„èšåˆæ ¹ã€‚é€šå¸¸ï¼Œèšåˆæ ¹å…·æœ‰å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨æ¥æ ‡è¯†å’Œè®¿é—®è¯¥èšåˆã€‚</p></li><li><p><strong>æŒä¹…åŒ–ç®¡ç†</strong>ï¼šé€šè¿‡ä»“å‚¨ï¼ˆRepositoryï¼‰æ¨¡å¼ï¼Œèšåˆæ ¹é€šå¸¸æ˜¯æŒä¹…åŒ–æ“ä½œï¼ˆå¦‚ä¿å­˜å’Œæ£€ç´¢ï¼‰çš„ä¸»è¦å¯¹è±¡ã€‚è¿™æ„å‘³ç€ä»“å‚¨é€šå¸¸åªç›´æ¥å¤„ç†èšåˆæ ¹ï¼Œè€Œä¸æ˜¯èšåˆå†…çš„å…¶å®ƒå¯¹è±¡ã€‚</p></li></ol><h3 id=é¢†åŸŸé©±åŠ¨è®¾è®¡ä¼˜ç¼ºç‚¹>é¢†åŸŸé©±åŠ¨è®¾è®¡ä¼˜ç¼ºç‚¹<a hidden class=anchor aria-hidden=true href=#é¢†åŸŸé©±åŠ¨è®¾è®¡ä¼˜ç¼ºç‚¹>#</a></h3><p>é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDomain-Driven Design, DDDï¼‰æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ–¹æ³•ï¼Œæ—¨åœ¨é€šè¿‡ç´§å¯†ç»“åˆä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯å®ç°æ¥æ„å»ºå¤æ‚è½¯ä»¶ç³»ç»Ÿã€‚ä»¥ä¸‹æ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡çš„ä¸€äº›ä¼˜ç¼ºç‚¹ï¼š</p><h4 id=ä¼˜ç‚¹>ä¼˜ç‚¹<a hidden class=anchor aria-hidden=true href=#ä¼˜ç‚¹>#</a></h4><ol><li><p><strong>æ›´å¥½åœ°ç†è§£ä¸šåŠ¡</strong>ï¼š</p><ul><li>DDDå¼ºè°ƒä¸é¢†åŸŸä¸“å®¶çš„å¯†åˆ‡åˆä½œï¼Œä½¿å¼€å‘å›¢é˜Ÿå¯¹ä¸šåŠ¡éœ€æ±‚æœ‰æ›´æ·±å…¥çš„ç†è§£ã€‚è¿™æœ‰åŠ©äºåˆ›å»ºæ›´ç¬¦åˆä¸šåŠ¡éœ€æ±‚çš„ç³»ç»Ÿã€‚</li></ul></li><li><p><strong>æ¸…æ™°çš„æ¨¡å‹</strong>ï¼š</p><ul><li>é€šè¿‡ä½¿ç”¨ç»Ÿä¸€è¯­è¨€å’Œé¢†åŸŸæ¨¡å‹ï¼Œæ‰€æœ‰å›¢é˜Ÿæˆå‘˜ï¼ˆåŒ…æ‹¬æŠ€æœ¯äººå‘˜å’ŒéæŠ€æœ¯äººå‘˜ï¼‰éƒ½å¯ä»¥åœ¨åŒä¸€è¯­å¢ƒä¸‹æ²Ÿé€šï¼Œä»è€Œå‡å°‘è¯¯è§£ã€‚</li></ul></li><li><p><strong>çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§</strong>ï¼š</p><ul><li>DDDé¼“åŠ±æ¨¡å—åŒ–è®¾è®¡ï¼Œå¦‚ç•Œé™ä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰å’Œèšåˆï¼ˆAggregateï¼‰ï¼Œè¿™äº›è®¾è®¡æœ‰åŠ©äºç®€åŒ–ç³»ç»Ÿçš„ç»´æŠ¤å’Œæ‰©å±•ã€‚</li></ul></li><li><p><strong>å…³æ³¨æ ¸å¿ƒé¢†åŸŸ</strong>ï¼š</p><ul><li>é€šè¿‡è¯†åˆ«å’Œèšç„¦äºæ ¸å¿ƒé¢†åŸŸï¼ŒDDDå¸®åŠ©å›¢é˜Ÿå°†èµ„æºé›†ä¸­åœ¨å¯¹ä¸šåŠ¡æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œä»è€Œæé«˜ç«äº‰åŠ›ã€‚</li></ul></li><li><p><strong>æ”¯æŒå¤æ‚ç³»ç»Ÿå¼€å‘</strong>ï¼š</p><ul><li>DDDä¸ºå¤„ç†å¤æ‚é¢†åŸŸé€»è¾‘æä¾›äº†æœ‰åŠ›çš„æ–¹æ³•å’Œå·¥å…·ï¼Œå¯ä»¥æœ‰æ•ˆåœ°ç®¡ç†å¤æ‚æ€§ã€‚</li></ul></li></ol><h4 id=ç¼ºç‚¹>ç¼ºç‚¹<a hidden class=anchor aria-hidden=true href=#ç¼ºç‚¹>#</a></h4><ol><li><p><strong>å­¦ä¹ æ›²çº¿é™¡å³­</strong>ï¼š</p><ul><li>å¯¹è®¸å¤šå¼€å‘äººå‘˜å’Œç»„ç»‡æ¥è¯´ï¼ŒDDDçš„æ¦‚å¿µå’ŒæŠ€æœ¯æœ¯è¯­å¯èƒ½è¾ƒä¸ºé™Œç”Ÿï¼Œåˆå§‹å­¦ä¹ å’Œå®æ–½æˆæœ¬è¾ƒé«˜ã€‚</li></ul></li><li><p><strong>æ—¶é—´å’Œèµ„æºæŠ•å…¥å¤§</strong>ï¼š</p><ul><li>ç”±äºéœ€è¦æ·±åº¦çš„é¢†åŸŸåˆ†æå’ŒæŒç»­çš„å›¢é˜Ÿåä½œï¼ŒDDDå¯èƒ½æ¯”ä¼ ç»Ÿæ–¹æ³•èŠ±è´¹æ›´å¤šæ—¶é—´å’Œèµ„æºã€‚</li></ul></li><li><p><strong>ä¸é€‚åˆæ‰€æœ‰é¡¹ç›®</strong>ï¼š</p><ul><li>å¯¹äºç®€å•æˆ–å°å‹é¡¹ç›®ï¼ŒDDDå¯èƒ½è¿‡äºå¤æ‚å’Œå†—ä½™ï¼ŒæŠ•å…¥çš„æˆæœ¬å’Œæ”¶ç›Šä¸æˆæ¯”ä¾‹ã€‚</li></ul></li><li><p><strong>éœ€æ±‚ç¨³å®šæ€§è¦æ±‚é«˜</strong>ï¼š</p><ul><li>DDDæ›´é€‚åˆäºéœ€æ±‚ç›¸å¯¹ç¨³å®šä¸”å¯¹ä¸šåŠ¡é€»è¾‘è¦æ±‚é«˜çš„é¡¹ç›®ã€‚å¯¹äºéœ€æ±‚é¢‘ç¹å˜åŒ–çš„é¡¹ç›®ï¼Œå¯èƒ½éœ€è¦ç»å¸¸é‡æ„ã€‚</li></ul></li><li><p><strong>å¯¹å›¢é˜Ÿåä½œè¦æ±‚é«˜</strong>ï¼š</p><ul><li>æˆåŠŸå®æ–½DDDéœ€è¦å›¢é˜Ÿæˆå‘˜ä¹‹é—´è‰¯å¥½çš„æ²Ÿé€šå’Œåä½œï¼Œè¿™å¯¹å›¢é˜Ÿçš„ç»„ç»‡æ–‡åŒ–å’Œæ²Ÿé€šèƒ½åŠ›æå‡ºäº†è¾ƒé«˜è¦æ±‚ã€‚</li></ul></li></ol><h3 id=ä¸ºä»€ä¹ˆéœ€è¦é¢†åŸŸæ¨¡å‹>ä¸ºä»€ä¹ˆéœ€è¦é¢†åŸŸæ¨¡å‹<a hidden class=anchor aria-hidden=true href=#ä¸ºä»€ä¹ˆéœ€è¦é¢†åŸŸæ¨¡å‹>#</a></h3><p>åœ¨ä¼ ç»Ÿçš„è½¯ä»¶å¼€å‘ä¸­,æˆ‘ä»¬å¸¸å¸¸é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š</p><h4 id=1-è´«è¡€æ¨¡å‹çš„å›°å¢ƒ>1. è´«è¡€æ¨¡å‹çš„å›°å¢ƒ<a hidden class=anchor aria-hidden=true href=#1-è´«è¡€æ¨¡å‹çš„å›°å¢ƒ>#</a></h4><p>ä¼ ç»Ÿçš„å¼€å‘æ–¹å¼å¾€å¾€é‡‡ç”¨"è´«è¡€æ¨¡å‹"ï¼ˆAnemic Domain Modelï¼‰ï¼Œå³ï¼š</p><ul><li><strong>æ•°æ®å¯¹è±¡åªåŒ…å«å­—æ®µå’Œç®€å•çš„ getter/setter</strong>ï¼Œæ²¡æœ‰ä»»ä½•ä¸šåŠ¡é€»è¾‘</li><li><strong>æ‰€æœ‰ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨ Service å±‚</strong>ï¼Œå½¢æˆåºå¤§çš„æœåŠ¡ç±»</li><li><strong>æ•°æ®å’Œè¡Œä¸ºåˆ†ç¦»</strong>ï¼Œå¯¼è‡´ä»£ç éš¾ä»¥ç†è§£å’Œç»´æŠ¤</li></ul><h4 id=2-ä¸šåŠ¡é€»è¾‘æ•£ä¹±>2. ä¸šåŠ¡é€»è¾‘æ•£ä¹±<a hidden class=anchor aria-hidden=true href=#2-ä¸šåŠ¡é€»è¾‘æ•£ä¹±>#</a></h4><ul><li><strong>ç¼ºä¹ç»Ÿä¸€çš„ä¸šåŠ¡è§„åˆ™ç®¡ç†</strong>ï¼šåŒæ ·çš„ä¸šåŠ¡é€»è¾‘å¯èƒ½åœ¨å¤šä¸ªåœ°æ–¹é‡å¤å®ç°</li><li><strong>éš¾ä»¥ä¿è¯ä¸€è‡´æ€§</strong>ï¼šè®¢å•åˆ›å»ºã€ä¿®æ”¹ã€å–æ¶ˆç­‰æ“ä½œä¸­çš„ä¸šåŠ¡è§„åˆ™å¯èƒ½ä¸ä¸€è‡´</li><li><strong>ç»´æŠ¤æˆæœ¬é«˜</strong>ï¼šä¿®æ”¹ä¸€ä¸ªä¸šåŠ¡è§„åˆ™éœ€è¦åœ¨å¤šä¸ªåœ°æ–¹æŸ¥æ‰¾å’Œä¿®æ”¹</li></ul><h4 id=3-æŠ€æœ¯ä¸ä¸šåŠ¡è„±èŠ‚>3. æŠ€æœ¯ä¸ä¸šåŠ¡è„±èŠ‚<a hidden class=anchor aria-hidden=true href=#3-æŠ€æœ¯ä¸ä¸šåŠ¡è„±èŠ‚>#</a></h4><ul><li><strong>ä»£ç éš¾ä»¥åæ˜ ä¸šåŠ¡æ„å›¾</strong>ï¼šå¼€å‘äººå‘˜çœ‹åˆ°çš„æ˜¯è¡¨ã€å­—æ®µã€SQLï¼Œè€Œä¸æ˜¯è®¢å•ã€æ”¯ä»˜ã€å‘è´§ç­‰ä¸šåŠ¡æ¦‚å¿µ</li><li><strong>ä¸é¢†åŸŸä¸“å®¶æ²Ÿé€šå›°éš¾</strong>ï¼šæŠ€æœ¯æœ¯è¯­å’Œä¸šåŠ¡æœ¯è¯­æ— æ³•å¯¹åº”ï¼Œå®¹æ˜“äº§ç”Ÿç†è§£åå·®</li><li><strong>éœ€æ±‚å˜æ›´ä»£ä»·å¤§</strong>ï¼šä¸šåŠ¡è°ƒæ•´æ—¶ï¼Œéœ€è¦ä»åº•å±‚æ•°æ®ç»“æ„å¼€å§‹é‡æ–°è®¾è®¡</li></ul><h4 id=é¢†åŸŸæ¨¡å‹å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜>é¢†åŸŸæ¨¡å‹å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜<a hidden class=anchor aria-hidden=true href=#é¢†åŸŸæ¨¡å‹å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜>#</a></h4><p>é¢†åŸŸæ¨¡å‹é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³ä¸Šè¿°é—®é¢˜ï¼š</p><h5 id=1-å°è£…ä¸šåŠ¡é€»è¾‘>1. å°è£…ä¸šåŠ¡é€»è¾‘<a hidden class=anchor aria-hidden=true href=#1-å°è£…ä¸šåŠ¡é€»è¾‘>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// å……è¡€æ¨¡å‹ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Order</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userId</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PENDING&#39;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ä¸šåŠ¡é€»è¾‘å°è£…åœ¨å®ä½“å†…éƒ¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>addItem</span>(<span style=color:#a6e22e>product</span>, <span style=color:#a6e22e>quantity</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;PENDING&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;åªèƒ½å‘å¾…å¤„ç†è®¢å•æ·»åŠ å•†å“&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>quantity</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;å•†å“æ•°é‡å¿…é¡»å¤§äº0&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>product</span>, <span style=color:#a6e22e>quantity</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>submit</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;è®¢å•ä¸èƒ½ä¸ºç©º&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SUBMITTED&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è§¦å‘é¢†åŸŸäº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addDomainEvent</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>OrderSubmittedEvent</span>(<span style=color:#66d9ef>this</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>calculateTotal</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>reduce</span>((<span style=color:#a6e22e>sum</span>, <span style=color:#a6e22e>item</span>) =&gt;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sum</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>product</span>.<span style=color:#a6e22e>price</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>quantity</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=2-ç»Ÿä¸€è¯­è¨€ubiquitous-language>2. ç»Ÿä¸€è¯­è¨€ï¼ˆUbiquitous Languageï¼‰<a hidden class=anchor aria-hidden=true href=#2-ç»Ÿä¸€è¯­è¨€ubiquitous-language>#</a></h5><ul><li>ä»£ç ä¸­çš„ç±»åã€æ–¹æ³•åç›´æ¥å¯¹åº”ä¸šåŠ¡æ¦‚å¿µ</li><li>å¼€å‘äººå‘˜å’Œé¢†åŸŸä¸“å®¶ä½¿ç”¨ç›¸åŒçš„æœ¯è¯­</li><li>ä»£ç å³æ–‡æ¡£ï¼Œä¸šåŠ¡è§„åˆ™æ¸…æ™°å¯è§</li></ul><h5 id=3-ç»´æŠ¤ä¸šåŠ¡ä¸å˜æ€§invariants>3. ç»´æŠ¤ä¸šåŠ¡ä¸å˜æ€§ï¼ˆInvariantsï¼‰<a hidden class=anchor aria-hidden=true href=#3-ç»´æŠ¤ä¸šåŠ¡ä¸å˜æ€§invariants>#</a></h5><ul><li>é€šè¿‡èšåˆæ ¹æ§åˆ¶çŠ¶æ€å˜æ›´</li><li>ç¡®ä¿å¯¹è±¡å§‹ç»ˆå¤„äºæœ‰æ•ˆçŠ¶æ€</li><li>ä¸šåŠ¡è§„åˆ™åœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰å’Œç»´æŠ¤</li></ul><h5 id=4-é™ä½è®¤çŸ¥è´Ÿæ‹…>4. é™ä½è®¤çŸ¥è´Ÿæ‹…<a hidden class=anchor aria-hidden=true href=#4-é™ä½è®¤çŸ¥è´Ÿæ‹…>#</a></h5><ul><li>æ¯ä¸ªé¢†åŸŸå¯¹è±¡èŒè´£æ¸…æ™°</li><li>ä¸šåŠ¡é€»è¾‘å†…èšï¼Œæ˜“äºç†è§£å’Œæµ‹è¯•</li><li>ä¿®æ”¹å½±å“èŒƒå›´å¯æ§</li></ul><h4 id=å®è·µä»·å€¼>å®è·µä»·å€¼<a hidden class=anchor aria-hidden=true href=#å®è·µä»·å€¼>#</a></h4><p>å¼•å…¥é¢†åŸŸæ¨¡å‹åï¼Œå¸¦æ¥çš„å®é™…ä»·å€¼ï¼š</p><ol><li><strong>ä»£ç å¯è¯»æ€§æå‡</strong>ï¼šæ–°äººå¯ä»¥é€šè¿‡é˜…è¯»é¢†åŸŸæ¨¡å‹å¿«é€Ÿç†è§£ä¸šåŠ¡</li><li><strong>ç»´æŠ¤æˆæœ¬é™ä½</strong>ï¼šä¸šåŠ¡è§„åˆ™é›†ä¸­ç®¡ç†ï¼Œä¿®æ”¹å½±å“èŒƒå›´æ˜ç¡®</li><li><strong>æµ‹è¯•æ›´å®¹æ˜“</strong>ï¼šé¢†åŸŸå¯¹è±¡å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼Œä¸ä¾èµ–æ•°æ®åº“å’Œå¤–éƒ¨æœåŠ¡</li><li><strong>åº”å¯¹å¤æ‚åº¦</strong>ï¼šå½“ä¸šåŠ¡é€»è¾‘å˜å¾—å¤æ‚æ—¶ï¼Œé¢†åŸŸæ¨¡å‹çš„ä¼˜åŠ¿æ›´åŠ æ˜æ˜¾</li><li><strong>é•¿æœŸä»·å€¼</strong>ï¼šéšç€é¡¹ç›®æ¼”è¿›ï¼Œé¢†åŸŸæ¨¡å‹å¸®åŠ©ä¿æŒä»£ç è´¨é‡å’Œæ¶æ„æ¸…æ™°åº¦</li></ol><blockquote><p><strong>æ€»ç»“</strong>ï¼šé¢†åŸŸæ¨¡å‹ä¸æ˜¯é“¶å¼¹ï¼Œä½†å¯¹äºä¸šåŠ¡é€»è¾‘å¤æ‚çš„ç³»ç»Ÿæ¥è¯´ï¼Œå®ƒæä¾›äº†ä¸€ç§æ›´åŠ è´´è¿‘ä¸šåŠ¡ã€æ˜“äºç»´æŠ¤çš„ä»£ç ç»„ç»‡æ–¹å¼ã€‚é€šè¿‡å°†æ•°æ®å’Œè¡Œä¸ºç»“åˆï¼Œé¢†åŸŸæ¨¡å‹è®©ä»£ç çœŸæ­£æˆä¸ºä¸šåŠ¡çŸ¥è¯†çš„è¡¨è¾¾</p></blockquote><h3 id=ä¸¾ä¾‹>ä¸¾ä¾‹<a hidden class=anchor aria-hidden=true href=#ä¸¾ä¾‹>#</a></h3><p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªæ¸¸æˆä¸­çš„"å® ç‰©å–‚å…»å‡çº§"æ¨¡å‹æ¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨DDDè¿›è¡Œè®¾è®¡</p><h4 id=ä¸šåŠ¡åœºæ™¯>ä¸šåŠ¡åœºæ™¯<a hidden class=anchor aria-hidden=true href=#ä¸šåŠ¡åœºæ™¯>#</a></h4><p>åœ¨ä¸€ä¸ªå® ç‰©å…»æˆæ¸¸æˆä¸­ï¼Œç©å®¶å¯ä»¥ï¼š</p><ul><li>å–‚å…»å® ç‰©è·å¾—ç»éªŒå€¼</li><li>å® ç‰©ç»éªŒå€¼è¾¾åˆ°ä¸€å®šæ•°é‡åè¿›è¡Œå‡çº§</li><li>å® ç‰©å‡çº§åæœ‰å¯¹åº”çš„å¥–åŠ±ç‰©</li><li>æœ€ç»ˆæ ¹æ®å® ç‰©çš„å¥–åŠ±ç‰©å‘æ”¾å¯¹åº”çš„å¥–åŠ±</li></ul><h4 id=ä¸šåŠ¡æµç¨‹å›¾>ä¸šåŠ¡æµç¨‹å›¾<a hidden class=anchor aria-hidden=true href=#ä¸šåŠ¡æµç¨‹å›¾>#</a></h4><pre tabindex=0><code class=language-mermaid data-lang=mermaid>stateDiagram-v2
    [*] --&gt; å¾…å–‚å…»: å® ç‰©åˆå§‹çŠ¶æ€

    å¾…å–‚å…» --&gt; å¢åŠ ç»éªŒ: ç©å®¶å–‚å…»é£Ÿç‰©

    å¢åŠ ç»éªŒ --&gt; æ£€æŸ¥å‡çº§æ¡ä»¶: ç»éªŒå€¼ç´¯åŠ 

    æ£€æŸ¥å‡çº§æ¡ä»¶ --&gt; å‡çº§ä¸­: ç»éªŒå€¼ &gt;= æ‰€éœ€ç»éªŒ
    æ£€æŸ¥å‡çº§æ¡ä»¶ --&gt; å¾…å–‚å…»: ç»éªŒå€¼ &lt; æ‰€éœ€ç»éªŒ

    å‡çº§ä¸­ --&gt; å±æ€§æå‡: æ¶ˆè€—ç»éªŒå€¼
    å±æ€§æå‡ --&gt; å¥–åŠ±ç”Ÿæˆ: ç­‰çº§+1, å±æ€§å¢åŠ 

    å¥–åŠ±ç”Ÿæˆ --&gt; æ£€æŸ¥å‡çº§æ¡ä»¶: ç»§ç»­æ£€æŸ¥æ˜¯å¦èƒ½å†æ¬¡å‡çº§

    å¥–åŠ±ç”Ÿæˆ --&gt; å‘æ”¾å¥–åŠ±: æ‰€æœ‰å‡çº§å®Œæˆ

    å‘æ”¾å¥–åŠ± --&gt; å¾…å–‚å…»: å¥–åŠ±å‘æ”¾å®Œæ¯•

    note right of æ£€æŸ¥å‡çº§æ¡ä»¶
        ä¸åŒå“è´¨å® ç‰©
        æ‰€éœ€ç»éªŒä¸åŒ
        - æ™®é€š: 1.0x
        - ç¨€æœ‰: 1.2x
        - å²è¯—: 1.5x
    end note

    note right of å±æ€§æå‡
        å±æ€§å¢é•¿å…¬å¼
        HP: +10 * å“è´¨å€ç‡
        Attack: +5 * å“è´¨å€ç‡
    end note
</code></pre><p><strong>çŠ¶æ€è¯´æ˜</strong>ï¼š</p><ol><li><strong>å¾…å–‚å…»</strong>ï¼šå® ç‰©çš„æ­£å¸¸çŠ¶æ€ï¼Œç­‰å¾…ç©å®¶æŠ•å–‚é£Ÿç‰©</li><li><strong>å¢åŠ ç»éªŒ</strong>ï¼šå–‚å…»åç»éªŒå€¼å¢åŠ çš„ç¬æ—¶çŠ¶æ€</li><li><strong>æ£€æŸ¥å‡çº§æ¡ä»¶</strong>ï¼šåˆ¤æ–­å½“å‰ç»éªŒæ˜¯å¦è¶³å¤Ÿå‡çº§ï¼ˆæ”¯æŒè¿ç»­å‡çº§ï¼‰</li><li><strong>å‡çº§ä¸­</strong>ï¼šæ¶ˆè€—ç»éªŒå€¼ï¼Œè¿›è¡Œç­‰çº§æå‡</li><li><strong>å±æ€§æå‡</strong>ï¼šæ ¹æ®å“è´¨å€ç‡è®¡ç®—æ–°çš„å±æ€§å€¼</li><li><strong>å¥–åŠ±ç”Ÿæˆ</strong>ï¼šåŸºäºå‡çº§ç»“æœç”Ÿæˆå¥–åŠ±ç‰©å“</li><li><strong>å‘æ”¾å¥–åŠ±</strong>ï¼šå°†å¥–åŠ±ç‰©å“å‘æ”¾ç»™ç©å®¶</li></ol><h4 id=ä¼ ç»Ÿå®ç°æ–¹å¼>ä¼ ç»Ÿå®ç°æ–¹å¼<a hidden class=anchor aria-hidden=true href=#ä¼ ç»Ÿå®ç°æ–¹å¼>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// æ•°æ®æ¨¡å‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Pet</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exp</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>quality</span>; <span style=color:#75715e>// å“è´¨ï¼šæ™®é€šã€ç¨€æœ‰ã€å²è¯—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>hp</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>attack</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Serviceå±‚å¤„ç†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetService</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>feed</span>(<span style=color:#a6e22e>petId</span>, <span style=color:#a6e22e>foodValue</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1. æŸ¥è¯¢å® ç‰©
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>&#39;SELECT * FROM pets WHERE id = ?&#39;</span>, [<span style=color:#a6e22e>petId</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. è®¡ç®—ç»éªŒå€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>foodValue</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. æ£€æŸ¥æ˜¯å¦å‡çº§ï¼ˆé€»è¾‘åˆ†æ•£ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRequiredExp</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>quality</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>-=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRequiredExp</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>quality</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>levelUpCount</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. å‡çº§åå±æ€§è®¡ç®—ï¼ˆé€»è¾‘å¤æ‚ä¸”å®¹æ˜“å‡ºé”™ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>hp</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getQualityMultiplier</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>quality</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>attack</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getQualityMultiplier</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>quality</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 5. å‘é€é€šçŸ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendLevelUpNotification</span>(<span style=color:#a6e22e>petId</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>level</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 6. ä¿å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>&#39;UPDATE pets SET level=?, exp=?, hp=?, attack=? WHERE id=?&#39;</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>exp</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>hp</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>attack</span>, <span style=color:#a6e22e>petId</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pet</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getRequiredExp</span>(<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>quality</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‡çº§æ‰€éœ€ç»éªŒè®¡ç®—é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>base</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>quality</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;epic&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>base</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1.5</span> <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>           <span style=color:#a6e22e>quality</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;rare&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>base</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1.2</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>base</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getQualityMultiplier</span>(<span style=color:#a6e22e>quality</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>quality</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;epic&#39;</span> <span style=color:#f92672>?</span> <span style=color:#ae81ff>1.5</span> <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>           <span style=color:#a6e22e>quality</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;rare&#39;</span> <span style=color:#f92672>?</span> <span style=color:#ae81ff>1.2</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>1.0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>é—®é¢˜</strong>ï¼š</p><ul><li>ä¸šåŠ¡é€»è¾‘å…¨åœ¨Serviceå±‚ï¼Œä»£ç è‡ƒè‚¿</li><li>Petåªæ˜¯æ•°æ®å®¹å™¨ï¼Œæ²¡æœ‰è¡Œä¸º</li><li>å‡çº§è§„åˆ™ã€å±æ€§è®¡ç®—æ•£è½å„å¤„</li><li>éš¾ä»¥ä¿è¯å® ç‰©çŠ¶æ€çš„ä¸€è‡´æ€§</li><li>æµ‹è¯•å›°éš¾ï¼Œéœ€è¦mockæ•°æ®åº“</li></ul><h4 id=dddå®ç°æ–¹å¼>DDDå®ç°æ–¹å¼<a hidden class=anchor aria-hidden=true href=#dddå®ç°æ–¹å¼>#</a></h4><h5 id=1-å€¼å¯¹è±¡value-object--ç»éªŒå€¼>1. å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰- ç»éªŒå€¼<a hidden class=anchor aria-hidden=true href=#1-å€¼å¯¹è±¡value-object--ç»éªŒå€¼>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// å€¼å¯¹è±¡ï¼šç»éªŒå€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Experience</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>current</span>, <span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>quality</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>current</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;ç»éªŒå€¼ä¸èƒ½ä¸ºè´Ÿ&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>current</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>quality</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è·å–å‡çº§æ‰€éœ€ç»éªŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>getRequiredForNextLevel</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>baseExp</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>multiplier</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;common&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.0</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;rare&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.2</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;epic&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.5</span>
</span></span><span style=display:flex><span>    }[<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span>] <span style=color:#f92672>||</span> <span style=color:#ae81ff>1.0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>baseExp</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>multiplier</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ·»åŠ ç»éªŒï¼Œè¿”å›æ–°çš„Experienceå¯¹è±¡ï¼ˆå€¼å¯¹è±¡ä¸å¯å˜ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>value</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>canLevelUp</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRequiredForNextLevel</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ¶ˆè€—å‡çº§æ‰€éœ€ç»éªŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>consumeForLevelUp</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>required</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRequiredForNextLevel</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>required</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=2-å€¼å¯¹è±¡---å® ç‰©å±æ€§>2. å€¼å¯¹è±¡ - å® ç‰©å±æ€§<a hidden class=anchor aria-hidden=true href=#2-å€¼å¯¹è±¡---å® ç‰©å±æ€§>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// å€¼å¯¹è±¡ï¼šå±æ€§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetStats</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>hp</span>, <span style=color:#a6e22e>attack</span>, <span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>quality</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>hp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hp</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attack</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>attack</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>quality</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å‡çº§åçš„å±æ€§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>levelUp</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>multiplier</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;common&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.0</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;rare&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.2</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;epic&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.5</span>
</span></span><span style=display:flex><span>    }[<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span>] <span style=color:#f92672>||</span> <span style=color:#ae81ff>1.0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetStats</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>hp</span> <span style=color:#f92672>+</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>multiplier</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attack</span> <span style=color:#f92672>+</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>multiplier</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=3-é¢†åŸŸäº‹ä»¶>3. é¢†åŸŸäº‹ä»¶<a hidden class=anchor aria-hidden=true href=#3-é¢†åŸŸäº‹ä»¶>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// é¢†åŸŸäº‹ä»¶ï¼šå® ç‰©å‡çº§äº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetLeveledUpEvent</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>petId</span>, <span style=color:#a6e22e>oldLevel</span>, <span style=color:#a6e22e>newLevel</span>, <span style=color:#a6e22e>stats</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>petId</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>oldLevel</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>oldLevel</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>newLevel</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>newLevel</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>stats</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>occurredAt</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é¢†åŸŸäº‹ä»¶ï¼šå® ç‰©å–‚å…»äº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetFedEvent</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>petId</span>, <span style=color:#a6e22e>foodValue</span>, <span style=color:#a6e22e>gainedExp</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>petId</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>foodValue</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>gainedExp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>gainedExp</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>occurredAt</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=4-å®ä½“èšåˆæ ¹---å® ç‰©>4. å®ä½“/èšåˆæ ¹ - å® ç‰©<a hidden class=anchor aria-hidden=true href=#4-å®ä½“èšåˆæ ¹---å® ç‰©>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// èšåˆæ ¹ï¼šå® ç‰©
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Pet</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>quality</span>, <span style=color:#a6e22e>experience</span>, <span style=color:#a6e22e>stats</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>quality</span>; <span style=color:#75715e>// &#39;common&#39;, &#39;rare&#39;, &#39;epic&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>experience</span>; <span style=color:#75715e>// Experienceå€¼å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>stats</span>; <span style=color:#75715e>// PetStatså€¼å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>domainEvents</span> <span style=color:#f92672>=</span> []; <span style=color:#75715e>// é¢†åŸŸäº‹ä»¶åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å–‚å…»å® ç‰©
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>feed</span>(<span style=color:#a6e22e>foodValue</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;é£Ÿç‰©ä»·å€¼å¿…é¡»å¤§äº0&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ·»åŠ ç»éªŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>oldExp</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>foodValue</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®°å½•å–‚å…»äº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addDomainEvent</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetFedEvent</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>foodValue</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>foodValue</span>
</span></span><span style=display:flex><span>    ));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å°è¯•å‡çº§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tryLevelUp</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å°è¯•å‡çº§ï¼ˆç§æœ‰ä¸šåŠ¡é€»è¾‘ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>tryLevelUp</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¾ªç¯å‡çº§ï¼ˆå¤„ç†ä¸€æ¬¡å–‚å…»å¤šæ¬¡å‡çº§çš„æƒ…å†µï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>canLevelUp</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>oldLevel</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// æ¶ˆè€—ç»éªŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>consumeForLevelUp</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// æå‡å±æ€§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>levelUp</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>levelUpCount</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// è§¦å‘å‡çº§äº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addDomainEvent</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetLeveledUpEvent</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>oldLevel</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>level</span>,
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>hp</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>hp</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>attack</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>attack</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>levelUpCount</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ·»åŠ é¢†åŸŸäº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>addDomainEvent</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>domainEvents</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è·å–å¹¶æ¸…ç©ºé¢†åŸŸäº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>pullDomainEvents</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>events</span> <span style=color:#f92672>=</span> [...<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>domainEvents</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>domainEvents</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>events</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è·å–å½“å‰ç­‰çº§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>getLevel</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è·å–å½“å‰ç»éªŒè¿›åº¦ï¼ˆç™¾åˆ†æ¯”ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>getExpProgress</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>required</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>getRequiredForNextLevel</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>required</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>).<span style=color:#a6e22e>toFixed</span>(<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=5-ä»“å‚¨æ¥å£>5. ä»“å‚¨æ¥å£<a hidden class=anchor aria-hidden=true href=#5-ä»“å‚¨æ¥å£>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// ä»“å‚¨æ¥å£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IPetRepository</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>petId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not implemented&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>pet</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not implemented&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä»“å‚¨å®ç°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetRepository</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>IPetRepository</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>db</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>petId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>query</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;SELECT * FROM pets WHERE id = ?&#39;</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>petId</span>]
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>data</span>) <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä»æ•°æ®é‡å»ºé¢†åŸŸå¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Pet</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>quality</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>exp</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>quality</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetStats</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>hp</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>attack</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>quality</span>)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>pet</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¿å­˜èšåˆæ ¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>query</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`UPDATE pets SET
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        level = ?,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        exp = ?,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        hp = ?,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        attack = ?
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      WHERE id = ?`</span>,
</span></span><span style=display:flex><span>      [
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>level</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>current</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>hp</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>attack</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‘å¸ƒé¢†åŸŸäº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>events</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>pullDomainEvents</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>event</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>events</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>publishEvent</span>(<span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>publishEvent</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‘å¸ƒäº‹ä»¶åˆ°äº‹ä»¶æ€»çº¿
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ä¾‹å¦‚ï¼šå‘é€é€šçŸ¥ã€æ›´æ–°æ’è¡Œæ¦œç­‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Domain Event:&#39;</span>, <span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=6-åº”ç”¨æœåŠ¡ç®€æ´çš„ä¸šåŠ¡é€»è¾‘ç¼–æ’å±‚>6. åº”ç”¨æœåŠ¡ï¼ˆç®€æ´çš„ä¸šåŠ¡é€»è¾‘ç¼–æ’å±‚ï¼‰<a hidden class=anchor aria-hidden=true href=#6-åº”ç”¨æœåŠ¡ç®€æ´çš„ä¸šåŠ¡é€»è¾‘ç¼–æ’å±‚>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// åº”ç”¨æœåŠ¡ï¼šåªè´Ÿè´£ç¼–æ’ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetApplicationService</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>petRepository</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petRepository</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>petRepository</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>feedPet</span>(<span style=color:#a6e22e>petId</span>, <span style=color:#a6e22e>foodValue</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1. åŠ è½½èšåˆæ ¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petRepository</span>.<span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>petId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>pet</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;å® ç‰©ä¸å­˜åœ¨&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆåœ¨é¢†åŸŸæ¨¡å‹ä¸­ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>feed</span>(<span style=color:#a6e22e>foodValue</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. æŒä¹…åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petRepository</span>.<span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>pet</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. è¿”å›ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>level</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>exp</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>current</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expProgress</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getExpProgress</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>hp</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>hp</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>attack</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>attack</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=7-ä½¿ç”¨ç¤ºä¾‹>7. ä½¿ç”¨ç¤ºä¾‹<a hidden class=anchor aria-hidden=true href=#7-ä½¿ç”¨ç¤ºä¾‹>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// ä½¿ç”¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>petService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetApplicationService</span>(<span style=color:#a6e22e>petRepository</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å–‚å…»å® ç‰©
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>petService</span>.<span style=color:#a6e22e>feedPet</span>(<span style=color:#e6db74>&#39;pet-123&#39;</span>, <span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`å® ç‰©å‡çº§åˆ°</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>level</span><span style=color:#e6db74>}</span><span style=color:#e6db74>çº§ï¼Œç»éªŒè¿›åº¦</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>expProgress</span><span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸šåŠ¡é€»è¾‘éƒ½åœ¨é¢†åŸŸæ¨¡å‹ä¸­ï¼Œåº”ç”¨æœåŠ¡éå¸¸ç®€æ´
</span></span></span></code></pre></div><h4 id=æ›´è¿›ä¸€æ­¥>æ›´è¿›ä¸€æ­¥<a hidden class=anchor aria-hidden=true href=#æ›´è¿›ä¸€æ­¥>#</a></h4><p>åœ¨å®é™…ä¸šåŠ¡ä¸­,æˆ‘ä»¬å¸¸å¸¸éœ€è¦åœ¨ä¿æŒæ ¸å¿ƒæµç¨‹ä¸å˜çš„æƒ…å†µä¸‹,å…è®¸ä¸åŒçš„ä¸šåŠ¡åœºæ™¯æœ‰å®šåˆ¶åŒ–çš„é€»è¾‘ã€‚è¿™æ—¶å¯ä»¥è¿›ä¸€æ­¥é€šè¿‡<strong>æ‰©å±•ç‚¹æ¨¡å¼</strong>æ¥å®ç°ã€‚</p><h5 id=ä¸šåŠ¡åœºæ™¯æ‰©å±•>ä¸šåŠ¡åœºæ™¯æ‰©å±•<a hidden class=anchor aria-hidden=true href=#ä¸šåŠ¡åœºæ™¯æ‰©å±•>#</a></h5><p>å‡è®¾æˆ‘ä»¬çš„å® ç‰©ç³»ç»Ÿéœ€è¦æ”¯æŒä¸åŒç±»å‹çš„å–‚å…»ç­–ç•¥ï¼š</p><ul><li><strong>æ™®é€šå® ç‰©</strong>ï¼šç›´æ¥è·å¾—ç»éªŒ</li><li><strong>VIPå® ç‰©</strong>ï¼šè·å¾—ç»éªŒåŠ æˆ,å¹¶æœ‰é¢å¤–çš„å±æ€§æå‡</li><li><strong>ä¼ è¯´å® ç‰©</strong>ï¼šå–‚å…»æ—¶è§¦å‘ç‰¹æ®Šæ•ˆæœ,å¯èƒ½è·å¾—é¢å¤–å¥–åŠ±</li></ul><h5 id=å®Œæ•´ç±»å‹å®šä¹‰>å®Œæ•´ç±»å‹å®šä¹‰<a hidden class=anchor aria-hidden=true href=#å®Œæ•´ç±»å‹å®šä¹‰>#</a></h5><p>é¦–å…ˆ,å®šä¹‰å®Œæ•´çš„ç±»å‹ç³»ç»Ÿï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// ============= åŸºç¡€ç±»å‹å®šä¹‰ =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¥–åŠ±ç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RewardType</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;gold&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;diamond&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;special_item&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;rare_event&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¥–åŠ±æ¥å£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Reward</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>RewardType</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>amount?</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>itemId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>eventId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è¿å‡»çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ComboStatus</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;GOOD&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;GREAT!&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;AMAZING!&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å® ç‰©ç­‰çº§è¯„çº§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PetRank</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Cçº§æ™®é€š&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;Bçº§ç¨€æœ‰&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;Açº§å²è¯—&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;Sçº§ä¼ è¯´&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// VIPç­‰çº§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>VipLevel</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ============= æ‰©å±•å­—æ®µç±»å‹å®šä¹‰ =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// VIPç‰¹æƒä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VipPrivilege</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>savedFeeds</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è¿å‡»ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ComboInfo</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comboCount</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comboBonus</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nextComboAt</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comboStatus</span>: <span style=color:#66d9ef>ComboStatus</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¯æ—¥é™åˆ¶ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>DailyLimit</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>remaining</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>total</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resetAt</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç‰¹æ®Šäº‹ä»¶ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SpecialEvents</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>triggered</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>events</span>: <span style=color:#66d9ef>Reward</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¼ è¯´ç»Ÿè®¡ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>LegendaryStats</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>totalBonus</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>legendaryBonus</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>efficiency</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rank</span>: <span style=color:#66d9ef>PetRank</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ============= è¿”å›ç»“æœç±»å‹å®šä¹‰ =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åŸºç¡€è¿”å›ç»“æœæ¥å£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BaseFeedingResponse</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>level</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exp</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expProgress</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hp</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>attack</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>Reward</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ™®é€šç­–ç•¥æ‰©å±•å­—æ®µ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>NormalFeedingExtensions</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>feedCount</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>totalExpGained</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// VIPç­–ç•¥æ‰©å±•å­—æ®µ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VipFeedingExtensions</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vipLevel</span>: <span style=color:#66d9ef>VipLevel</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expBonus</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bonusRate</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vipPrivilege</span>: <span style=color:#66d9ef>VipPrivilege</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¼ è¯´ç­–ç•¥æ‰©å±•å­—æ®µ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>LegendaryFeedingExtensions</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comboInfo</span>: <span style=color:#66d9ef>ComboInfo</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dailyLimit</span>: <span style=color:#66d9ef>DailyLimit</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>specialEvents?</span>: <span style=color:#66d9ef>SpecialEvents</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>legendaryStats</span>: <span style=color:#66d9ef>LegendaryStats</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç»„åˆè¿”å›ç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NormalFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>NormalFeedingExtensions</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>VipFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>VipFeedingExtensions</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LegendaryFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>LegendaryFeedingExtensions</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ============= ä¸Šä¸‹æ–‡ç±»å‹å®šä¹‰ =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>FeedingContext</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expBonus</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>actualFoodValue</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ============= äº‹ä»¶ç®¡ç†å™¨æ¥å£ =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>EventManager</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>publish</span>(<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ============= Pet ç›¸å…³æ¥å£ï¼ˆç®€åŒ–ç‰ˆï¼‰ =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Pet</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>quality</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>experience</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>stats</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>feed</span>(<span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getLevel</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getExpProgress</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IPetRepository</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>petId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>Pet</span> <span style=color:#960050;background-color:#1e0010>|</span> <span style=color:#a6e22e>null</span>&gt;;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=è¿”å›ç»“æœå°è£…ç±»>è¿”å›ç»“æœå°è£…ç±»<a hidden class=anchor aria-hidden=true href=#è¿”å›ç»“æœå°è£…ç±»>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// è¿”å›ç»“æœåŸºç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeedingResult</span>&lt;<span style=color:#f92672>T</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>any</span>&gt; <span style=color:#960050;background-color:#1e0010>=</span> {}&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>level</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exp</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expProgress</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hp</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>attack</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>Reward</span>[];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>extensions</span>: <span style=color:#66d9ef>T</span> <span style=color:#f92672>=</span> {} <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>T</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>Reward</span>[]) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>current</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>expProgress</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getExpProgress</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>hp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>hp</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attack</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>attack</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>levelUpCount</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>rewards</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>rewards</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ·»åŠ æ‰©å±•æ•°æ®ï¼ˆç±»å‹å®‰å…¨ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>addExtension</span>&lt;<span style=color:#f92672>K</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>keyof</span> <span style=color:#a6e22e>T</span>&gt;(<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>K</span>, <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>T</span>[<span style=color:#a6e22e>K</span>])<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>extensions</span>[<span style=color:#a6e22e>key</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è½¬æ¢ä¸ºå“åº”å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>toResponse</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>BaseFeedingResponse</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>T</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>level</span>: <span style=color:#66d9ef>this.level</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>exp</span>: <span style=color:#66d9ef>this.exp</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expProgress</span>: <span style=color:#66d9ef>this.expProgress</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>hp</span>: <span style=color:#66d9ef>this.hp</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>attack</span>: <span style=color:#66d9ef>this.attack</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>this.levelUpCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>this.rewards</span>,
</span></span><span style=display:flex><span>      ...<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>extensions</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>BaseFeedingResponse</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>T</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=ç­–ç•¥æ¥å£å®šä¹‰>ç­–ç•¥æ¥å£å®šä¹‰<a hidden class=anchor aria-hidden=true href=#ç­–ç•¥æ¥å£å®šä¹‰>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// å–‚å…»ç­–ç•¥æ‰©å±•ç‚¹æ¥å£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IFeedingStrategy</span>&lt;<span style=color:#f92672>TResponse</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>BaseFeedingResponse </span><span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ‰©å±•ç‚¹1ï¼šè®¡ç®—ç»éªŒåŠ æˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ‰©å±•ç‚¹2ï¼šå–‚å…»å‰çš„æ ¡éªŒé€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>beforeFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>boolean</span>&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ‰©å±•ç‚¹3ï¼šå–‚å…»åçš„é¢å¤–å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ‰©å±•ç‚¹4ï¼šç”Ÿæˆå¥–åŠ±
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Reward</span>[];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ‰©å±•ç‚¹5ï¼šæ‰©å±•è¿”å›ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>extendResult</span>(<span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>FeedingResult</span>&lt;<span style=color:#f92672>any</span>&gt;, <span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æŠ½è±¡åŸºç¡€ç­–ç•¥ç±»ï¼ˆæä¾›é»˜è®¤å®ç°ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BaseFeedingStrategy</span>&lt;<span style=color:#f92672>TResponse</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>BaseFeedingResponse </span><span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>IFeedingStrategy</span>&lt;<span style=color:#f92672>TResponse</span>&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>beforeFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>boolean</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é»˜è®¤å®ç°ï¼šå…è®¸å–‚å…»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é»˜è®¤å®ç°ï¼šä¸åšä»»ä½•å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Reward</span>[];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>extendResult</span>(<span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>FeedingResult</span>&lt;<span style=color:#f92672>any</span>&gt;, <span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é»˜è®¤å®ç°ï¼šä¸åšä»»ä½•æ‰©å±•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=åº”ç”¨æœåŠ¡æ¨¡æ¿æ–¹æ³•>åº”ç”¨æœåŠ¡ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰<a hidden class=anchor aria-hidden=true href=#åº”ç”¨æœåŠ¡æ¨¡æ¿æ–¹æ³•>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// åŸºç¡€å–‚å…»åº”ç”¨æœåŠ¡ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BasePetFeedingService</span>&lt;<span style=color:#f92672>TResponse</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>BaseFeedingResponse </span><span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>petRepository</span>: <span style=color:#66d9ef>IPetRepository</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>feedingStrategy</span>: <span style=color:#66d9ef>IFeedingStrategy</span>&lt;<span style=color:#f92672>TResponse</span>&gt;
</span></span><span style=display:flex><span>  ) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰å–‚å…»æµç¨‹éª¨æ¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>feedPet</span>(<span style=color:#a6e22e>petId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>TResponse</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1. åŠ è½½èšåˆæ ¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petRepository</span>.<span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>petId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>pet</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;å® ç‰©ä¸å­˜åœ¨&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. æ‰©å±•ç‚¹ï¼šå–‚å…»å‰æ ¡éªŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>canFeed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>feedingStrategy</span>.<span style=color:#a6e22e>beforeFeed</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>foodValue</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>canFeed</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;å½“å‰æ— æ³•å–‚å…»å® ç‰©&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. æ‰©å±•ç‚¹ï¼šè®¡ç®—ç»éªŒåŠ æˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expBonus</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>feedingStrategy</span>.<span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>foodValue</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>actualFoodValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>expBonus</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. æ‰§è¡Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>oldLevel</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>feed</span>(<span style=color:#a6e22e>actualFoodValue</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newLevel</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>newLevel</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>oldLevel</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. æ‰©å±•ç‚¹ï¼šç”Ÿæˆå¥–åŠ±
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rewards</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>feedingStrategy</span>.<span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>levelUpCount</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 6. æŒä¹…åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petRepository</span>.<span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>pet</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 7. æ‰©å±•ç‚¹ï¼šå–‚å…»åå¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>feedingStrategy</span>.<span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>levelUpCount</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 8. æ„å»ºåŸºç¡€è¿”å›ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>FeedingResult</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>levelUpCount</span>, <span style=color:#a6e22e>rewards</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 9. æ‰©å±•ç‚¹ï¼šæ‰©å±•è¿”å›ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>foodValue</span>, <span style=color:#a6e22e>expBonus</span>, <span style=color:#a6e22e>actualFoodValue</span> };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>feedingStrategy</span>.<span style=color:#a6e22e>extendResult</span>(<span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>context</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 10. è¿”å›ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>toResponse</span>() <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>TResponse</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=ä¸šåŠ¡å®ç°æ‰©å±•ç‚¹>ä¸šåŠ¡å®ç°æ‰©å±•ç‚¹<a hidden class=anchor aria-hidden=true href=#ä¸šåŠ¡å®ç°æ‰©å±•ç‚¹>#</a></h5><h6 id=1-æ™®é€šå® ç‰©å–‚å…»ç­–ç•¥>1. æ™®é€šå® ç‰©å–‚å…»ç­–ç•¥<a hidden class=anchor aria-hidden=true href=#1-æ™®é€šå® ç‰©å–‚å…»ç­–ç•¥>#</a></h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// æ™®é€šå® ç‰©å–‚å…»ç­–ç•¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NormalFeedingStrategy</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseFeedingStrategy</span>&lt;<span style=color:#f92672>NormalFeedingResponse</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ™®é€šå® ç‰©æ²¡æœ‰åŠ æˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Reward</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¯å‡1çº§ç»™100é‡‘å¸
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [{
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;gold&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>levelUpCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;å® ç‰©å‡çº§å¥–åŠ±&#39;</span>
</span></span><span style=display:flex><span>    }];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>extendResult</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>FeedingResult</span>&lt;<span style=color:#f92672>NormalFeedingExtensions</span>&gt;,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ™®é€šç­–ç•¥æ·»åŠ åŸºç¡€ç»Ÿè®¡ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;feedCount&#39;</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;totalExpGained&#39;</span>, <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>actualFoodValue</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h6 id=2-vipå® ç‰©å–‚å…»ç­–ç•¥>2. VIPå® ç‰©å–‚å…»ç­–ç•¥<a hidden class=anchor aria-hidden=true href=#2-vipå® ç‰©å–‚å…»ç­–ç•¥>#</a></h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// VIPå® ç‰©å–‚å…»ç­–ç•¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VipFeedingStrategy</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseFeedingStrategy</span>&lt;<span style=color:#f92672>VipFeedingResponse</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>vipLevel</span>: <span style=color:#66d9ef>VipLevel</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// VIPç©å®¶è·å¾—ç»éªŒåŠ æˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bonusRates</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>VipLevel</span>, <span style=color:#a6e22e>number</span>&gt; <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>1</span>: <span style=color:#66d9ef>0.1</span>,  <span style=color:#75715e>// VIP1: 10%åŠ æˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>2</span>: <span style=color:#66d9ef>0.2</span>,  <span style=color:#75715e>// VIP2: 20%åŠ æˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>3</span>: <span style=color:#66d9ef>0.3</span>   <span style=color:#75715e>// VIP3: 30%åŠ æˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>bonusRates</span>[<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vipLevel</span>]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Reward</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>Reward</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åŸºç¡€é‡‘å¸å¥–åŠ±
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;gold&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>levelUpCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;å® ç‰©å‡çº§å¥–åŠ±&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// VIPé¢å¤–å¥–åŠ±
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;diamond&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vipLevel</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;VIPä¸“å±å‡çº§å¥–åŠ±&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rewards</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// VIPç©å®¶å‡çº§åå‘é€ç‰¹æ®Šé€šçŸ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`ğŸ‰ æ­å–œVIP</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vipLevel</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ç©å®¶ï¼Œå® ç‰©</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>å‡çº§åˆ°</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>çº§ï¼`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>extendResult</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>FeedingResult</span>&lt;<span style=color:#f92672>VipFeedingExtensions</span>&gt;,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// VIPç­–ç•¥æ·»åŠ VIPç‰¹æƒä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;vipLevel&#39;</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vipLevel</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;expBonus&#39;</span>, <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>expBonus</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;bonusRate&#39;</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>expBonus</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>).<span style=color:#a6e22e>toFixed</span>(<span style=color:#ae81ff>1</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¡ç®—VIPç‰¹æƒèŠ‚çœçš„æ—¶é—´ï¼ˆå‡è®¾ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>savedFeeds</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>expBonus</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>foodValue</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;vipPrivilege&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>savedFeeds</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`VIP</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vipLevel</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ç‰¹æƒä¸ºæ‚¨èŠ‚çœäº†</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>savedFeeds</span><span style=color:#e6db74>}</span><span style=color:#e6db74>æ¬¡å–‚å…»`</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h6 id=3-ä¼ è¯´å® ç‰©å–‚å…»ç­–ç•¥>3. ä¼ è¯´å® ç‰©å–‚å…»ç­–ç•¥<a hidden class=anchor aria-hidden=true href=#3-ä¼ è¯´å® ç‰©å–‚å…»ç­–ç•¥>#</a></h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// ä¼ è¯´å® ç‰©å–‚å…»ç­–ç•¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LegendaryFeedingStrategy</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseFeedingStrategy</span>&lt;<span style=color:#f92672>LegendaryFeedingResponse</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>comboCount</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// è¿å‡»æ¬¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>lastFeedTime</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>eventManager</span>: <span style=color:#66d9ef>EventManager</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>beforeFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>boolean</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¼ è¯´å® ç‰©æ¯å¤©åªèƒ½å–‚å…»3æ¬¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>feedCountToday</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getFeedCountToday</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>feedCountToday</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¡ç®—è¿å‡»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastFeedTime</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>-</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastFeedTime</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5000</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastFeedTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>now</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿å‡»åŠ æˆï¼šæ¯è¿å‡»ä¸€æ¬¡å¢åŠ 20%ç»éªŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>comboBonus</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.2</span> <span style=color:#f92672>*</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¼ è¯´å® ç‰©åŸºç¡€åŠ æˆ50%
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>legendaryBonus</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.5</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>comboBonus</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>legendaryBonus</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Reward</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>Reward</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åŸºç¡€å¥–åŠ±
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;gold&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>levelUpCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;å® ç‰©å‡çº§å¥–åŠ±&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¼ è¯´çº§å¤§é¢é’»çŸ³å¥–åŠ±
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;diamond&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>levelUpCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ä¼ è¯´å® ç‰©å‡çº§å¥–åŠ±&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿å‡»å¥–åŠ±
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;special_item&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>itemId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;legendary_food&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span><span style=color:#e6db74>}</span><span style=color:#e6db74>è¿å‡»ç‰¹æ®Šå¥–åŠ±`</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è§¦å‘ç¨€æœ‰äº‹ä»¶ï¼ˆæ¦‚ç‡ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0.1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;rare_event&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>eventId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;treasure_hunt&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;è§¦å‘ä¼ è¯´äº‹ä»¶ï¼šå¯»å®ä¹‹æ—…&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rewards</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‘å¸ƒä¼ è¯´å® ç‰©å–‚å…»äº‹ä»¶ï¼ˆä¾›å…¶ä»–ç³»ç»Ÿç›‘å¬ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>eventManager</span>.<span style=color:#a6e22e>publish</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;LegendaryPetFed&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>petId</span>: <span style=color:#66d9ef>pet.id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>level</span>: <span style=color:#66d9ef>pet.getLevel</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comboCount</span>: <span style=color:#66d9ef>this.comboCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>Date.now</span>()
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`âš¡ ä¼ è¯´å® ç‰©</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>å‡çº§ï¼å½“å‰</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span><span style=color:#e6db74>}</span><span style=color:#e6db74>è¿å‡»ï¼`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getFeedCountToday</span>(<span style=color:#a6e22e>petId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>number</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä»ç¼“å­˜æˆ–æ•°æ®åº“è·å–ä»Šæ—¥å–‚å…»æ¬¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// è¿™é‡Œç®€åŒ–å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>extendResult</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>FeedingResult</span>&lt;<span style=color:#f92672>LegendaryFeedingExtensions</span>&gt;,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¼ è¯´å® ç‰©æ·»åŠ ä¸°å¯Œçš„æ‰©å±•ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1. è¿å‡»ç³»ç»Ÿä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>comboStatus</span>: <span style=color:#66d9ef>ComboStatus</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;AMAZING!&#39;</span> <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;GREAT!&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GOOD&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;comboInfo&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comboCount</span>: <span style=color:#66d9ef>this.comboCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comboBonus</span>: <span style=color:#66d9ef>Math.floor</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.2</span> <span style=color:#f92672>*</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>nextComboAt</span>: <span style=color:#66d9ef>this.lastFeedTime</span><span style=color:#f92672>!</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5000</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comboStatus</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. ä»Šæ—¥å‰©ä½™å–‚å…»æ¬¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;dailyLimit&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>remaining</span>: <span style=color:#66d9ef>2</span>, <span style=color:#75715e>// ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>total</span>: <span style=color:#66d9ef>3</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>resetAt</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>setHours</span>(<span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. ç‰¹æ®Šäº‹ä»¶è§¦å‘è®°å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>specialRewards</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>r</span>.<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;rare_event&#39;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>.<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;special_item&#39;</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>specialRewards</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;specialEvents&#39;</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>triggered</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>events</span>: <span style=color:#66d9ef>specialRewards</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;âš¡ æ­å–œè§¦å‘ä¼ è¯´äº‹ä»¶ï¼&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. ä¼ è¯´å® ç‰©ä¸“å±ç»Ÿè®¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;legendaryStats&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>totalBonus</span>: <span style=color:#66d9ef>context.expBonus</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>legendaryBonus</span>: <span style=color:#66d9ef>Math.floor</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.5</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>efficiency</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span>((<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>actualFoodValue</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>).<span style=color:#a6e22e>toFixed</span>(<span style=color:#ae81ff>0</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rank</span>: <span style=color:#66d9ef>this.calculateRank</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>())
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>calculateRank</span>(<span style=color:#a6e22e>level</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>PetRank</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>level</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>50</span>) <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Sçº§ä¼ è¯´&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>level</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>30</span>) <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Açº§å²è¯—&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>level</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Bçº§ç¨€æœ‰&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Cçº§æ™®é€š&#39;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=ä½¿ç”¨ç¤ºä¾‹>ä½¿ç”¨ç¤ºä¾‹<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨ç¤ºä¾‹>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// æ ¹æ®ä¸åŒä¸šåŠ¡åœºæ™¯é€‰æ‹©ç­–ç•¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 1. æ™®é€šç©å®¶å–‚å…»ï¼ˆè¿”å›ç±»å‹ä¸º NormalFeedingResponseï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>normalService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>&lt;<span style=color:#f92672>NormalFeedingResponse</span>&gt;(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>petRepository</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NormalFeedingStrategy</span>()
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result1</span>: <span style=color:#66d9ef>NormalFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>normalService</span>.<span style=color:#a6e22e>feedPet</span>(<span style=color:#e6db74>&#39;pet-123&#39;</span>, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;æ™®é€šç©å®¶ç»“æœ:&#39;</span>, <span style=color:#a6e22e>result1</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>/* è¾“å‡º:
</span></span></span><span style=display:flex><span><span style=color:#75715e>{
</span></span></span><span style=display:flex><span><span style=color:#75715e>  level: 5,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  exp: 50,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  expProgress: &#39;50.00%&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  hp: 150,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  attack: 75,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  levelUpCount: 1,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  rewards: [{ type: &#39;gold&#39;, amount: 100, reason: &#39;å® ç‰©å‡çº§å¥–åŠ±&#39; }],
</span></span></span><span style=display:flex><span><span style=color:#75715e>  feedCount: 1,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  totalExpGained: 100
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 2. VIPç©å®¶å–‚å…»ï¼ˆè¿”å›ç±»å‹ä¸º VipFeedingResponseï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>vipService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>&lt;<span style=color:#f92672>VipFeedingResponse</span>&gt;(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>petRepository</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>VipFeedingStrategy</span>(<span style=color:#ae81ff>2</span>) <span style=color:#75715e>// VIPç­‰çº§2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result2</span>: <span style=color:#66d9ef>VipFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>vipService</span>.<span style=color:#a6e22e>feedPet</span>(<span style=color:#e6db74>&#39;pet-456&#39;</span>, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;VIPç©å®¶ç»“æœ:&#39;</span>, <span style=color:#a6e22e>result2</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>/* è¾“å‡º:
</span></span></span><span style=display:flex><span><span style=color:#75715e>{
</span></span></span><span style=display:flex><span><span style=color:#75715e>  level: 5,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  exp: 70,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  expProgress: &#39;70.00%&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  hp: 150,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  attack: 75,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  levelUpCount: 1,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  rewards: [
</span></span></span><span style=display:flex><span><span style=color:#75715e>    { type: &#39;gold&#39;, amount: 100, reason: &#39;å® ç‰©å‡çº§å¥–åŠ±&#39; },
</span></span></span><span style=display:flex><span><span style=color:#75715e>    { type: &#39;diamond&#39;, amount: 20, reason: &#39;VIPä¸“å±å‡çº§å¥–åŠ±&#39; }
</span></span></span><span style=display:flex><span><span style=color:#75715e>  ],
</span></span></span><span style=display:flex><span><span style=color:#75715e>  vipLevel: 2,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  expBonus: 20,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  bonusRate: &#39;20.0%&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  vipPrivilege: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    savedFeeds: 0,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    message: &#39;VIP2ç‰¹æƒä¸ºæ‚¨èŠ‚çœäº†0æ¬¡å–‚å…»&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  }
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 3. ä¼ è¯´å® ç‰©å–‚å…»ï¼ˆè¿å‡»3æ¬¡ï¼Œè¿”å›ç±»å‹ä¸º LegendaryFeedingResponseï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>legendaryService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>&lt;<span style=color:#f92672>LegendaryFeedingResponse</span>&gt;(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>petRepository</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LegendaryFeedingStrategy</span>(<span style=color:#a6e22e>eventManager</span>)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result3</span>: <span style=color:#66d9ef>LegendaryFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>legendaryService</span>.<span style=color:#a6e22e>feedPet</span>(<span style=color:#e6db74>&#39;pet-789&#39;</span>, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;ä¼ è¯´å® ç‰©ç»“æœ:&#39;</span>, <span style=color:#a6e22e>result3</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>/* è¾“å‡º:
</span></span></span><span style=display:flex><span><span style=color:#75715e>{
</span></span></span><span style=display:flex><span><span style=color:#75715e>  level: 6,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  exp: 100,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  expProgress: &#39;83.33%&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  hp: 180,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  attack: 90,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  levelUpCount: 1,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  rewards: [
</span></span></span><span style=display:flex><span><span style=color:#75715e>    { type: &#39;gold&#39;, amount: 100, reason: &#39;å® ç‰©å‡çº§å¥–åŠ±&#39; },
</span></span></span><span style=display:flex><span><span style=color:#75715e>    { type: &#39;diamond&#39;, amount: 50, reason: &#39;ä¼ è¯´å® ç‰©å‡çº§å¥–åŠ±&#39; },
</span></span></span><span style=display:flex><span><span style=color:#75715e>    { type: &#39;special_item&#39;, itemId: &#39;legendary_food&#39;, amount: 1, reason: &#39;3è¿å‡»ç‰¹æ®Šå¥–åŠ±&#39; }
</span></span></span><span style=display:flex><span><span style=color:#75715e>  ],
</span></span></span><span style=display:flex><span><span style=color:#75715e>  comboInfo: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    comboCount: 3,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    comboBonus: 40,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    nextComboAt: 1696852345000,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    comboStatus: &#39;AMAZING!&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  },
</span></span></span><span style=display:flex><span><span style=color:#75715e>  dailyLimit: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    remaining: 2,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    total: 3,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    resetAt: 1696867200000
</span></span></span><span style=display:flex><span><span style=color:#75715e>  },
</span></span></span><span style=display:flex><span><span style=color:#75715e>  specialEvents: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    triggered: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    events: [
</span></span></span><span style=display:flex><span><span style=color:#75715e>      { type: &#39;special_item&#39;, itemId: &#39;legendary_food&#39;, amount: 1, reason: &#39;3è¿å‡»ç‰¹æ®Šå¥–åŠ±&#39; }
</span></span></span><span style=display:flex><span><span style=color:#75715e>    ],
</span></span></span><span style=display:flex><span><span style=color:#75715e>    message: &#39;âš¡ æ­å–œè§¦å‘ä¼ è¯´äº‹ä»¶ï¼&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  },
</span></span></span><span style=display:flex><span><span style=color:#75715e>  legendaryStats: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    totalBonus: 90,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    legendaryBonus: 50,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    efficiency: &#39;90%&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    rank: &#39;Cçº§æ™®é€š&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  }
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><h5 id=æ‰©å±•ç‚¹æ¨¡å¼çš„ä¼˜åŠ¿>æ‰©å±•ç‚¹æ¨¡å¼çš„ä¼˜åŠ¿<a hidden class=anchor aria-hidden=true href=#æ‰©å±•ç‚¹æ¨¡å¼çš„ä¼˜åŠ¿>#</a></h5><ol><li><p><strong>å¼€é—­åŸåˆ™</strong>ï¼š</p><ul><li>æ ¸å¿ƒæµç¨‹ï¼ˆ<code>feedPet</code>æ–¹æ³•ï¼‰ä¿æŒç¨³å®š,æ— éœ€ä¿®æ”¹</li><li>æ–°å¢ä¸šåŠ¡ç±»å‹åªéœ€å®ç°æ–°çš„ç­–ç•¥ç±»</li></ul></li><li><p><strong>èŒè´£æ¸…æ™°</strong>ï¼š</p><ul><li><code>BasePetFeedingService</code>ï¼šè´Ÿè´£æµç¨‹ç¼–æ’</li><li>ç­–ç•¥ç±»ï¼šè´Ÿè´£å…·ä½“ä¸šåŠ¡é€»è¾‘</li><li>é¢†åŸŸæ¨¡å‹ï¼šè´Ÿè´£æ ¸å¿ƒä¸šåŠ¡è§„åˆ™</li><li><code>FeedingResult</code>ï¼šè´Ÿè´£ç»“æ„åŒ–è¿”å›æ•°æ®</li></ul></li><li><p><strong>è¿”å›ç»“æœå¯æ‰©å±•</strong>ï¼š</p><ul><li>å®šä¹‰äº†ç»Ÿä¸€çš„ <code>FeedingResult</code> æ¥å£</li><li>æ¯ä¸ªç­–ç•¥å¯ä»¥é€šè¿‡ <code>extendResult</code> æ·»åŠ è‡ªå·±çš„æ‰©å±•å­—æ®µ</li><li>å®¢æˆ·ç«¯è·å¾—å®Œæ•´ä¸”ç±»å‹å®‰å…¨çš„å“åº”æ•°æ®</li><li>é¿å…äº†è¿”å›ç»“æœçš„"ä¸Šå¸å¯¹è±¡"é—®é¢˜</li></ul></li><li><p><strong>æ˜“äºæµ‹è¯•</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// å¯ä»¥è½»æ¾mockç­–ç•¥è¿›è¡Œæµ‹è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;å–‚å…»æµç¨‹åº”è¯¥è°ƒç”¨æ‰€æœ‰æ‰©å±•ç‚¹&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mockStrategy</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>beforeFeed</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>fn</span>().<span style=color:#a6e22e>mockResolvedValue</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>calculateExpBonus</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>fn</span>().<span style=color:#a6e22e>mockReturnValue</span>(<span style=color:#ae81ff>50</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>generateRewards</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>fn</span>().<span style=color:#a6e22e>mockReturnValue</span>([]),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>afterFeed</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>fn</span>()
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>service</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>(<span style=color:#a6e22e>mockRepo</span>, <span style=color:#a6e22e>mockStrategy</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>feedPet</span>(<span style=color:#e6db74>&#39;pet-1&#39;</span>, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>mockStrategy</span>.<span style=color:#a6e22e>beforeFeed</span>).<span style=color:#a6e22e>toHaveBeenCalled</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>mockStrategy</span>.<span style=color:#a6e22e>calculateExpBonus</span>).<span style=color:#a6e22e>toHaveBeenCalled</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>mockStrategy</span>.<span style=color:#a6e22e>generateRewards</span>).<span style=color:#a6e22e>toHaveBeenCalled</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>mockStrategy</span>.<span style=color:#a6e22e>afterFeed</span>).<span style=color:#a6e22e>toHaveBeenCalled</span>();
</span></span><span style=display:flex><span>});
</span></span></code></pre></div></li><li><p><strong>çµæ´»ç»„åˆ</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// å¯ä»¥é€šè¿‡ç»„åˆæ¨¡å¼æ”¯æŒå¤šç§ç­–ç•¥å åŠ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CompositeStrategy</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>IFeedingStrategy</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>strategies</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>strategies</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>strategies</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>foodValue</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>strategies</span>.<span style=color:#a6e22e>reduce</span>(
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>total</span>, <span style=color:#a6e22e>strategy</span>) =&gt; <span style=color:#a6e22e>total</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>foodValue</span>),
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>levelUpCount</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>strategy</span> <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>strategies</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>levelUpCount</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åŒæ—¶åº”ç”¨VIPå’ŒèŠ‚æ—¥åŒå€ç»éªŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>compositeService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>petRepository</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CompositeStrategy</span>([
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>VipFeedingStrategy</span>(<span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>HolidayBonusStrategy</span>()
</span></span><span style=display:flex><span>  ])
</span></span><span style=display:flex><span>);
</span></span></code></pre></div></li><li><p><strong>è¿è¡Œæ—¶åˆ‡æ¢</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// å¯ä»¥æ ¹æ®è¿è¡Œæ—¶æ¡ä»¶åŠ¨æ€é€‰æ‹©ç­–ç•¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>createFeedingService</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>pet</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>strategy</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>quality</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;legendary&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LegendaryFeedingStrategy</span>(<span style=color:#a6e22e>eventManager</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>vipLevel</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>VipFeedingStrategy</span>(<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>vipLevel</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NormalFeedingStrategy</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>(<span style=color:#a6e22e>petRepository</span>, <span style=color:#a6e22e>strategy</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol><h5 id=æ¶æ„ç¤ºæ„å›¾>æ¶æ„ç¤ºæ„å›¾<a hidden class=anchor aria-hidden=true href=#æ¶æ„ç¤ºæ„å›¾>#</a></h5><pre tabindex=0><code class=language-mermaid data-lang=mermaid>classDiagram
    class BasePetFeedingService {
        -petRepository
        -feedingStrategy
        +feedPet(petId, foodValue)
    }

    class IFeedingStrategy {
        &lt;&lt;interface&gt;&gt;
        +calculateExpBonus(pet, foodValue)
        +beforeFeed(pet, foodValue)
        +afterFeed(pet, levelUpCount)
        +generateRewards(pet, levelUpCount)
    }

    class NormalFeedingStrategy {
        +calculateExpBonus()
        +generateRewards()
    }

    class VipFeedingStrategy {
        -vipLevel
        +calculateExpBonus()
        +generateRewards()
        +afterFeed()
    }

    class LegendaryFeedingStrategy {
        -eventManager
        -comboCount
        +beforeFeed()
        +calculateExpBonus()
        +generateRewards()
        +afterFeed()
    }

    BasePetFeedingService --&gt; IFeedingStrategy : ä¾èµ–
    IFeedingStrategy &lt;|.. NormalFeedingStrategy : å®ç°
    IFeedingStrategy &lt;|.. VipFeedingStrategy : å®ç°
    IFeedingStrategy &lt;|.. LegendaryFeedingStrategy : å®ç°
</code></pre><p>é€šè¿‡è¿™ç§æ‰©å±•ç‚¹è®¾è®¡,æˆ‘ä»¬å®ç°äº†ï¼š</p><ul><li><strong>ç»Ÿä¸€æµç¨‹</strong>ï¼šæ‰€æœ‰å® ç‰©å–‚å…»éƒ½éµå¾ªç›¸åŒçš„æµç¨‹éª¨æ¶</li><li><strong>å·®å¼‚åŒ–å®šåˆ¶</strong>ï¼šä¸åŒä¸šåŠ¡åœºæ™¯å¯ä»¥å®šåˆ¶è‡ªå·±çš„é€»è¾‘</li><li><strong>è§£è€¦æ‰©å±•</strong>ï¼šæ–°å¢ä¸šåŠ¡ç±»å‹ä¸å½±å“ç°æœ‰ä»£ç </li><li><strong>ä¾¿äºç»´æŠ¤</strong>ï¼šæ¯ä¸ªç­–ç•¥èŒè´£å•ä¸€,æ˜“äºç†è§£å’Œä¿®æ”¹</li></ul><p>è¿™æ­£æ˜¯ DDD ä¸­"å°†å¯å˜çš„ä¸šåŠ¡é€»è¾‘ä¸ç¨³å®šçš„æµç¨‹åˆ†ç¦»"çš„æœ€ä½³å®è·µã€‚</p><h5 id=é¡¹ç›®ç»“æ„>é¡¹ç›®ç»“æ„<a hidden class=anchor aria-hidden=true href=#é¡¹ç›®ç»“æ„>#</a></h5><p><strong>ç›®å½•ç»“æ„</strong></p><p>base ä¸­åŒ…å«åŸºç¡€è®¾æ–½ï¼ˆinfrastructureï¼‰å’ŒåŠŸèƒ½ç»„ä»¶ï¼ˆcomponentï¼‰å’Œéª¨æ¶å®ç°ï¼ˆskeletonï¼‰</p><ul><li>åŸºç¡€è®¾æ–½ä¸»è¦æŒ‡çš„æ˜¯ä¸€äº›äºŒä¸‰æ–¹çš„ä¾èµ–çš„å°è£…ï¼Œé€šè¿‡å†…éƒ¨APIçš„å½¢å¼è¿›è¡Œæä¾›</li><li>åŠŸèƒ½ç»„ä»¶å°±æ˜¯ä¸€äº›ç›¸å¯¹å®Œæ•´ï¼Œç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—</li><li>éª¨æ¶å®ç°ä¸€èˆ¬æ˜¯ä¸€äº›åŠŸèƒ½æ¥ç»´åº¦çš„é€šç”¨éª¨æ¶é€»è¾‘å®ç°ï¼ŒåŒ…å«æ¥å£è¯·æ±‚æ¥çš„å‚æ•°æ ¡éªŒã€æ ¸å¿ƒå¤„ç†ã€ç»“æ„å°è£…è¿”å›ç­‰</li></ul><p>sdk æ˜¯æ¥å£å®šä¹‰å’Œå¥‘çº¦å±‚ï¼Œbase ä¸­é’ˆå¯¹SDK ä¸­å®šä¹‰çš„æ¥å£è¿›è¡Œå®ç°ï¼Œsdk ä¸­ä¸»è¦åŒ…å«ç³»ç»Ÿçš„æ‰€æœ‰æ¥å£ã€ç­–ç•¥æ‰©å±•ç‚¹ã€æ•°æ®æ¨¡å‹ã€å¸¸é‡å’Œå·¥å…·ç±»</p><p>module åˆ™æ˜¯å…·ä½“çš„æ¸¸æˆä¸šåŠ¡å®ç°ï¼Œä¼šå¼•ç”¨SDKï¼Œä½†æ˜¯ä¸ç›´æ¥å¼•ç”¨baseï¼Œå®Œæˆå…·ä½“çš„ç­–ç•¥æ‰©å±•ç‚¹çš„é‡å†™ï¼Œä»è€Œå®ç°å®šåˆ¶åŒ–çš„ä¸šåŠ¡åŠŸèƒ½</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>.
</span></span><span style=display:flex><span>â”œâ”€â”€ base
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€ component
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€ infrastructure
</span></span><span style=display:flex><span>â”‚   â””â”€â”€ skeleton
</span></span><span style=display:flex><span>â”œâ”€â”€ sdk
</span></span><span style=display:flex><span>â””â”€â”€ module
</span></span><span style=display:flex><span>    â””â”€â”€ gameBusiness
</span></span></code></pre></div><p><strong>ä¾èµ–å…³ç³»å›¾</strong></p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>flowchart TB
 subgraph subGraph0[&#34;ä¸šåŠ¡æ¨¡å—å±‚ (module)&#34;]
        PM[&#34;promotion-module&#34;]
        P618[&#34;promotion618&#34;]
        P1111[&#34;promotion1111&#34;]
  end
 subgraph subGraph1[&#34;SDKå±‚ (sdk)&#34;]
        SDK[&#34;sdk&#34;]
        SDK_COMMON[&#34;sdk/common&#34;]
        SDK_COMPONENT[&#34;sdk/component&#34;]
        SDK_INFRA[&#34;sdk/infrastructure&#34;]
        SDK_SKELETON[&#34;sdk/skeleton&#34;]
  end
 subgraph subGraph2[&#34;åŸºç¡€å®ç°å±‚ (base)&#34;]
        BASE[&#34;base&#34;]
        BASE_INFRA[&#34;infrastructure&#34;]
        BASE_COMPONENT[&#34;component&#34;]
        BASE_SKELETON[&#34;skeleton&#34;]
        BASE_DRAW[&#34;draw&#34;]
        BASE_PET[&#34;pet&#34;]
  end
    PM --&gt; P618 &amp; P1111
    SDK --&gt; SDK_COMMON &amp; SDK_COMPONENT &amp; SDK_INFRA &amp; SDK_SKELETON
    BASE --&gt; BASE_INFRA &amp; BASE_COMPONENT &amp; BASE_SKELETON
    BASE_COMPONENT --&gt; BASE_DRAW
    BASE_SKELETON --&gt; BASE_PET
    PM -. ä¾èµ– .-&gt; SDK
    P618 -. ä¾èµ– .-&gt; SDK
    P1111 -. ä¾èµ– .-&gt; SDK
    BASE_INFRA -. ä¾èµ– .-&gt; SDK
    BASE_COMPONENT -. ä¾èµ– .-&gt; SDK &amp; BASE_INFRA
    BASE_SKELETON -. ä¾èµ– .-&gt; SDK &amp; BASE_INFRA
</code></pre><h4 id=dddæ–¹å¼çš„ä¼˜åŠ¿>DDDæ–¹å¼çš„ä¼˜åŠ¿<a hidden class=anchor aria-hidden=true href=#dddæ–¹å¼çš„ä¼˜åŠ¿>#</a></h4><p>é€šè¿‡ä¸Šé¢çš„å¯¹æ¯”å¯ä»¥çœ‹åˆ°ï¼š</p><ol><li><p><strong>ä¸šåŠ¡é€»è¾‘å†…èš</strong>ï¼š</p><ul><li>ç»éªŒè®¡ç®—ã€å‡çº§åˆ¤æ–­ã€å±æ€§æå‡éƒ½å°è£…åœ¨å¯¹åº”çš„é¢†åŸŸå¯¹è±¡ä¸­</li><li>Serviceå±‚å˜å¾—éå¸¸è–„ï¼Œåªè´Ÿè´£ç¼–æ’</li></ul></li><li><p><strong>æ˜“äºæµ‹è¯•</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// å•å…ƒæµ‹è¯•ä¸éœ€è¦æ•°æ®åº“
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;å® ç‰©å–‚å…»ååº”è¯¥è·å¾—ç»éªŒ&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Pet</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;1&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Pikachu&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;rare&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;rare&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetStats</span>(<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;rare&#39;</span>)
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>feed</span>(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>current</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;å²è¯—å® ç‰©å‡çº§æ‰€éœ€ç»éªŒæ›´å¤š&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>exp1</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;common&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>exp2</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;epic&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>exp2</span>.<span style=color:#a6e22e>getRequiredForNextLevel</span>())
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>toBeGreaterThan</span>(<span style=color:#a6e22e>exp1</span>.<span style=color:#a6e22e>getRequiredForNextLevel</span>());
</span></span><span style=display:flex><span>});
</span></span></code></pre></div></li><li><p><strong>ä¸šåŠ¡è§„åˆ™æ¸…æ™°å¯è§</strong>ï¼š</p><ul><li>ä»£ç ç›´æ¥è¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µï¼š<code>pet.feed()</code>, <code>experience.canLevelUp()</code></li><li>æ–°äººå¯ä»¥é€šè¿‡é˜…è¯»é¢†åŸŸæ¨¡å‹å¿«é€Ÿç†è§£ä¸šåŠ¡</li></ul></li><li><p><strong>æ˜“äºæ‰©å±•</strong>ï¼š</p><ul><li>æ·»åŠ æ–°å“è´¨çš„å® ç‰©ï¼Ÿåªéœ€ä¿®æ”¹å€¼å¯¹è±¡ä¸­çš„é…ç½®</li><li>ä¿®æ”¹å‡çº§å…¬å¼ï¼Ÿåªåœ¨Experienceä¸­ä¿®æ”¹</li><li>æ·»åŠ æ–°çš„å® ç‰©è¡Œä¸ºï¼Ÿåœ¨Petå®ä½“ä¸­æ·»åŠ æ–¹æ³•</li></ul></li><li><p><strong>äº‹ä»¶é©±åŠ¨</strong>ï¼š</p><ul><li>é€šè¿‡é¢†åŸŸäº‹ä»¶è§£è€¦å‰¯ä½œç”¨ï¼ˆé€šçŸ¥ã€æ—¥å¿—ã€ç»Ÿè®¡ç­‰ï¼‰</li><li>ä¾¿äºå®ç°å¤æ‚çš„ä¸šåŠ¡æµç¨‹</li></ul></li><li><p><strong>çŠ¶æ€ä¸€è‡´æ€§</strong>ï¼š</p><ul><li>èšåˆæ ¹ä¿è¯å® ç‰©çŠ¶æ€çš„ä¸€è‡´æ€§</li><li>ä¸ä¼šå‡ºç°"ç»éªŒå·²æ‰£é™¤ä½†ç­‰çº§æœªæå‡"çš„æƒ…å†µ</li></ul></li></ol><h2 id=nodejsä¸Šç°æœ‰çš„å®ç°>NodeJSä¸Šç°æœ‰çš„å®ç°<a hidden class=anchor aria-hidden=true href=#nodejsä¸Šç°æœ‰çš„å®ç°>#</a></h2><p><a href=https://github.com/stemmlerjs/white-label>white-label</a>æ˜¯åŸºäºæºç çº§åˆ«çš„ <code>Domain-Driven Design Demo</code>ï¼Œæœ‰éå¸¸é«˜çš„å‚è€ƒæ€§</p><p><a href=https://github.com/4lessandrodev/type-ddd>type-ddd</a> è¿™ä¸ªæ˜¯<code>NodeJS</code>ä¸­é’ˆå¯¹æ˜¯ <code>Domain-Driven Design</code> çš„ä¸€ä¸ªå°è£…ï¼Œä¸»è¦æ˜¯æä¾›<code>utils</code>ã€ <code>Entity</code>ã€<code>Value Objects</code>ã€<code>Factories</code>ã€<code>Aggregates</code>ã€<code>Repository</code>ã€<code>Domain events</code>ç­‰æ¥å»ºç«‹å¤æ‚çš„åº”ç”¨ï¼Œå¯ä»¥çœ‹ä¸‹é¡¹ç›®çš„ <code>README</code> æœ‰æœ€åŸºæœ¬çš„ç”¨æ³•ç¤ºä¾‹</p><p>é’ˆå¯¹è¿™ä¸¤ä¸ªé¡¹ç›®ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ <code>white-label</code>ï¼Œä¹‹åå®è·µè¿‡ç¨‹ä¸­åˆ™å¯ä»¥ä½¿ç”¨ <code>type-ddd</code> è¿›è¡Œå…·ä½“çš„ç¼–ç å®ç°</p><h2 id=å‚è€ƒèµ„æ–™>å‚è€ƒèµ„æ–™<a hidden class=anchor aria-hidden=true href=#å‚è€ƒèµ„æ–™>#</a></h2><ul><li>DDDä¸­ç±»å‹æ¥å£ï¼š<a href=https://github.com/4lessandrodev/type-ddd>https://github.com/4lessandrodev/type-ddd</a></li><li>DDDæ•™ç¨‹ï¼š<a href=https://github.com/stemmlerjs/ddd-forum>https://github.com/stemmlerjs/ddd-forum</a></li><li>NodeJS ä¸­çš„ç¤ºä¾‹ï¼š <a href=https://github.com/stemmlerjs/white-label>https://github.com/stemmlerjs/white-label</a></li><li>Rich-Domain:<a href=https://github.com/4lessandrodev/rich-domain>https://github.com/4lessandrodev/rich-domain</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://genluo.github.io/my-blog/tags/%E6%9C%8D%E5%8A%A1%E7%AB%AF/>æœåŠ¡ç«¯</a></li></ul><nav class=paginav><a class=prev href=https://genluo.github.io/my-blog/posts/agent/><span class=title>Â« Prev</span><br><span>Agent æŠ€æœ¯è°ƒç ”</span>
</a><a class=next href=https://genluo.github.io/my-blog/posts/clangformat/><span class=title>Next Â»</span><br><span>Clangformat</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share é¢†åŸŸé©±åŠ¨è®¾è®¡ on x" href="https://x.com/intent/tweet/?text=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1&amp;url=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f&amp;hashtags=%e6%9c%8d%e5%8a%a1%e7%ab%af"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share é¢†åŸŸé©±åŠ¨è®¾è®¡ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f&amp;title=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1&amp;summary=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1&amp;source=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share é¢†åŸŸé©±åŠ¨è®¾è®¡ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f&title=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share é¢†åŸŸé©±åŠ¨è®¾è®¡ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share é¢†åŸŸé©±åŠ¨è®¾è®¡ on whatsapp" href="https://api.whatsapp.com/send?text=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1%20-%20https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share é¢†åŸŸé©±åŠ¨è®¾è®¡ on telegram" href="https://telegram.me/share/url?text=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1&amp;url=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share é¢†åŸŸé©±åŠ¨è®¾è®¡ on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1&u=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://genluo.github.io/my-blog/>Genluo</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>