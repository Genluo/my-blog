<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>领域驱动设计 | Genluo</title><meta name=keywords content="服务端"><meta name=description content="服务端中的领域驱动设计的应用及其解析"><meta name=author content><link rel=canonical href=https://genluo.github.io/my-blog/posts/ddd/><link crossorigin=anonymous href=/my-blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://genluo.github.io/my-blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://genluo.github.io/my-blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://genluo.github.io/my-blog/favicon-32x32.png><link rel=apple-touch-icon href=https://genluo.github.io/my-blog/apple-touch-icon.png><link rel=mask-icon href=https://genluo.github.io/my-blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://genluo.github.io/my-blog/posts/ddd/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){mermaid.init({theme:"dark"},".language-mermaid")})</script><style>.language-mermaid{display:flex;justify-content:center}.post-content h4{font-size:20px!important}.post-content h5{font-size:18px!important}.post-content h6{font-size:16px!important}.language-mermaid code{display:flex;justify-content:center}</style><meta property="og:url" content="https://genluo.github.io/my-blog/posts/ddd/"><meta property="og:site_name" content="Genluo"><meta property="og:title" content="领域驱动设计"><meta property="og:description" content="服务端中的领域驱动设计的应用及其解析"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-01T10:16:15+08:00"><meta property="article:modified_time" content="2025-09-01T10:16:15+08:00"><meta property="article:tag" content="服务端"><meta name=twitter:card content="summary"><meta name=twitter:title content="领域驱动设计"><meta name=twitter:description content="服务端中的领域驱动设计的应用及其解析"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://genluo.github.io/my-blog/posts/"},{"@type":"ListItem","position":2,"name":"领域驱动设计","item":"https://genluo.github.io/my-blog/posts/ddd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"领域驱动设计","name":"领域驱动设计","description":"服务端中的领域驱动设计的应用及其解析","keywords":["服务端"],"articleBody":"契机 最近因为一些契机看了下互动小游戏的服务端，深入了解了下现在互动游戏服务端的架构，同时也尝试在这个架构的基础上使用 AI 进行一些游戏业务功能开发，其中印象最深的服务端的一个称之为基座的架构设计，这个基座架构深度使用 DDD 领域设计思想进行抽象实现，在游戏业务非常灵活，复用性非常高，所以想看下在NodeJS 中针对 DDD领域驱动设计是否有一定的实践。下面主要分为两个部分，一个是为什么是DDD？另一个 NodeJS中一些实践\nDDD 什么是领域驱动设计（domain driving design） 领域驱动设计是一种软件设计方法，用于表示和组织特定领域中的知识和业务逻辑。它主要通过创建抽象的模型对象来模拟现实世界的实体及其关系，帮助开发人员理解和实现复杂系统的业务逻辑。在领域驱动设计中，通常会包含以下几个关键概念：\n实体（Entity）：具有唯一标识的对象，通常表示业务中的一个独立的概念或对象。例如，在一个订单系统中，订单和客户可以被视为实体。\n值对象（Value Object）：没有唯一标识的对象，通常用于描述某个实体的属性或细节。它们是不可变的，两个值对象如果具有相同的属性值，则认为是相等的。例如，一个地址可以作为一个值对象。\n聚合（Aggregate）：一组相关的对象（实体和值对象）的集合，它们被视为一个单元进行数据修改。聚合有一个根实体（Aggregate Root），通过根实体来管理聚合的生命周期。\n领域服务（Domain Service）：封装领域逻辑的操作，这些操作不属于任何一个实体或值对象。它们通常用于表示跨越多个实体或值对象的业务逻辑。\n仓储（Repository）：提供访问持久化存储中对象的方法，通常用于获取和保存聚合根。\n什么是聚合根 指的是一个聚合中具有唯一标识的核心实体，该实体负责控制整个聚合的生命周期和一致性。\n控制访问：聚合根是聚合内的唯一入口点，外部对象只能通过聚合根来访问或操作聚合中的其它对象。这有助于保持聚合内部的完整性和一致性。\n管理生命周期：聚合根负责管理聚合内所有对象的生命周期，包括创建、更新和删除操作。通过聚合根，可以确保对聚合中数据的任何修改都是合法和一致的。\n一致性边界：聚合定义了一个一致性边界，其中的所有对象在事务中应该保持一致。因此，聚合根通过确保在其范围内的操作都是一致的，来维持这种边界。\n唯一性：每个聚合都有一个唯一的聚合根。通常，聚合根具有唯一标识符，用来标识和访问该聚合。\n持久化管理：通过仓储（Repository）模式，聚合根通常是持久化操作（如保存和检索）的主要对象。这意味着仓储通常只直接处理聚合根，而不是聚合内的其它对象。\n领域驱动设计优缺点 领域驱动设计（Domain-Driven Design, DDD）是一种软件设计方法，旨在通过紧密结合业务需求和技术实现来构建复杂软件系统。以下是领域驱动设计的一些优缺点：\n优点 更好地理解业务：\nDDD强调与领域专家的密切合作，使开发团队对业务需求有更深入的理解。这有助于创建更符合业务需求的系统。 清晰的模型：\n通过使用统一语言和领域模型，所有团队成员（包括技术人员和非技术人员）都可以在同一语境下沟通，从而减少误解。 灵活性和可维护性：\nDDD鼓励模块化设计，如界限上下文（Bounded Context）和聚合（Aggregate），这些设计有助于简化系统的维护和扩展。 关注核心领域：\n通过识别和聚焦于核心领域，DDD帮助团队将资源集中在对业务最重要的部分，从而提高竞争力。 支持复杂系统开发：\nDDD为处理复杂领域逻辑提供了有力的方法和工具，可以有效地管理复杂性。 缺点 学习曲线陡峭：\n对许多开发人员和组织来说，DDD的概念和技术术语可能较为陌生，初始学习和实施成本较高。 时间和资源投入大：\n由于需要深度的领域分析和持续的团队协作，DDD可能比传统方法花费更多时间和资源。 不适合所有项目：\n对于简单或小型项目，DDD可能过于复杂和冗余，投入的成本和收益不成比例。 需求稳定性要求高：\nDDD更适合于需求相对稳定且对业务逻辑要求高的项目。对于需求频繁变化的项目，可能需要经常重构。 对团队协作要求高：\n成功实施DDD需要团队成员之间良好的沟通和协作，这对团队的组织文化和沟通能力提出了较高要求。 为什么需要领域模型 在传统的软件开发中,我们常常遇到以下问题：\n1. 贫血模型的困境 传统的开发方式往往采用\"贫血模型\"（Anemic Domain Model），即：\n数据对象只包含字段和简单的 getter/setter，没有任何业务逻辑 所有业务逻辑集中在 Service 层，形成庞大的服务类 数据和行为分离，导致代码难以理解和维护 2. 业务逻辑散乱 缺乏统一的业务规则管理：同样的业务逻辑可能在多个地方重复实现 难以保证一致性：订单创建、修改、取消等操作中的业务规则可能不一致 维护成本高：修改一个业务规则需要在多个地方查找和修改 3. 技术与业务脱节 代码难以反映业务意图：开发人员看到的是表、字段、SQL，而不是订单、支付、发货等业务概念 与领域专家沟通困难：技术术语和业务术语无法对应，容易产生理解偏差 需求变更代价大：业务调整时，需要从底层数据结构开始重新设计 领域模型如何解决这些问题 领域模型通过以下方式解决上述问题：\n1. 封装业务逻辑 // 充血模型示例 class Order { constructor(id, userId) { this.id = id; this.userId = userId; this.items = []; this.status = 'PENDING'; } // 业务逻辑封装在实体内部 addItem(product, quantity) { if (this.status !== 'PENDING') { throw new Error('只能向待处理订单添加商品'); } if (quantity \u003c= 0) { throw new Error('商品数量必须大于0'); } this.items.push({ product, quantity }); } submit() { if (this.items.length === 0) { throw new Error('订单不能为空'); } this.status = 'SUBMITTED'; // 触发领域事件 this.addDomainEvent(new OrderSubmittedEvent(this)); } calculateTotal() { return this.items.reduce((sum, item) =\u003e sum + item.product.price * item.quantity, 0); } } 2. 统一语言（Ubiquitous Language） 代码中的类名、方法名直接对应业务概念 开发人员和领域专家使用相同的术语 代码即文档，业务规则清晰可见 3. 维护业务不变性（Invariants） 通过聚合根控制状态变更 确保对象始终处于有效状态 业务规则在一个地方定义和维护 4. 降低认知负担 每个领域对象职责清晰 业务逻辑内聚，易于理解和测试 修改影响范围可控 实践价值 引入领域模型后，带来的实际价值：\n代码可读性提升：新人可以通过阅读领域模型快速理解业务 维护成本降低：业务规则集中管理，修改影响范围明确 测试更容易：领域对象可以独立测试，不依赖数据库和外部服务 应对复杂度：当业务逻辑变得复杂时，领域模型的优势更加明显 长期价值：随着项目演进，领域模型帮助保持代码质量和架构清晰度 总结：领域模型不是银弹，但对于业务逻辑复杂的系统来说，它提供了一种更加贴近业务、易于维护的代码组织方式。通过将数据和行为结合，领域模型让代码真正成为业务知识的表达\n举例 下面通过一个游戏中的\"宠物喂养升级\"模型来展示如何使用DDD进行设计\n业务场景 在一个宠物养成游戏中，玩家可以：\n喂养宠物获得经验值 宠物经验值达到一定数量后进行升级 宠物升级后有对应的奖励物 最终根据宠物的奖励物发放对应的奖励 业务流程图 stateDiagram-v2 [*] --\u003e 待喂养: 宠物初始状态 待喂养 --\u003e 增加经验: 玩家喂养食物 增加经验 --\u003e 检查升级条件: 经验值累加 检查升级条件 --\u003e 升级中: 经验值 \u003e= 所需经验 检查升级条件 --\u003e 待喂养: 经验值 \u003c 所需经验 升级中 --\u003e 属性提升: 消耗经验值 属性提升 --\u003e 奖励生成: 等级+1, 属性增加 奖励生成 --\u003e 检查升级条件: 继续检查是否能再次升级 奖励生成 --\u003e 发放奖励: 所有升级完成 发放奖励 --\u003e 待喂养: 奖励发放完毕 note right of 检查升级条件 不同品质宠物 所需经验不同 - 普通: 1.0x - 稀有: 1.2x - 史诗: 1.5x end note note right of 属性提升 属性增长公式 HP: +10 * 品质倍率 Attack: +5 * 品质倍率 end note 状态说明：\n待喂养：宠物的正常状态，等待玩家投喂食物 增加经验：喂养后经验值增加的瞬时状态 检查升级条件：判断当前经验是否足够升级（支持连续升级） 升级中：消耗经验值，进行等级提升 属性提升：根据品质倍率计算新的属性值 奖励生成：基于升级结果生成奖励物品 发放奖励：将奖励物品发放给玩家 传统实现方式 // 数据模型 class Pet { id; name; level; exp; quality; // 品质：普通、稀有、史诗 hp; attack; } // Service层处理所有业务逻辑 class PetService { async feed(petId, foodValue) { // 1. 查询宠物 const pet = await db.query('SELECT * FROM pets WHERE id = ?', [petId]); // 2. 计算经验值 pet.exp += foodValue; // 3. 检查是否升级（逻辑分散） let levelUpCount = 0; while (pet.exp \u003e= this.getRequiredExp(pet.level, pet.quality)) { pet.exp -= this.getRequiredExp(pet.level, pet.quality); pet.level += 1; levelUpCount++; } // 4. 升级后属性计算（逻辑复杂且容易出错） if (levelUpCount \u003e 0) { pet.hp += levelUpCount * 10 * this.getQualityMultiplier(pet.quality); pet.attack += levelUpCount * 5 * this.getQualityMultiplier(pet.quality); // 5. 发送通知 await this.sendLevelUpNotification(petId, pet.level); } // 6. 保存 await db.query('UPDATE pets SET level=?, exp=?, hp=?, attack=? WHERE id=?', [pet.level, pet.exp, pet.hp, pet.attack, petId]); return pet; } getRequiredExp(level, quality) { // 升级所需经验计算逻辑 const base = 100 * level; return quality === 'epic' ? base * 1.5 : quality === 'rare' ? base * 1.2 : base; } getQualityMultiplier(quality) { return quality === 'epic' ? 1.5 : quality === 'rare' ? 1.2 : 1.0; } } 问题：\n业务逻辑全在Service层，代码臃肿 Pet只是数据容器，没有行为 升级规则、属性计算散落各处 难以保证宠物状态的一致性 测试困难，需要mock数据库 DDD实现方式 1. 值对象（Value Object）- 经验值 // 值对象：经验值 class Experience { constructor(current, level, quality) { if (current \u003c 0) throw new Error('经验值不能为负'); this.current = current; this.level = level; this.quality = quality; } // 获取升级所需经验 getRequiredForNextLevel() { const baseExp = 100 * this.level; const multiplier = { 'common': 1.0, 'rare': 1.2, 'epic': 1.5 }[this.quality] || 1.0; return Math.floor(baseExp * multiplier); } // 添加经验，返回新的Experience对象（值对象不可变） add(value) { return new Experience( this.current + value, this.level, this.quality ); } // 检查是否可以升级 canLevelUp() { return this.current \u003e= this.getRequiredForNextLevel(); } // 消耗升级所需经验 consumeForLevelUp() { const required = this.getRequiredForNextLevel(); return new Experience( this.current - required, this.level + 1, this.quality ); } } 2. 值对象 - 宠物属性 // 值对象：属性 class PetStats { constructor(hp, attack, level, quality) { this.hp = hp; this.attack = attack; this.level = level; this.quality = quality; } // 升级后的属性 levelUp() { const multiplier = { 'common': 1.0, 'rare': 1.2, 'epic': 1.5 }[this.quality] || 1.0; return new PetStats( this.hp + Math.floor(10 * multiplier), this.attack + Math.floor(5 * multiplier), this.level + 1, this.quality ); } } 3. 领域事件 // 领域事件：宠物升级事件 class PetLeveledUpEvent { constructor(petId, oldLevel, newLevel, stats) { this.petId = petId; this.oldLevel = oldLevel; this.newLevel = newLevel; this.stats = stats; this.occurredAt = new Date(); } } // 领域事件：宠物喂养事件 class PetFedEvent { constructor(petId, foodValue, gainedExp) { this.petId = petId; this.foodValue = foodValue; this.gainedExp = gainedExp; this.occurredAt = new Date(); } } 4. 实体/聚合根 - 宠物 // 聚合根：宠物 class Pet { constructor(id, name, quality, experience, stats) { this.id = id; this.name = name; this.quality = quality; // 'common', 'rare', 'epic' this.experience = experience; // Experience值对象 this.stats = stats; // PetStats值对象 this.domainEvents = []; // 领域事件列表 } // 喂养宠物 feed(foodValue) { if (foodValue \u003c= 0) { throw new Error('食物价值必须大于0'); } // 添加经验 const oldExp = this.experience; this.experience = this.experience.add(foodValue); // 记录喂养事件 this.addDomainEvent(new PetFedEvent( this.id, foodValue, foodValue )); // 尝试升级 this.tryLevelUp(); } // 尝试升级（私有业务逻辑） tryLevelUp() { let levelUpCount = 0; // 循环升级（处理一次喂养多次升级的情况） while (this.experience.canLevelUp()) { const oldLevel = this.stats.level; // 消耗经验 this.experience = this.experience.consumeForLevelUp(); // 提升属性 this.stats = this.stats.levelUp(); levelUpCount++; // 触发升级事件 this.addDomainEvent(new PetLeveledUpEvent( this.id, oldLevel, this.stats.level, { hp: this.stats.hp, attack: this.stats.attack } )); } return levelUpCount; } // 添加领域事件 addDomainEvent(event) { this.domainEvents.push(event); } // 获取并清空领域事件 pullDomainEvents() { const events = [...this.domainEvents]; this.domainEvents = []; return events; } // 获取当前等级 getLevel() { return this.stats.level; } // 获取当前经验进度（百分比） getExpProgress() { const required = this.experience.getRequiredForNextLevel(); return (this.experience.current / required * 100).toFixed(2); } } 5. 仓储接口 // 仓储接口 class IPetRepository { async findById(petId) { throw new Error('Not implemented'); } async save(pet) { throw new Error('Not implemented'); } } // 仓储实现 class PetRepository extends IPetRepository { constructor(db) { super(); this.db = db; } async findById(petId) { const data = await this.db.query( 'SELECT * FROM pets WHERE id = ?', [petId] ); if (!data) return null; // 从数据重建领域对象 return new Pet( data.id, data.name, data.quality, new Experience(data.exp, data.level, data.quality), new PetStats(data.hp, data.attack, data.level, data.quality) ); } async save(pet) { // 保存聚合根 await this.db.query( `UPDATE pets SET level = ?, exp = ?, hp = ?, attack = ? WHERE id = ?`, [ pet.stats.level, pet.experience.current, pet.stats.hp, pet.stats.attack, pet.id ] ); // 发布领域事件 const events = pet.pullDomainEvents(); for (const event of events) { await this.publishEvent(event); } } async publishEvent(event) { // 发布事件到事件总线 // 例如：发送通知、更新排行榜等 console.log('Domain Event:', event); } } 6. 应用服务（简洁的业务逻辑编排层） // 应用服务：只负责编排，不包含业务逻辑 class PetApplicationService { constructor(petRepository) { this.petRepository = petRepository; } async feedPet(petId, foodValue) { // 1. 加载聚合根 const pet = await this.petRepository.findById(petId); if (!pet) { throw new Error('宠物不存在'); } // 2. 执行业务逻辑（在领域模型中） pet.feed(foodValue); // 3. 持久化 await this.petRepository.save(pet); // 4. 返回结果 return { level: pet.getLevel(), exp: pet.experience.current, expProgress: pet.getExpProgress(), hp: pet.stats.hp, attack: pet.stats.attack }; } } 7. 使用示例 // 使用 const petService = new PetApplicationService(petRepository); // 喂养宠物 const result = await petService.feedPet('pet-123', 250); console.log(`宠物升级到${result.level}级，经验进度${result.expProgress}%`); // 业务逻辑都在领域模型中，应用服务非常简洁 更进一步 在实际业务中,我们常常需要在保持核心流程不变的情况下,允许不同的业务场景有定制化的逻辑。这时可以进一步通过扩展点模式来实现。\n业务场景扩展 假设我们的宠物系统需要支持不同类型的喂养策略：\n普通宠物：直接获得经验 VIP宠物：获得经验加成,并有额外的属性提升 传说宠物：喂养时触发特殊效果,可能获得额外奖励 完整类型定义 首先,定义完整的类型系统：\n// ============= 基础类型定义 ============= // 奖励类型 type RewardType = 'gold' | 'diamond' | 'special_item' | 'rare_event'; // 奖励接口 interface Reward { type: RewardType; amount?: number; itemId?: string; eventId?: string; reason: string; } // 连击状态 type ComboStatus = 'GOOD' | 'GREAT!' | 'AMAZING!'; // 宠物等级评级 type PetRank = 'C级普通' | 'B级稀有' | 'A级史诗' | 'S级传说'; // VIP等级 type VipLevel = 1 | 2 | 3; // ============= 扩展字段类型定义 ============= // VIP特权信息 interface VipPrivilege { savedFeeds: number; message: string; } // 连击信息 interface ComboInfo { comboCount: number; comboBonus: number; nextComboAt: number; comboStatus: ComboStatus; } // 每日限制信息 interface DailyLimit { remaining: number; total: number; resetAt: number; } // 特殊事件信息 interface SpecialEvents { triggered: boolean; events: Reward[]; message: string; } // 传说统计信息 interface LegendaryStats { totalBonus: number; legendaryBonus: number; efficiency: string; rank: PetRank; } // ============= 返回结果类型定义 ============= // 基础返回结果接口 interface BaseFeedingResponse { level: number; exp: number; expProgress: string; hp: number; attack: number; levelUpCount: number; rewards: Reward[]; } // 普通策略扩展字段 interface NormalFeedingExtensions { feedCount: number; totalExpGained: number; } // VIP策略扩展字段 interface VipFeedingExtensions { vipLevel: VipLevel; expBonus: number; bonusRate: string; vipPrivilege: VipPrivilege; } // 传说策略扩展字段 interface LegendaryFeedingExtensions { comboInfo: ComboInfo; dailyLimit: DailyLimit; specialEvents?: SpecialEvents; legendaryStats: LegendaryStats; } // 组合返回类型 type NormalFeedingResponse = BaseFeedingResponse \u0026 NormalFeedingExtensions; type VipFeedingResponse = BaseFeedingResponse \u0026 VipFeedingExtensions; type LegendaryFeedingResponse = BaseFeedingResponse \u0026 LegendaryFeedingExtensions; // ============= 上下文类型定义 ============= interface FeedingContext { foodValue: number; expBonus: number; actualFoodValue: number; } // ============= 事件管理器接口 ============= interface EventManager { publish(event: any): Promise\u003cvoid\u003e; } // ============= Pet 相关接口（简化版） ============= interface Pet { id: string; name: string; quality: string; experience: any; stats: any; feed(foodValue: number): void; getLevel(): number; getExpProgress(): string; } interface IPetRepository { findById(petId: string): Promise\u003cPet | null\u003e; save(pet: Pet): Promise\u003cvoid\u003e; } 返回结果封装类 // 返回结果基类 class FeedingResult\u003cT extends Record\u003cstring, any\u003e = {}\u003e { level: number; exp: number; expProgress: string; hp: number; attack: number; levelUpCount: number; rewards: Reward[]; private extensions: T = {} as T; constructor(pet: Pet, levelUpCount: number, rewards: Reward[]) { this.level = pet.getLevel(); this.exp = pet.experience.current; this.expProgress = pet.getExpProgress(); this.hp = pet.stats.hp; this.attack = pet.stats.attack; this.levelUpCount = levelUpCount; this.rewards = rewards; } // 添加扩展数据（类型安全） addExtension\u003cK extends keyof T\u003e(key: K, value: T[K]): void { this.extensions[key] = value; } // 转换为响应对象 toResponse(): BaseFeedingResponse \u0026 T { return { level: this.level, exp: this.exp, expProgress: this.expProgress, hp: this.hp, attack: this.attack, levelUpCount: this.levelUpCount, rewards: this.rewards, ...this.extensions } as BaseFeedingResponse \u0026 T; } } 策略接口定义 // 喂养策略扩展点接口 interface IFeedingStrategy\u003cTResponse extends BaseFeedingResponse = BaseFeedingResponse\u003e { // 扩展点1：计算经验加成 calculateExpBonus(pet: Pet, foodValue: number): number; // 扩展点2：喂养前的校验逻辑 beforeFeed(pet: Pet, foodValue: number): Promise\u003cboolean\u003e; // 扩展点3：喂养后的额外处理 afterFeed(pet: Pet, levelUpCount: number): Promise\u003cvoid\u003e; // 扩展点4：生成奖励 generateRewards(pet: Pet, levelUpCount: number): Reward[]; // 扩展点5：扩展返回结果 extendResult(result: FeedingResult\u003cany\u003e, pet: Pet, context: FeedingContext): void; } // 抽象基础策略类（提供默认实现） abstract class BaseFeedingStrategy\u003cTResponse extends BaseFeedingResponse = BaseFeedingResponse\u003e implements IFeedingStrategy\u003cTResponse\u003e { abstract calculateExpBonus(pet: Pet, foodValue: number): number; async beforeFeed(pet: Pet, foodValue: number): Promise\u003cboolean\u003e { // 默认实现：允许喂养 return true; } async afterFeed(pet: Pet, levelUpCount: number): Promise\u003cvoid\u003e { // 默认实现：不做任何处理 } abstract generateRewards(pet: Pet, levelUpCount: number): Reward[]; extendResult(result: FeedingResult\u003cany\u003e, pet: Pet, context: FeedingContext): void { // 默认实现：不做任何扩展 } } 应用服务（模板方法） // 基础喂养应用服务（模板方法） class BasePetFeedingService\u003cTResponse extends BaseFeedingResponse = BaseFeedingResponse\u003e { constructor( private readonly petRepository: IPetRepository, private readonly feedingStrategy: IFeedingStrategy\u003cTResponse\u003e ) {} // 模板方法：定义喂养流程骨架 async feedPet(petId: string, foodValue: number): Promise\u003cTResponse\u003e { // 1. 加载聚合根 const pet = await this.petRepository.findById(petId); if (!pet) { throw new Error('宠物不存在'); } // 2. 扩展点：喂养前校验 const canFeed = await this.feedingStrategy.beforeFeed(pet, foodValue); if (!canFeed) { throw new Error('当前无法喂养宠物'); } // 3. 扩展点：计算经验加成 const expBonus = this.feedingStrategy.calculateExpBonus(pet, foodValue); const actualFoodValue = foodValue + expBonus; // 4. 执行核心业务逻辑 const oldLevel = pet.getLevel(); pet.feed(actualFoodValue); const newLevel = pet.getLevel(); const levelUpCount = newLevel - oldLevel; // 5. 扩展点：生成奖励 const rewards = this.feedingStrategy.generateRewards(pet, levelUpCount); // 6. 持久化 await this.petRepository.save(pet); // 7. 扩展点：喂养后处理 await this.feedingStrategy.afterFeed(pet, levelUpCount); // 8. 构建基础返回结果 const result = new FeedingResult(pet, levelUpCount, rewards); // 9. 扩展点：扩展返回结果 const context: FeedingContext = { foodValue, expBonus, actualFoodValue }; this.feedingStrategy.extendResult(result, pet, context); // 10. 返回结果 return result.toResponse() as TResponse; } } 业务实现扩展点 1. 普通宠物喂养策略 // 普通宠物喂养策略 class NormalFeedingStrategy extends BaseFeedingStrategy\u003cNormalFeedingResponse\u003e { calculateExpBonus(pet: Pet, foodValue: number): number { // 普通宠物没有加成 return 0; } generateRewards(pet: Pet, levelUpCount: number): Reward[] { // 每升1级给100金币 if (levelUpCount === 0) return []; return [{ type: 'gold' as const, amount: 100 * levelUpCount, reason: '宠物升级奖励' }]; } extendResult( result: FeedingResult\u003cNormalFeedingExtensions\u003e, pet: Pet, context: FeedingContext ): void { // 普通策略添加基础统计信息 result.addExtension('feedCount', 1); result.addExtension('totalExpGained', context.actualFoodValue); } } 2. VIP宠物喂养策略 // VIP宠物喂养策略 class VipFeedingStrategy extends BaseFeedingStrategy\u003cVipFeedingResponse\u003e { constructor(private readonly vipLevel: VipLevel) { super(); } calculateExpBonus(pet: Pet, foodValue: number): number { // VIP玩家获得经验加成 const bonusRates: Record\u003cVipLevel, number\u003e = { 1: 0.1, // VIP1: 10%加成 2: 0.2, // VIP2: 20%加成 3: 0.3 // VIP3: 30%加成 }; return Math.floor(foodValue * bonusRates[this.vipLevel]); } generateRewards(pet: Pet, levelUpCount: number): Reward[] { if (levelUpCount === 0) return []; const rewards: Reward[] = []; // 基础金币奖励 rewards.push({ type: 'gold' as const, amount: 100 * levelUpCount, reason: '宠物升级奖励' }); // VIP额外奖励 rewards.push({ type: 'diamond' as const, amount: 10 * levelUpCount * this.vipLevel, reason: 'VIP专属升级奖励' }); return rewards; } async afterFeed(pet: Pet, levelUpCount: number): Promise\u003cvoid\u003e { if (levelUpCount \u003e 0) { // VIP玩家升级后发送特殊通知 console.log(`🎉 恭喜VIP${this.vipLevel}玩家，宠物${pet.name}升级到${pet.getLevel()}级！`); } } extendResult( result: FeedingResult\u003cVipFeedingExtensions\u003e, pet: Pet, context: FeedingContext ): void { // VIP策略添加VIP特权信息 result.addExtension('vipLevel', this.vipLevel); result.addExtension('expBonus', context.expBonus); result.addExtension('bonusRate', `${(context.expBonus / context.foodValue * 100).toFixed(1)}%`); // 计算VIP特权节省的时间（假设） const savedFeeds = Math.floor(context.expBonus / context.foodValue); result.addExtension('vipPrivilege', { savedFeeds, message: `VIP${this.vipLevel}特权为您节省了${savedFeeds}次喂养` }); } } 3. 传说宠物喂养策略 // 传说宠物喂养策略 class LegendaryFeedingStrategy extends BaseFeedingStrategy\u003cLegendaryFeedingResponse\u003e { private comboCount: number = 0; // 连击次数 private lastFeedTime: number | null = null; constructor(private readonly eventManager: EventManager) { super(); } async beforeFeed(pet: Pet, foodValue: number): Promise\u003cboolean\u003e { // 传说宠物每天只能喂养3次 const feedCountToday = await this.getFeedCountToday(pet.id); if (feedCountToday \u003e= 3) { return false; } // 计算连击 const now = Date.now(); if (this.lastFeedTime \u0026\u0026 now - this.lastFeedTime \u003c 5000) { this.comboCount++; } else { this.comboCount = 1; } this.lastFeedTime = now; return true; } calculateExpBonus(pet: Pet, foodValue: number): number { // 连击加成：每连击一次增加20%经验 const comboBonus = Math.floor(foodValue * 0.2 * (this.comboCount - 1)); // 传说宠物基础加成50% const legendaryBonus = Math.floor(foodValue * 0.5); return comboBonus + legendaryBonus; } generateRewards(pet: Pet, levelUpCount: number): Reward[] { if (levelUpCount === 0) return []; const rewards: Reward[] = []; // 基础奖励 rewards.push({ type: 'gold' as const, amount: 100 * levelUpCount, reason: '宠物升级奖励' }); // 传说级大额钻石奖励 rewards.push({ type: 'diamond' as const, amount: 50 * levelUpCount, reason: '传说宠物升级奖励' }); // 连击奖励 if (this.comboCount \u003e= 3) { rewards.push({ type: 'special_item' as const, itemId: 'legendary_food', amount: 1, reason: `${this.comboCount}连击特殊奖励` }); } // 触发稀有事件（概率） if (Math.random() \u003c 0.1) { rewards.push({ type: 'rare_event' as const, eventId: 'treasure_hunt', reason: '触发传说事件：寻宝之旅' }); } return rewards; } async afterFeed(pet: Pet, levelUpCount: number): Promise\u003cvoid\u003e { // 发布传说宠物喂养事件（供其他系统监听） await this.eventManager.publish({ type: 'LegendaryPetFed', petId: pet.id, level: pet.getLevel(), comboCount: this.comboCount, timestamp: Date.now() }); if (levelUpCount \u003e 0) { console.log(`⚡ 传说宠物${pet.name}升级！当前${this.comboCount}连击！`); } } private async getFeedCountToday(petId: string): Promise\u003cnumber\u003e { // 从缓存或数据库获取今日喂养次数 // 这里简化处理 return 0; } extendResult( result: FeedingResult\u003cLegendaryFeedingExtensions\u003e, pet: Pet, context: FeedingContext ): void { // 传说宠物添加丰富的扩展信息 // 1. 连击系统信息 const comboStatus: ComboStatus = this.comboCount \u003e= 3 ? 'AMAZING!' : this.comboCount \u003e= 2 ? 'GREAT!' : 'GOOD'; result.addExtension('comboInfo', { comboCount: this.comboCount, comboBonus: Math.floor(context.foodValue * 0.2 * (this.comboCount - 1)), nextComboAt: this.lastFeedTime! + 5000, comboStatus }); // 2. 今日剩余喂养次数 result.addExtension('dailyLimit', { remaining: 2, // 简化处理，实际应该查询 total: 3, resetAt: new Date().setHours(24, 0, 0, 0) }); // 3. 特殊事件触发记录 const specialRewards = result.rewards.filter(r =\u003e r.type === 'rare_event' || r.type === 'special_item' ); if (specialRewards.length \u003e 0) { result.addExtension('specialEvents', { triggered: true, events: specialRewards, message: '⚡ 恭喜触发传说事件！' }); } // 4. 传说宠物专属统计 result.addExtension('legendaryStats', { totalBonus: context.expBonus, legendaryBonus: Math.floor(context.foodValue * 0.5), efficiency: `${((context.actualFoodValue / context.foodValue - 1) * 100).toFixed(0)}%`, rank: this.calculateRank(pet.getLevel()) }); } private calculateRank(level: number): PetRank { if (level \u003e= 50) return 'S级传说'; if (level \u003e= 30) return 'A级史诗'; if (level \u003e= 20) return 'B级稀有'; return 'C级普通'; } } 使用示例 // 根据不同业务场景选择策略 // 1. 普通玩家喂养（返回类型为 NormalFeedingResponse） const normalService = new BasePetFeedingService\u003cNormalFeedingResponse\u003e( petRepository, new NormalFeedingStrategy() ); const result1: NormalFeedingResponse = await normalService.feedPet('pet-123', 100); console.log('普通玩家结果:', result1); /* 输出: { level: 5, exp: 50, expProgress: '50.00%', hp: 150, attack: 75, levelUpCount: 1, rewards: [{ type: 'gold', amount: 100, reason: '宠物升级奖励' }], feedCount: 1, totalExpGained: 100 } */ // 2. VIP玩家喂养（返回类型为 VipFeedingResponse） const vipService = new BasePetFeedingService\u003cVipFeedingResponse\u003e( petRepository, new VipFeedingStrategy(2) // VIP等级2 ); const result2: VipFeedingResponse = await vipService.feedPet('pet-456', 100); console.log('VIP玩家结果:', result2); /* 输出: { level: 5, exp: 70, expProgress: '70.00%', hp: 150, attack: 75, levelUpCount: 1, rewards: [ { type: 'gold', amount: 100, reason: '宠物升级奖励' }, { type: 'diamond', amount: 20, reason: 'VIP专属升级奖励' } ], vipLevel: 2, expBonus: 20, bonusRate: '20.0%', vipPrivilege: { savedFeeds: 0, message: 'VIP2特权为您节省了0次喂养' } } */ // 3. 传说宠物喂养（连击3次，返回类型为 LegendaryFeedingResponse） const legendaryService = new BasePetFeedingService\u003cLegendaryFeedingResponse\u003e( petRepository, new LegendaryFeedingStrategy(eventManager) ); const result3: LegendaryFeedingResponse = await legendaryService.feedPet('pet-789', 100); console.log('传说宠物结果:', result3); /* 输出: { level: 6, exp: 100, expProgress: '83.33%', hp: 180, attack: 90, levelUpCount: 1, rewards: [ { type: 'gold', amount: 100, reason: '宠物升级奖励' }, { type: 'diamond', amount: 50, reason: '传说宠物升级奖励' }, { type: 'special_item', itemId: 'legendary_food', amount: 1, reason: '3连击特殊奖励' } ], comboInfo: { comboCount: 3, comboBonus: 40, nextComboAt: 1696852345000, comboStatus: 'AMAZING!' }, dailyLimit: { remaining: 2, total: 3, resetAt: 1696867200000 }, specialEvents: { triggered: true, events: [ { type: 'special_item', itemId: 'legendary_food', amount: 1, reason: '3连击特殊奖励' } ], message: '⚡ 恭喜触发传说事件！' }, legendaryStats: { totalBonus: 90, legendaryBonus: 50, efficiency: '90%', rank: 'C级普通' } } */ 扩展点模式的优势 开闭原则：\n核心流程（feedPet方法）保持稳定,无需修改 新增业务类型只需实现新的策略类 职责清晰：\nBasePetFeedingService：负责流程编排 策略类：负责具体业务逻辑 领域模型：负责核心业务规则 FeedingResult：负责结构化返回数据 返回结果可扩展：\n定义了统一的 FeedingResult 接口 每个策略可以通过 extendResult 添加自己的扩展字段 客户端获得完整且类型安全的响应数据 避免了返回结果的\"上帝对象\"问题 易于测试：\n// 可以轻松mock策略进行测试 test('喂养流程应该调用所有扩展点', async () =\u003e { const mockStrategy = { beforeFeed: jest.fn().mockResolvedValue(true), calculateExpBonus: jest.fn().mockReturnValue(50), generateRewards: jest.fn().mockReturnValue([]), afterFeed: jest.fn() }; const service = new BasePetFeedingService(mockRepo, mockStrategy); await service.feedPet('pet-1', 100); expect(mockStrategy.beforeFeed).toHaveBeenCalled(); expect(mockStrategy.calculateExpBonus).toHaveBeenCalled(); expect(mockStrategy.generateRewards).toHaveBeenCalled(); expect(mockStrategy.afterFeed).toHaveBeenCalled(); }); 灵活组合：\n// 可以通过组合模式支持多种策略叠加 class CompositeStrategy extends IFeedingStrategy { constructor(strategies) { super(); this.strategies = strategies; } calculateExpBonus(pet, foodValue) { return this.strategies.reduce( (total, strategy) =\u003e total + strategy.calculateExpBonus(pet, foodValue), 0 ); } async afterFeed(pet, levelUpCount) { for (const strategy of this.strategies) { await strategy.afterFeed(pet, levelUpCount); } } } // 同时应用VIP和节日双倍经验 const compositeService = new BasePetFeedingService( petRepository, new CompositeStrategy([ new VipFeedingStrategy(3), new HolidayBonusStrategy() ]) ); 运行时切换：\n// 可以根据运行时条件动态选择策略 function createFeedingService(user, pet) { let strategy; if (pet.quality === 'legendary') { strategy = new LegendaryFeedingStrategy(eventManager); } else if (user.vipLevel \u003e 0) { strategy = new VipFeedingStrategy(user.vipLevel); } else { strategy = new NormalFeedingStrategy(); } return new BasePetFeedingService(petRepository, strategy); } 架构示意图 classDiagram class BasePetFeedingService { -petRepository -feedingStrategy +feedPet(petId, foodValue) } class IFeedingStrategy { \u003c\u003e +calculateExpBonus(pet, foodValue) +beforeFeed(pet, foodValue) +afterFeed(pet, levelUpCount) +generateRewards(pet, levelUpCount) } class NormalFeedingStrategy { +calculateExpBonus() +generateRewards() } class VipFeedingStrategy { -vipLevel +calculateExpBonus() +generateRewards() +afterFeed() } class LegendaryFeedingStrategy { -eventManager -comboCount +beforeFeed() +calculateExpBonus() +generateRewards() +afterFeed() } BasePetFeedingService --\u003e IFeedingStrategy : 依赖 IFeedingStrategy \u003c|.. NormalFeedingStrategy : 实现 IFeedingStrategy \u003c|.. VipFeedingStrategy : 实现 IFeedingStrategy \u003c|.. LegendaryFeedingStrategy : 实现 通过这种扩展点设计,我们实现了：\n统一流程：所有宠物喂养都遵循相同的流程骨架 差异化定制：不同业务场景可以定制自己的逻辑 解耦扩展：新增业务类型不影响现有代码 便于维护：每个策略职责单一,易于理解和修改 这正是 DDD 中\"将可变的业务逻辑与稳定的流程分离\"的最佳实践。\n项目结构 目录结构\nbase 中包含基础设施（infrastructure）和功能组件（component）和骨架实现（skeleton）\n基础设施主要指的是一些二三方的依赖的封装，通过内部API的形式进行提供 功能组件就是一些相对完整，独立的功能模块 骨架实现一般是一些功能接维度的通用骨架逻辑实现，包含接口请求来的参数校验、核心处理、结构封装返回等 sdk 是接口定义和契约层，base 中针对SDK 中定义的接口进行实现，sdk 中主要包含系统的所有接口、策略扩展点、数据模型、常量和工具类\nmodule 则是具体的游戏业务实现，会引用SDK，但是不直接引用base，完成具体的策略扩展点的重写，从而实现定制化的业务功能\n. ├── base │ ├── component │ ├── infrastructure │ └── skeleton ├── sdk └── module └── gameBusiness 依赖关系图\nflowchart TB subgraph subGraph0[\"业务模块层 (module)\"] PM[\"promotion-module\"] P618[\"promotion618\"] P1111[\"promotion1111\"] end subgraph subGraph1[\"SDK层 (sdk)\"] SDK[\"sdk\"] SDK_COMMON[\"sdk/common\"] SDK_COMPONENT[\"sdk/component\"] SDK_INFRA[\"sdk/infrastructure\"] SDK_SKELETON[\"sdk/skeleton\"] end subgraph subGraph2[\"基础实现层 (base)\"] BASE[\"base\"] BASE_INFRA[\"infrastructure\"] BASE_COMPONENT[\"component\"] BASE_SKELETON[\"skeleton\"] BASE_DRAW[\"draw\"] BASE_PET[\"pet\"] end PM --\u003e P618 \u0026 P1111 SDK --\u003e SDK_COMMON \u0026 SDK_COMPONENT \u0026 SDK_INFRA \u0026 SDK_SKELETON BASE --\u003e BASE_INFRA \u0026 BASE_COMPONENT \u0026 BASE_SKELETON BASE_COMPONENT --\u003e BASE_DRAW BASE_SKELETON --\u003e BASE_PET PM -. 依赖 .-\u003e SDK P618 -. 依赖 .-\u003e SDK P1111 -. 依赖 .-\u003e SDK BASE_INFRA -. 依赖 .-\u003e SDK BASE_COMPONENT -. 依赖 .-\u003e SDK \u0026 BASE_INFRA BASE_SKELETON -. 依赖 .-\u003e SDK \u0026 BASE_INFRA DDD方式的优势 通过上面的对比可以看到：\n业务逻辑内聚：\n经验计算、升级判断、属性提升都封装在对应的领域对象中 Service层变得非常薄，只负责编排 易于测试：\n// 单元测试不需要数据库 test('宠物喂养后应该获得经验', () =\u003e { const pet = new Pet( '1', 'Pikachu', 'rare', new Experience(0, 1, 'rare'), new PetStats(100, 50, 1, 'rare') ); pet.feed(100); expect(pet.experience.current).toBe(100); }); test('史诗宠物升级所需经验更多', () =\u003e { const exp1 = new Experience(0, 1, 'common'); const exp2 = new Experience(0, 1, 'epic'); expect(exp2.getRequiredForNextLevel()) .toBeGreaterThan(exp1.getRequiredForNextLevel()); }); 业务规则清晰可见：\n代码直接表达业务概念：pet.feed(), experience.canLevelUp() 新人可以通过阅读领域模型快速理解业务 易于扩展：\n添加新品质的宠物？只需修改值对象中的配置 修改升级公式？只在Experience中修改 添加新的宠物行为？在Pet实体中添加方法 事件驱动：\n通过领域事件解耦副作用（通知、日志、统计等） 便于实现复杂的业务流程 状态一致性：\n聚合根保证宠物状态的一致性 不会出现\"经验已扣除但等级未提升\"的情况 NodeJS上现有的实现 white-label是基于源码级别的 Domain-Driven Design Demo，有非常高的参考性\ntype-ddd 这个是NodeJS中针对是 Domain-Driven Design 的一个封装，主要是提供utils、 Entity、Value Objects、Factories、Aggregates、Repository、Domain events等来建立复杂的应用，可以看下项目的 README 有最基本的用法示例\n针对这两个项目，可以先看下 white-label，之后实践过程中则可以使用 type-ddd 进行具体的编码实现\n参考资料 DDD中类型接口：https://github.com/4lessandrodev/type-ddd DDD教程：https://github.com/stemmlerjs/ddd-forum NodeJS 中的示例： https://github.com/stemmlerjs/white-label Rich-Domain:https://github.com/4lessandrodev/rich-domain ","wordCount":"3020","inLanguage":"en","datePublished":"2025-09-01T10:16:15+08:00","dateModified":"2025-09-01T10:16:15+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://genluo.github.io/my-blog/posts/ddd/"},"publisher":{"@type":"Organization","name":"Genluo","logo":{"@type":"ImageObject","url":"https://genluo.github.io/my-blog/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://genluo.github.io/my-blog/ accesskey=h title="Genluo (Alt + H)">Genluo</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://genluo.github.io/my-blog/archives/ title=归档><span>归档</span></a></li><li><a href=https://genluo.github.io/my-blog/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://genluo.github.io/my-blog/tags/ title=标签><span>标签</span></a></li><li><a href=https://genluo.github.io/my-blog/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://genluo.github.io/my-blog/>Home</a>&nbsp;»&nbsp;<a href=https://genluo.github.io/my-blog/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">领域驱动设计</h1><div class=post-description>服务端中的领域驱动设计的应用及其解析</div><div class=post-meta><span title='2025-09-01 10:16:15 +0800 +0800'>September 1, 2025</span>&nbsp;·&nbsp;<span>15 min</span>&nbsp;·&nbsp;<span>3020 words</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%a5%91%e6%9c%ba aria-label=契机>契机</a></li><li><a href=#ddd aria-label=DDD>DDD</a><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%af%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1domain-driving-design aria-label="什么是领域驱动设计（domain driving design）">什么是领域驱动设计（domain driving design）</a><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%af%e8%81%9a%e5%90%88%e6%a0%b9 aria-label=什么是聚合根>什么是聚合根</a></li></ul></li><li><a href=#%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1%e4%bc%98%e7%bc%ba%e7%82%b9 aria-label=领域驱动设计优缺点>领域驱动设计优缺点</a><ul><li><a href=#%e4%bc%98%e7%82%b9 aria-label=优点>优点</a></li><li><a href=#%e7%bc%ba%e7%82%b9 aria-label=缺点>缺点</a></li></ul></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e9%a2%86%e5%9f%9f%e6%a8%a1%e5%9e%8b aria-label=为什么需要领域模型>为什么需要领域模型</a><ul><li><a href=#1-%e8%b4%ab%e8%a1%80%e6%a8%a1%e5%9e%8b%e7%9a%84%e5%9b%b0%e5%a2%83 aria-label="1. 贫血模型的困境">1. 贫血模型的困境</a></li><li><a href=#2-%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91%e6%95%a3%e4%b9%b1 aria-label="2. 业务逻辑散乱">2. 业务逻辑散乱</a></li><li><a href=#3-%e6%8a%80%e6%9c%af%e4%b8%8e%e4%b8%9a%e5%8a%a1%e8%84%b1%e8%8a%82 aria-label="3. 技术与业务脱节">3. 技术与业务脱节</a></li><li><a href=#%e9%a2%86%e5%9f%9f%e6%a8%a1%e5%9e%8b%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e8%bf%99%e4%ba%9b%e9%97%ae%e9%a2%98 aria-label=领域模型如何解决这些问题>领域模型如何解决这些问题</a><ul><li><a href=#1-%e5%b0%81%e8%a3%85%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91 aria-label="1. 封装业务逻辑">1. 封装业务逻辑</a></li><li><a href=#2-%e7%bb%9f%e4%b8%80%e8%af%ad%e8%a8%80ubiquitous-language aria-label="2. 统一语言（Ubiquitous Language）">2. 统一语言（Ubiquitous Language）</a></li><li><a href=#3-%e7%bb%b4%e6%8a%a4%e4%b8%9a%e5%8a%a1%e4%b8%8d%e5%8f%98%e6%80%a7invariants aria-label="3. 维护业务不变性（Invariants）">3. 维护业务不变性（Invariants）</a></li><li><a href=#4-%e9%99%8d%e4%bd%8e%e8%ae%a4%e7%9f%a5%e8%b4%9f%e6%8b%85 aria-label="4. 降低认知负担">4. 降低认知负担</a></li></ul></li><li><a href=#%e5%ae%9e%e8%b7%b5%e4%bb%b7%e5%80%bc aria-label=实践价值>实践价值</a></li></ul></li><li><a href=#%e4%b8%be%e4%be%8b aria-label=举例>举例</a><ul><li><a href=#%e4%b8%9a%e5%8a%a1%e5%9c%ba%e6%99%af aria-label=业务场景>业务场景</a></li><li><a href=#%e4%b8%9a%e5%8a%a1%e6%b5%81%e7%a8%8b%e5%9b%be aria-label=业务流程图>业务流程图</a></li><li><a href=#%e4%bc%a0%e7%bb%9f%e5%ae%9e%e7%8e%b0%e6%96%b9%e5%bc%8f aria-label=传统实现方式>传统实现方式</a></li><li><a href=#ddd%e5%ae%9e%e7%8e%b0%e6%96%b9%e5%bc%8f aria-label=DDD实现方式>DDD实现方式</a><ul><li><a href=#1-%e5%80%bc%e5%af%b9%e8%b1%a1value-object--%e7%bb%8f%e9%aa%8c%e5%80%bc aria-label="1. 值对象（Value Object）- 经验值">1. 值对象（Value Object）- 经验值</a></li><li><a href=#2-%e5%80%bc%e5%af%b9%e8%b1%a1---%e5%ae%a0%e7%89%a9%e5%b1%9e%e6%80%a7 aria-label="2. 值对象 - 宠物属性">2. 值对象 - 宠物属性</a></li><li><a href=#3-%e9%a2%86%e5%9f%9f%e4%ba%8b%e4%bb%b6 aria-label="3. 领域事件">3. 领域事件</a></li><li><a href=#4-%e5%ae%9e%e4%bd%93%e8%81%9a%e5%90%88%e6%a0%b9---%e5%ae%a0%e7%89%a9 aria-label="4. 实体/聚合根 - 宠物">4. 实体/聚合根 - 宠物</a></li><li><a href=#5-%e4%bb%93%e5%82%a8%e6%8e%a5%e5%8f%a3 aria-label="5. 仓储接口">5. 仓储接口</a></li><li><a href=#6-%e5%ba%94%e7%94%a8%e6%9c%8d%e5%8a%a1%e7%ae%80%e6%b4%81%e7%9a%84%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91%e7%bc%96%e6%8e%92%e5%b1%82 aria-label="6. 应用服务（简洁的业务逻辑编排层）">6. 应用服务（简洁的业务逻辑编排层）</a></li><li><a href=#7-%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b aria-label="7. 使用示例">7. 使用示例</a></li></ul></li><li><a href=#%e6%9b%b4%e8%bf%9b%e4%b8%80%e6%ad%a5 aria-label=更进一步>更进一步</a><ul><li><a href=#%e4%b8%9a%e5%8a%a1%e5%9c%ba%e6%99%af%e6%89%a9%e5%b1%95 aria-label=业务场景扩展>业务场景扩展</a></li><li><a href=#%e5%ae%8c%e6%95%b4%e7%b1%bb%e5%9e%8b%e5%ae%9a%e4%b9%89 aria-label=完整类型定义>完整类型定义</a></li><li><a href=#%e8%bf%94%e5%9b%9e%e7%bb%93%e6%9e%9c%e5%b0%81%e8%a3%85%e7%b1%bb aria-label=返回结果封装类>返回结果封装类</a></li><li><a href=#%e7%ad%96%e7%95%a5%e6%8e%a5%e5%8f%a3%e5%ae%9a%e4%b9%89 aria-label=策略接口定义>策略接口定义</a></li><li><a href=#%e5%ba%94%e7%94%a8%e6%9c%8d%e5%8a%a1%e6%a8%a1%e6%9d%bf%e6%96%b9%e6%b3%95 aria-label=应用服务（模板方法）>应用服务（模板方法）</a></li><li><a href=#%e4%b8%9a%e5%8a%a1%e5%ae%9e%e7%8e%b0%e6%89%a9%e5%b1%95%e7%82%b9 aria-label=业务实现扩展点>业务实现扩展点</a><ul><li><a href=#1-%e6%99%ae%e9%80%9a%e5%ae%a0%e7%89%a9%e5%96%82%e5%85%bb%e7%ad%96%e7%95%a5 aria-label="1. 普通宠物喂养策略">1. 普通宠物喂养策略</a></li><li><a href=#2-vip%e5%ae%a0%e7%89%a9%e5%96%82%e5%85%bb%e7%ad%96%e7%95%a5 aria-label="2. VIP宠物喂养策略">2. VIP宠物喂养策略</a></li><li><a href=#3-%e4%bc%a0%e8%af%b4%e5%ae%a0%e7%89%a9%e5%96%82%e5%85%bb%e7%ad%96%e7%95%a5 aria-label="3. 传说宠物喂养策略">3. 传说宠物喂养策略</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b aria-label=使用示例>使用示例</a></li><li><a href=#%e6%89%a9%e5%b1%95%e7%82%b9%e6%a8%a1%e5%bc%8f%e7%9a%84%e4%bc%98%e5%8a%bf aria-label=扩展点模式的优势>扩展点模式的优势</a></li><li><a href=#%e6%9e%b6%e6%9e%84%e7%a4%ba%e6%84%8f%e5%9b%be aria-label=架构示意图>架构示意图</a></li><li><a href=#%e9%a1%b9%e7%9b%ae%e7%bb%93%e6%9e%84 aria-label=项目结构>项目结构</a></li></ul></li><li><a href=#ddd%e6%96%b9%e5%bc%8f%e7%9a%84%e4%bc%98%e5%8a%bf aria-label=DDD方式的优势>DDD方式的优势</a></li></ul></li></ul></li><li><a href=#nodejs%e4%b8%8a%e7%8e%b0%e6%9c%89%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=NodeJS上现有的实现>NodeJS上现有的实现</a></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=参考资料>参考资料</a></li></ul></div></details></div><div class=post-content><h2 id=契机>契机<a hidden class=anchor aria-hidden=true href=#契机>#</a></h2><p>最近因为一些契机看了下互动小游戏的服务端，深入了解了下现在互动游戏服务端的架构，同时也尝试在这个架构的基础上使用 AI 进行一些游戏业务功能开发，其中印象最深的服务端的一个称之为基座的架构设计，这个基座架构深度使用 <code>DDD</code> 领域设计思想进行抽象实现，在游戏业务非常灵活，复用性非常高，所以想看下在<code>NodeJS</code> 中针对 <code>DDD</code>领域驱动设计是否有一定的实践。下面主要分为两个部分，一个是为什么是<code>DDD</code>？另一个 <code>NodeJS</code>中一些实践</p><h2 id=ddd><code>DDD</code><a hidden class=anchor aria-hidden=true href=#ddd>#</a></h2><h3 id=什么是领域驱动设计domain-driving-design>什么是领域驱动设计（domain driving design）<a hidden class=anchor aria-hidden=true href=#什么是领域驱动设计domain-driving-design>#</a></h3><p>领域驱动设计是一种软件设计方法，用于表示和组织特定领域中的知识和业务逻辑。它主要通过创建抽象的模型对象来模拟现实世界的实体及其关系，帮助开发人员理解和实现复杂系统的业务逻辑。在领域驱动设计中，通常会包含以下几个关键概念：</p><ol><li><p><strong>实体（Entity）</strong>：具有唯一标识的对象，通常表示业务中的一个独立的概念或对象。例如，在一个订单系统中，订单和客户可以被视为实体。</p></li><li><p><strong>值对象（Value Object）</strong>：没有唯一标识的对象，通常用于描述某个实体的属性或细节。它们是不可变的，两个值对象如果具有相同的属性值，则认为是相等的。例如，一个地址可以作为一个值对象。</p></li><li><p><strong>聚合（Aggregate）</strong>：一组相关的对象（实体和值对象）的集合，它们被视为一个单元进行数据修改。聚合有一个根实体（Aggregate Root），通过根实体来管理聚合的生命周期。</p></li><li><p><strong>领域服务（Domain Service）</strong>：封装领域逻辑的操作，这些操作不属于任何一个实体或值对象。它们通常用于表示跨越多个实体或值对象的业务逻辑。</p></li><li><p><strong>仓储（Repository）</strong>：提供访问持久化存储中对象的方法，通常用于获取和保存聚合根。</p></li></ol><h4 id=什么是聚合根>什么是聚合根<a hidden class=anchor aria-hidden=true href=#什么是聚合根>#</a></h4><p>指的是一个聚合中具有唯一标识的核心实体，该实体负责控制整个聚合的生命周期和一致性。</p><ol><li><p><strong>控制访问</strong>：聚合根是聚合内的唯一入口点，外部对象只能通过聚合根来访问或操作聚合中的其它对象。这有助于保持聚合内部的完整性和一致性。</p></li><li><p><strong>管理生命周期</strong>：聚合根负责管理聚合内所有对象的生命周期，包括创建、更新和删除操作。通过聚合根，可以确保对聚合中数据的任何修改都是合法和一致的。</p></li><li><p><strong>一致性边界</strong>：聚合定义了一个一致性边界，其中的所有对象在事务中应该保持一致。因此，聚合根通过确保在其范围内的操作都是一致的，来维持这种边界。</p></li><li><p><strong>唯一性</strong>：每个聚合都有一个唯一的聚合根。通常，聚合根具有唯一标识符，用来标识和访问该聚合。</p></li><li><p><strong>持久化管理</strong>：通过仓储（Repository）模式，聚合根通常是持久化操作（如保存和检索）的主要对象。这意味着仓储通常只直接处理聚合根，而不是聚合内的其它对象。</p></li></ol><h3 id=领域驱动设计优缺点>领域驱动设计优缺点<a hidden class=anchor aria-hidden=true href=#领域驱动设计优缺点>#</a></h3><p>领域驱动设计（Domain-Driven Design, DDD）是一种软件设计方法，旨在通过紧密结合业务需求和技术实现来构建复杂软件系统。以下是领域驱动设计的一些优缺点：</p><h4 id=优点>优点<a hidden class=anchor aria-hidden=true href=#优点>#</a></h4><ol><li><p><strong>更好地理解业务</strong>：</p><ul><li>DDD强调与领域专家的密切合作，使开发团队对业务需求有更深入的理解。这有助于创建更符合业务需求的系统。</li></ul></li><li><p><strong>清晰的模型</strong>：</p><ul><li>通过使用统一语言和领域模型，所有团队成员（包括技术人员和非技术人员）都可以在同一语境下沟通，从而减少误解。</li></ul></li><li><p><strong>灵活性和可维护性</strong>：</p><ul><li>DDD鼓励模块化设计，如界限上下文（Bounded Context）和聚合（Aggregate），这些设计有助于简化系统的维护和扩展。</li></ul></li><li><p><strong>关注核心领域</strong>：</p><ul><li>通过识别和聚焦于核心领域，DDD帮助团队将资源集中在对业务最重要的部分，从而提高竞争力。</li></ul></li><li><p><strong>支持复杂系统开发</strong>：</p><ul><li>DDD为处理复杂领域逻辑提供了有力的方法和工具，可以有效地管理复杂性。</li></ul></li></ol><h4 id=缺点>缺点<a hidden class=anchor aria-hidden=true href=#缺点>#</a></h4><ol><li><p><strong>学习曲线陡峭</strong>：</p><ul><li>对许多开发人员和组织来说，DDD的概念和技术术语可能较为陌生，初始学习和实施成本较高。</li></ul></li><li><p><strong>时间和资源投入大</strong>：</p><ul><li>由于需要深度的领域分析和持续的团队协作，DDD可能比传统方法花费更多时间和资源。</li></ul></li><li><p><strong>不适合所有项目</strong>：</p><ul><li>对于简单或小型项目，DDD可能过于复杂和冗余，投入的成本和收益不成比例。</li></ul></li><li><p><strong>需求稳定性要求高</strong>：</p><ul><li>DDD更适合于需求相对稳定且对业务逻辑要求高的项目。对于需求频繁变化的项目，可能需要经常重构。</li></ul></li><li><p><strong>对团队协作要求高</strong>：</p><ul><li>成功实施DDD需要团队成员之间良好的沟通和协作，这对团队的组织文化和沟通能力提出了较高要求。</li></ul></li></ol><h3 id=为什么需要领域模型>为什么需要领域模型<a hidden class=anchor aria-hidden=true href=#为什么需要领域模型>#</a></h3><p>在传统的软件开发中,我们常常遇到以下问题：</p><h4 id=1-贫血模型的困境>1. 贫血模型的困境<a hidden class=anchor aria-hidden=true href=#1-贫血模型的困境>#</a></h4><p>传统的开发方式往往采用"贫血模型"（Anemic Domain Model），即：</p><ul><li><strong>数据对象只包含字段和简单的 getter/setter</strong>，没有任何业务逻辑</li><li><strong>所有业务逻辑集中在 Service 层</strong>，形成庞大的服务类</li><li><strong>数据和行为分离</strong>，导致代码难以理解和维护</li></ul><h4 id=2-业务逻辑散乱>2. 业务逻辑散乱<a hidden class=anchor aria-hidden=true href=#2-业务逻辑散乱>#</a></h4><ul><li><strong>缺乏统一的业务规则管理</strong>：同样的业务逻辑可能在多个地方重复实现</li><li><strong>难以保证一致性</strong>：订单创建、修改、取消等操作中的业务规则可能不一致</li><li><strong>维护成本高</strong>：修改一个业务规则需要在多个地方查找和修改</li></ul><h4 id=3-技术与业务脱节>3. 技术与业务脱节<a hidden class=anchor aria-hidden=true href=#3-技术与业务脱节>#</a></h4><ul><li><strong>代码难以反映业务意图</strong>：开发人员看到的是表、字段、SQL，而不是订单、支付、发货等业务概念</li><li><strong>与领域专家沟通困难</strong>：技术术语和业务术语无法对应，容易产生理解偏差</li><li><strong>需求变更代价大</strong>：业务调整时，需要从底层数据结构开始重新设计</li></ul><h4 id=领域模型如何解决这些问题>领域模型如何解决这些问题<a hidden class=anchor aria-hidden=true href=#领域模型如何解决这些问题>#</a></h4><p>领域模型通过以下方式解决上述问题：</p><h5 id=1-封装业务逻辑>1. 封装业务逻辑<a hidden class=anchor aria-hidden=true href=#1-封装业务逻辑>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 充血模型示例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Order</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userId</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PENDING&#39;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 业务逻辑封装在实体内部
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>addItem</span>(<span style=color:#a6e22e>product</span>, <span style=color:#a6e22e>quantity</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;PENDING&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;只能向待处理订单添加商品&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>quantity</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;商品数量必须大于0&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>product</span>, <span style=color:#a6e22e>quantity</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>submit</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;订单不能为空&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SUBMITTED&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 触发领域事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addDomainEvent</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>OrderSubmittedEvent</span>(<span style=color:#66d9ef>this</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>calculateTotal</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>reduce</span>((<span style=color:#a6e22e>sum</span>, <span style=color:#a6e22e>item</span>) =&gt;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sum</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>product</span>.<span style=color:#a6e22e>price</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>quantity</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=2-统一语言ubiquitous-language>2. 统一语言（Ubiquitous Language）<a hidden class=anchor aria-hidden=true href=#2-统一语言ubiquitous-language>#</a></h5><ul><li>代码中的类名、方法名直接对应业务概念</li><li>开发人员和领域专家使用相同的术语</li><li>代码即文档，业务规则清晰可见</li></ul><h5 id=3-维护业务不变性invariants>3. 维护业务不变性（Invariants）<a hidden class=anchor aria-hidden=true href=#3-维护业务不变性invariants>#</a></h5><ul><li>通过聚合根控制状态变更</li><li>确保对象始终处于有效状态</li><li>业务规则在一个地方定义和维护</li></ul><h5 id=4-降低认知负担>4. 降低认知负担<a hidden class=anchor aria-hidden=true href=#4-降低认知负担>#</a></h5><ul><li>每个领域对象职责清晰</li><li>业务逻辑内聚，易于理解和测试</li><li>修改影响范围可控</li></ul><h4 id=实践价值>实践价值<a hidden class=anchor aria-hidden=true href=#实践价值>#</a></h4><p>引入领域模型后，带来的实际价值：</p><ol><li><strong>代码可读性提升</strong>：新人可以通过阅读领域模型快速理解业务</li><li><strong>维护成本降低</strong>：业务规则集中管理，修改影响范围明确</li><li><strong>测试更容易</strong>：领域对象可以独立测试，不依赖数据库和外部服务</li><li><strong>应对复杂度</strong>：当业务逻辑变得复杂时，领域模型的优势更加明显</li><li><strong>长期价值</strong>：随着项目演进，领域模型帮助保持代码质量和架构清晰度</li></ol><blockquote><p><strong>总结</strong>：领域模型不是银弹，但对于业务逻辑复杂的系统来说，它提供了一种更加贴近业务、易于维护的代码组织方式。通过将数据和行为结合，领域模型让代码真正成为业务知识的表达</p></blockquote><h3 id=举例>举例<a hidden class=anchor aria-hidden=true href=#举例>#</a></h3><p>下面通过一个游戏中的"宠物喂养升级"模型来展示如何使用DDD进行设计</p><h4 id=业务场景>业务场景<a hidden class=anchor aria-hidden=true href=#业务场景>#</a></h4><p>在一个宠物养成游戏中，玩家可以：</p><ul><li>喂养宠物获得经验值</li><li>宠物经验值达到一定数量后进行升级</li><li>宠物升级后有对应的奖励物</li><li>最终根据宠物的奖励物发放对应的奖励</li></ul><h4 id=业务流程图>业务流程图<a hidden class=anchor aria-hidden=true href=#业务流程图>#</a></h4><pre tabindex=0><code class=language-mermaid data-lang=mermaid>stateDiagram-v2
    [*] --&gt; 待喂养: 宠物初始状态

    待喂养 --&gt; 增加经验: 玩家喂养食物

    增加经验 --&gt; 检查升级条件: 经验值累加

    检查升级条件 --&gt; 升级中: 经验值 &gt;= 所需经验
    检查升级条件 --&gt; 待喂养: 经验值 &lt; 所需经验

    升级中 --&gt; 属性提升: 消耗经验值
    属性提升 --&gt; 奖励生成: 等级+1, 属性增加

    奖励生成 --&gt; 检查升级条件: 继续检查是否能再次升级

    奖励生成 --&gt; 发放奖励: 所有升级完成

    发放奖励 --&gt; 待喂养: 奖励发放完毕

    note right of 检查升级条件
        不同品质宠物
        所需经验不同
        - 普通: 1.0x
        - 稀有: 1.2x
        - 史诗: 1.5x
    end note

    note right of 属性提升
        属性增长公式
        HP: +10 * 品质倍率
        Attack: +5 * 品质倍率
    end note
</code></pre><p><strong>状态说明</strong>：</p><ol><li><strong>待喂养</strong>：宠物的正常状态，等待玩家投喂食物</li><li><strong>增加经验</strong>：喂养后经验值增加的瞬时状态</li><li><strong>检查升级条件</strong>：判断当前经验是否足够升级（支持连续升级）</li><li><strong>升级中</strong>：消耗经验值，进行等级提升</li><li><strong>属性提升</strong>：根据品质倍率计算新的属性值</li><li><strong>奖励生成</strong>：基于升级结果生成奖励物品</li><li><strong>发放奖励</strong>：将奖励物品发放给玩家</li></ol><h4 id=传统实现方式>传统实现方式<a hidden class=anchor aria-hidden=true href=#传统实现方式>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 数据模型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Pet</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exp</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>quality</span>; <span style=color:#75715e>// 品质：普通、稀有、史诗
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>hp</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>attack</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Service层处理所有业务逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetService</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>feed</span>(<span style=color:#a6e22e>petId</span>, <span style=color:#a6e22e>foodValue</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1. 查询宠物
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>&#39;SELECT * FROM pets WHERE id = ?&#39;</span>, [<span style=color:#a6e22e>petId</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. 计算经验值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>foodValue</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. 检查是否升级（逻辑分散）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRequiredExp</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>quality</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>-=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRequiredExp</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>quality</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>levelUpCount</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. 升级后属性计算（逻辑复杂且容易出错）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>hp</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getQualityMultiplier</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>quality</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>attack</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getQualityMultiplier</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>quality</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 5. 发送通知
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendLevelUpNotification</span>(<span style=color:#a6e22e>petId</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>level</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 6. 保存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>&#39;UPDATE pets SET level=?, exp=?, hp=?, attack=? WHERE id=?&#39;</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>exp</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>hp</span>, <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>attack</span>, <span style=color:#a6e22e>petId</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pet</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getRequiredExp</span>(<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>quality</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 升级所需经验计算逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>base</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>quality</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;epic&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>base</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1.5</span> <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>           <span style=color:#a6e22e>quality</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;rare&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>base</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1.2</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>base</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getQualityMultiplier</span>(<span style=color:#a6e22e>quality</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>quality</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;epic&#39;</span> <span style=color:#f92672>?</span> <span style=color:#ae81ff>1.5</span> <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>           <span style=color:#a6e22e>quality</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;rare&#39;</span> <span style=color:#f92672>?</span> <span style=color:#ae81ff>1.2</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>1.0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>问题</strong>：</p><ul><li>业务逻辑全在Service层，代码臃肿</li><li>Pet只是数据容器，没有行为</li><li>升级规则、属性计算散落各处</li><li>难以保证宠物状态的一致性</li><li>测试困难，需要mock数据库</li></ul><h4 id=ddd实现方式>DDD实现方式<a hidden class=anchor aria-hidden=true href=#ddd实现方式>#</a></h4><h5 id=1-值对象value-object--经验值>1. 值对象（Value Object）- 经验值<a hidden class=anchor aria-hidden=true href=#1-值对象value-object--经验值>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 值对象：经验值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Experience</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>current</span>, <span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>quality</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>current</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;经验值不能为负&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>current</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>quality</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取升级所需经验
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>getRequiredForNextLevel</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>baseExp</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>multiplier</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;common&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.0</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;rare&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.2</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;epic&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.5</span>
</span></span><span style=display:flex><span>    }[<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span>] <span style=color:#f92672>||</span> <span style=color:#ae81ff>1.0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>baseExp</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>multiplier</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 添加经验，返回新的Experience对象（值对象不可变）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>value</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 检查是否可以升级
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>canLevelUp</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRequiredForNextLevel</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 消耗升级所需经验
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>consumeForLevelUp</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>required</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRequiredForNextLevel</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>required</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=2-值对象---宠物属性>2. 值对象 - 宠物属性<a hidden class=anchor aria-hidden=true href=#2-值对象---宠物属性>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 值对象：属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetStats</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>hp</span>, <span style=color:#a6e22e>attack</span>, <span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>quality</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>hp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hp</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attack</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>attack</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>quality</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 升级后的属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>levelUp</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>multiplier</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;common&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.0</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;rare&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.2</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;epic&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1.5</span>
</span></span><span style=display:flex><span>    }[<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span>] <span style=color:#f92672>||</span> <span style=color:#ae81ff>1.0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetStats</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>hp</span> <span style=color:#f92672>+</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>multiplier</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attack</span> <span style=color:#f92672>+</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>multiplier</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=3-领域事件>3. 领域事件<a hidden class=anchor aria-hidden=true href=#3-领域事件>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 领域事件：宠物升级事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetLeveledUpEvent</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>petId</span>, <span style=color:#a6e22e>oldLevel</span>, <span style=color:#a6e22e>newLevel</span>, <span style=color:#a6e22e>stats</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>petId</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>oldLevel</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>oldLevel</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>newLevel</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>newLevel</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>stats</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>occurredAt</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 领域事件：宠物喂养事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetFedEvent</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>petId</span>, <span style=color:#a6e22e>foodValue</span>, <span style=color:#a6e22e>gainedExp</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>petId</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>foodValue</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>gainedExp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>gainedExp</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>occurredAt</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=4-实体聚合根---宠物>4. 实体/聚合根 - 宠物<a hidden class=anchor aria-hidden=true href=#4-实体聚合根---宠物>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 聚合根：宠物
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Pet</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>quality</span>, <span style=color:#a6e22e>experience</span>, <span style=color:#a6e22e>stats</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quality</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>quality</span>; <span style=color:#75715e>// &#39;common&#39;, &#39;rare&#39;, &#39;epic&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>experience</span>; <span style=color:#75715e>// Experience值对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>stats</span>; <span style=color:#75715e>// PetStats值对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>domainEvents</span> <span style=color:#f92672>=</span> []; <span style=color:#75715e>// 领域事件列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 喂养宠物
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>feed</span>(<span style=color:#a6e22e>foodValue</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;食物价值必须大于0&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 添加经验
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>oldExp</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>foodValue</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 记录喂养事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addDomainEvent</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetFedEvent</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>foodValue</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>foodValue</span>
</span></span><span style=display:flex><span>    ));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 尝试升级
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tryLevelUp</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 尝试升级（私有业务逻辑）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>tryLevelUp</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 循环升级（处理一次喂养多次升级的情况）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>canLevelUp</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>oldLevel</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 消耗经验
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>consumeForLevelUp</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 提升属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>levelUp</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>levelUpCount</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 触发升级事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addDomainEvent</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetLeveledUpEvent</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>oldLevel</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>level</span>,
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>hp</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>hp</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>attack</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>attack</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>levelUpCount</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 添加领域事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>addDomainEvent</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>domainEvents</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取并清空领域事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>pullDomainEvents</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>events</span> <span style=color:#f92672>=</span> [...<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>domainEvents</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>domainEvents</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>events</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取当前等级
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>getLevel</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>level</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取当前经验进度（百分比）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>getExpProgress</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>required</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>getRequiredForNextLevel</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>required</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>).<span style=color:#a6e22e>toFixed</span>(<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=5-仓储接口>5. 仓储接口<a hidden class=anchor aria-hidden=true href=#5-仓储接口>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 仓储接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IPetRepository</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>petId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not implemented&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>pet</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not implemented&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 仓储实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetRepository</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>IPetRepository</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>db</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>petId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>query</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;SELECT * FROM pets WHERE id = ?&#39;</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>petId</span>]
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>data</span>) <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从数据重建领域对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Pet</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>quality</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>exp</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>quality</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetStats</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>hp</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>attack</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>quality</span>)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>pet</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 保存聚合根
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>query</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`UPDATE pets SET
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        level = ?,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        exp = ?,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        hp = ?,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        attack = ?
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      WHERE id = ?`</span>,
</span></span><span style=display:flex><span>      [
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>level</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>current</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>hp</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>attack</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发布领域事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>events</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>pullDomainEvents</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>event</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>events</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>publishEvent</span>(<span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>publishEvent</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发布事件到事件总线
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 例如：发送通知、更新排行榜等
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Domain Event:&#39;</span>, <span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=6-应用服务简洁的业务逻辑编排层>6. 应用服务（简洁的业务逻辑编排层）<a hidden class=anchor aria-hidden=true href=#6-应用服务简洁的业务逻辑编排层>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 应用服务：只负责编排，不包含业务逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PetApplicationService</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>petRepository</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petRepository</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>petRepository</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>feedPet</span>(<span style=color:#a6e22e>petId</span>, <span style=color:#a6e22e>foodValue</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1. 加载聚合根
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petRepository</span>.<span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>petId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>pet</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;宠物不存在&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. 执行业务逻辑（在领域模型中）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>feed</span>(<span style=color:#a6e22e>foodValue</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. 持久化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petRepository</span>.<span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>pet</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. 返回结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>level</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>exp</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>current</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expProgress</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getExpProgress</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>hp</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>hp</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>attack</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>attack</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=7-使用示例>7. 使用示例<a hidden class=anchor aria-hidden=true href=#7-使用示例>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>petService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetApplicationService</span>(<span style=color:#a6e22e>petRepository</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 喂养宠物
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>petService</span>.<span style=color:#a6e22e>feedPet</span>(<span style=color:#e6db74>&#39;pet-123&#39;</span>, <span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`宠物升级到</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>level</span><span style=color:#e6db74>}</span><span style=color:#e6db74>级，经验进度</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>expProgress</span><span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 业务逻辑都在领域模型中，应用服务非常简洁
</span></span></span></code></pre></div><h4 id=更进一步>更进一步<a hidden class=anchor aria-hidden=true href=#更进一步>#</a></h4><p>在实际业务中,我们常常需要在保持核心流程不变的情况下,允许不同的业务场景有定制化的逻辑。这时可以进一步通过<strong>扩展点模式</strong>来实现。</p><h5 id=业务场景扩展>业务场景扩展<a hidden class=anchor aria-hidden=true href=#业务场景扩展>#</a></h5><p>假设我们的宠物系统需要支持不同类型的喂养策略：</p><ul><li><strong>普通宠物</strong>：直接获得经验</li><li><strong>VIP宠物</strong>：获得经验加成,并有额外的属性提升</li><li><strong>传说宠物</strong>：喂养时触发特殊效果,可能获得额外奖励</li></ul><h5 id=完整类型定义>完整类型定义<a hidden class=anchor aria-hidden=true href=#完整类型定义>#</a></h5><p>首先,定义完整的类型系统：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// ============= 基础类型定义 =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 奖励类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RewardType</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;gold&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;diamond&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;special_item&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;rare_event&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 奖励接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Reward</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>RewardType</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>amount?</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>itemId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>eventId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 连击状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ComboStatus</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;GOOD&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;GREAT!&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;AMAZING!&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 宠物等级评级
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PetRank</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;C级普通&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;B级稀有&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;A级史诗&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;S级传说&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// VIP等级
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>VipLevel</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ============= 扩展字段类型定义 =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// VIP特权信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VipPrivilege</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>savedFeeds</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 连击信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ComboInfo</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comboCount</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comboBonus</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nextComboAt</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comboStatus</span>: <span style=color:#66d9ef>ComboStatus</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 每日限制信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>DailyLimit</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>remaining</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>total</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resetAt</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 特殊事件信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SpecialEvents</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>triggered</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>events</span>: <span style=color:#66d9ef>Reward</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 传说统计信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>LegendaryStats</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>totalBonus</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>legendaryBonus</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>efficiency</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rank</span>: <span style=color:#66d9ef>PetRank</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ============= 返回结果类型定义 =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 基础返回结果接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BaseFeedingResponse</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>level</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exp</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expProgress</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hp</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>attack</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>Reward</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 普通策略扩展字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>NormalFeedingExtensions</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>feedCount</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>totalExpGained</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// VIP策略扩展字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VipFeedingExtensions</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vipLevel</span>: <span style=color:#66d9ef>VipLevel</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expBonus</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bonusRate</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vipPrivilege</span>: <span style=color:#66d9ef>VipPrivilege</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 传说策略扩展字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>LegendaryFeedingExtensions</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comboInfo</span>: <span style=color:#66d9ef>ComboInfo</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dailyLimit</span>: <span style=color:#66d9ef>DailyLimit</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>specialEvents?</span>: <span style=color:#66d9ef>SpecialEvents</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>legendaryStats</span>: <span style=color:#66d9ef>LegendaryStats</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 组合返回类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NormalFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>NormalFeedingExtensions</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>VipFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>VipFeedingExtensions</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LegendaryFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>LegendaryFeedingExtensions</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ============= 上下文类型定义 =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>FeedingContext</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expBonus</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>actualFoodValue</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ============= 事件管理器接口 =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>EventManager</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>publish</span>(<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ============= Pet 相关接口（简化版） =============
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Pet</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>quality</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>experience</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>stats</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>feed</span>(<span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getLevel</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getExpProgress</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IPetRepository</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>petId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>Pet</span> <span style=color:#960050;background-color:#1e0010>|</span> <span style=color:#a6e22e>null</span>&gt;;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=返回结果封装类>返回结果封装类<a hidden class=anchor aria-hidden=true href=#返回结果封装类>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// 返回结果基类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeedingResult</span>&lt;<span style=color:#f92672>T</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>any</span>&gt; <span style=color:#960050;background-color:#1e0010>=</span> {}&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>level</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exp</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expProgress</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hp</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>attack</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>Reward</span>[];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>extensions</span>: <span style=color:#66d9ef>T</span> <span style=color:#f92672>=</span> {} <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>T</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>Reward</span>[]) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>level</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>current</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>expProgress</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getExpProgress</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>hp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>hp</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attack</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>attack</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>levelUpCount</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>rewards</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>rewards</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 添加扩展数据（类型安全）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>addExtension</span>&lt;<span style=color:#f92672>K</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>keyof</span> <span style=color:#a6e22e>T</span>&gt;(<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>K</span>, <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>T</span>[<span style=color:#a6e22e>K</span>])<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>extensions</span>[<span style=color:#a6e22e>key</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 转换为响应对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>toResponse</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>BaseFeedingResponse</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>T</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>level</span>: <span style=color:#66d9ef>this.level</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>exp</span>: <span style=color:#66d9ef>this.exp</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expProgress</span>: <span style=color:#66d9ef>this.expProgress</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>hp</span>: <span style=color:#66d9ef>this.hp</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>attack</span>: <span style=color:#66d9ef>this.attack</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>this.levelUpCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>this.rewards</span>,
</span></span><span style=display:flex><span>      ...<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>extensions</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>BaseFeedingResponse</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>T</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=策略接口定义>策略接口定义<a hidden class=anchor aria-hidden=true href=#策略接口定义>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// 喂养策略扩展点接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IFeedingStrategy</span>&lt;<span style=color:#f92672>TResponse</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>BaseFeedingResponse </span><span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 扩展点1：计算经验加成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 扩展点2：喂养前的校验逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>beforeFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>boolean</span>&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 扩展点3：喂养后的额外处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 扩展点4：生成奖励
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Reward</span>[];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 扩展点5：扩展返回结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>extendResult</span>(<span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>FeedingResult</span>&lt;<span style=color:#f92672>any</span>&gt;, <span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 抽象基础策略类（提供默认实现）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BaseFeedingStrategy</span>&lt;<span style=color:#f92672>TResponse</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>BaseFeedingResponse </span><span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>IFeedingStrategy</span>&lt;<span style=color:#f92672>TResponse</span>&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>beforeFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>boolean</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 默认实现：允许喂养
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 默认实现：不做任何处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Reward</span>[];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>extendResult</span>(<span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>FeedingResult</span>&lt;<span style=color:#f92672>any</span>&gt;, <span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 默认实现：不做任何扩展
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=应用服务模板方法>应用服务（模板方法）<a hidden class=anchor aria-hidden=true href=#应用服务模板方法>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// 基础喂养应用服务（模板方法）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BasePetFeedingService</span>&lt;<span style=color:#f92672>TResponse</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>BaseFeedingResponse </span><span style=color:#f92672>=</span> <span style=color:#a6e22e>BaseFeedingResponse</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>petRepository</span>: <span style=color:#66d9ef>IPetRepository</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>feedingStrategy</span>: <span style=color:#66d9ef>IFeedingStrategy</span>&lt;<span style=color:#f92672>TResponse</span>&gt;
</span></span><span style=display:flex><span>  ) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 模板方法：定义喂养流程骨架
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>feedPet</span>(<span style=color:#a6e22e>petId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>TResponse</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1. 加载聚合根
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petRepository</span>.<span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>petId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>pet</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;宠物不存在&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. 扩展点：喂养前校验
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>canFeed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>feedingStrategy</span>.<span style=color:#a6e22e>beforeFeed</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>foodValue</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>canFeed</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;当前无法喂养宠物&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. 扩展点：计算经验加成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expBonus</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>feedingStrategy</span>.<span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>foodValue</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>actualFoodValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>expBonus</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. 执行核心业务逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>oldLevel</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>feed</span>(<span style=color:#a6e22e>actualFoodValue</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newLevel</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>newLevel</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>oldLevel</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. 扩展点：生成奖励
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rewards</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>feedingStrategy</span>.<span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>levelUpCount</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 6. 持久化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>petRepository</span>.<span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>pet</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 7. 扩展点：喂养后处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>feedingStrategy</span>.<span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>levelUpCount</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 8. 构建基础返回结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>FeedingResult</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>levelUpCount</span>, <span style=color:#a6e22e>rewards</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 9. 扩展点：扩展返回结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>foodValue</span>, <span style=color:#a6e22e>expBonus</span>, <span style=color:#a6e22e>actualFoodValue</span> };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>feedingStrategy</span>.<span style=color:#a6e22e>extendResult</span>(<span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>context</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 10. 返回结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>toResponse</span>() <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>TResponse</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=业务实现扩展点>业务实现扩展点<a hidden class=anchor aria-hidden=true href=#业务实现扩展点>#</a></h5><h6 id=1-普通宠物喂养策略>1. 普通宠物喂养策略<a hidden class=anchor aria-hidden=true href=#1-普通宠物喂养策略>#</a></h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// 普通宠物喂养策略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NormalFeedingStrategy</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseFeedingStrategy</span>&lt;<span style=color:#f92672>NormalFeedingResponse</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 普通宠物没有加成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Reward</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 每升1级给100金币
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [{
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;gold&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>levelUpCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;宠物升级奖励&#39;</span>
</span></span><span style=display:flex><span>    }];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>extendResult</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>FeedingResult</span>&lt;<span style=color:#f92672>NormalFeedingExtensions</span>&gt;,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 普通策略添加基础统计信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;feedCount&#39;</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;totalExpGained&#39;</span>, <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>actualFoodValue</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h6 id=2-vip宠物喂养策略>2. VIP宠物喂养策略<a hidden class=anchor aria-hidden=true href=#2-vip宠物喂养策略>#</a></h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// VIP宠物喂养策略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VipFeedingStrategy</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseFeedingStrategy</span>&lt;<span style=color:#f92672>VipFeedingResponse</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>vipLevel</span>: <span style=color:#66d9ef>VipLevel</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// VIP玩家获得经验加成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bonusRates</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>VipLevel</span>, <span style=color:#a6e22e>number</span>&gt; <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>1</span>: <span style=color:#66d9ef>0.1</span>,  <span style=color:#75715e>// VIP1: 10%加成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>2</span>: <span style=color:#66d9ef>0.2</span>,  <span style=color:#75715e>// VIP2: 20%加成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>3</span>: <span style=color:#66d9ef>0.3</span>   <span style=color:#75715e>// VIP3: 30%加成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>bonusRates</span>[<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vipLevel</span>]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Reward</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>Reward</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 基础金币奖励
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;gold&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>levelUpCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;宠物升级奖励&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// VIP额外奖励
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;diamond&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vipLevel</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;VIP专属升级奖励&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rewards</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// VIP玩家升级后发送特殊通知
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`🎉 恭喜VIP</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vipLevel</span><span style=color:#e6db74>}</span><span style=color:#e6db74>玩家，宠物</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>升级到</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>级！`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>extendResult</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>FeedingResult</span>&lt;<span style=color:#f92672>VipFeedingExtensions</span>&gt;,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// VIP策略添加VIP特权信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;vipLevel&#39;</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vipLevel</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;expBonus&#39;</span>, <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>expBonus</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;bonusRate&#39;</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>expBonus</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>).<span style=color:#a6e22e>toFixed</span>(<span style=color:#ae81ff>1</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 计算VIP特权节省的时间（假设）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>savedFeeds</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>expBonus</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>foodValue</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;vipPrivilege&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>savedFeeds</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`VIP</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vipLevel</span><span style=color:#e6db74>}</span><span style=color:#e6db74>特权为您节省了</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>savedFeeds</span><span style=color:#e6db74>}</span><span style=color:#e6db74>次喂养`</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h6 id=3-传说宠物喂养策略>3. 传说宠物喂养策略<a hidden class=anchor aria-hidden=true href=#3-传说宠物喂养策略>#</a></h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// 传说宠物喂养策略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LegendaryFeedingStrategy</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseFeedingStrategy</span>&lt;<span style=color:#f92672>LegendaryFeedingResponse</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>comboCount</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 连击次数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>lastFeedTime</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>eventManager</span>: <span style=color:#66d9ef>EventManager</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>beforeFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>boolean</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 传说宠物每天只能喂养3次
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>feedCountToday</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getFeedCountToday</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>feedCountToday</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 计算连击
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastFeedTime</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>-</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastFeedTime</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5000</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastFeedTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>now</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>foodValue</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 连击加成：每连击一次增加20%经验
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>comboBonus</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.2</span> <span style=color:#f92672>*</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 传说宠物基础加成50%
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>legendaryBonus</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.5</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>comboBonus</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>legendaryBonus</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>generateRewards</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Reward</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rewards</span>: <span style=color:#66d9ef>Reward</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 基础奖励
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;gold&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>levelUpCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;宠物升级奖励&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 传说级大额钻石奖励
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;diamond&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>levelUpCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;传说宠物升级奖励&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 连击奖励
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;special_item&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>itemId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;legendary_food&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span><span style=color:#e6db74>}</span><span style=color:#e6db74>连击特殊奖励`</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 触发稀有事件（概率）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0.1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;rare_event&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>const</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>eventId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;treasure_hunt&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;触发传说事件：寻宝之旅&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rewards</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>, <span style=color:#a6e22e>levelUpCount</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发布传说宠物喂养事件（供其他系统监听）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>eventManager</span>.<span style=color:#a6e22e>publish</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;LegendaryPetFed&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>petId</span>: <span style=color:#66d9ef>pet.id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>level</span>: <span style=color:#66d9ef>pet.getLevel</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comboCount</span>: <span style=color:#66d9ef>this.comboCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>Date.now</span>()
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>levelUpCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`⚡ 传说宠物</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>升级！当前</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span><span style=color:#e6db74>}</span><span style=color:#e6db74>连击！`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getFeedCountToday</span>(<span style=color:#a6e22e>petId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>number</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从缓存或数据库获取今日喂养次数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 这里简化处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>extendResult</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>FeedingResult</span>&lt;<span style=color:#f92672>LegendaryFeedingExtensions</span>&gt;,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pet</span>: <span style=color:#66d9ef>Pet</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>FeedingContext</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 传说宠物添加丰富的扩展信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1. 连击系统信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>comboStatus</span>: <span style=color:#66d9ef>ComboStatus</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;AMAZING!&#39;</span> <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;GREAT!&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GOOD&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;comboInfo&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comboCount</span>: <span style=color:#66d9ef>this.comboCount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comboBonus</span>: <span style=color:#66d9ef>Math.floor</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.2</span> <span style=color:#f92672>*</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>comboCount</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>nextComboAt</span>: <span style=color:#66d9ef>this.lastFeedTime</span><span style=color:#f92672>!</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5000</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comboStatus</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. 今日剩余喂养次数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;dailyLimit&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>remaining</span>: <span style=color:#66d9ef>2</span>, <span style=color:#75715e>// 简化处理，实际应该查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>total</span>: <span style=color:#66d9ef>3</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>resetAt</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>setHours</span>(<span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. 特殊事件触发记录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>specialRewards</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>rewards</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>r</span>.<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;rare_event&#39;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>.<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;special_item&#39;</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>specialRewards</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;specialEvents&#39;</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>triggered</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>events</span>: <span style=color:#66d9ef>specialRewards</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;⚡ 恭喜触发传说事件！&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. 传说宠物专属统计
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>addExtension</span>(<span style=color:#e6db74>&#39;legendaryStats&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>totalBonus</span>: <span style=color:#66d9ef>context.expBonus</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>legendaryBonus</span>: <span style=color:#66d9ef>Math.floor</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.5</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>efficiency</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span>((<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>actualFoodValue</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>foodValue</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>).<span style=color:#a6e22e>toFixed</span>(<span style=color:#ae81ff>0</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rank</span>: <span style=color:#66d9ef>this.calculateRank</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>getLevel</span>())
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>calculateRank</span>(<span style=color:#a6e22e>level</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>PetRank</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>level</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>50</span>) <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;S级传说&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>level</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>30</span>) <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;A级史诗&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>level</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;B级稀有&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;C级普通&#39;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=使用示例>使用示例<a hidden class=anchor aria-hidden=true href=#使用示例>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// 根据不同业务场景选择策略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 1. 普通玩家喂养（返回类型为 NormalFeedingResponse）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>normalService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>&lt;<span style=color:#f92672>NormalFeedingResponse</span>&gt;(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>petRepository</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NormalFeedingStrategy</span>()
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result1</span>: <span style=color:#66d9ef>NormalFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>normalService</span>.<span style=color:#a6e22e>feedPet</span>(<span style=color:#e6db74>&#39;pet-123&#39;</span>, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;普通玩家结果:&#39;</span>, <span style=color:#a6e22e>result1</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>/* 输出:
</span></span></span><span style=display:flex><span><span style=color:#75715e>{
</span></span></span><span style=display:flex><span><span style=color:#75715e>  level: 5,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  exp: 50,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  expProgress: &#39;50.00%&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  hp: 150,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  attack: 75,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  levelUpCount: 1,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  rewards: [{ type: &#39;gold&#39;, amount: 100, reason: &#39;宠物升级奖励&#39; }],
</span></span></span><span style=display:flex><span><span style=color:#75715e>  feedCount: 1,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  totalExpGained: 100
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 2. VIP玩家喂养（返回类型为 VipFeedingResponse）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>vipService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>&lt;<span style=color:#f92672>VipFeedingResponse</span>&gt;(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>petRepository</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>VipFeedingStrategy</span>(<span style=color:#ae81ff>2</span>) <span style=color:#75715e>// VIP等级2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result2</span>: <span style=color:#66d9ef>VipFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>vipService</span>.<span style=color:#a6e22e>feedPet</span>(<span style=color:#e6db74>&#39;pet-456&#39;</span>, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;VIP玩家结果:&#39;</span>, <span style=color:#a6e22e>result2</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>/* 输出:
</span></span></span><span style=display:flex><span><span style=color:#75715e>{
</span></span></span><span style=display:flex><span><span style=color:#75715e>  level: 5,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  exp: 70,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  expProgress: &#39;70.00%&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  hp: 150,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  attack: 75,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  levelUpCount: 1,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  rewards: [
</span></span></span><span style=display:flex><span><span style=color:#75715e>    { type: &#39;gold&#39;, amount: 100, reason: &#39;宠物升级奖励&#39; },
</span></span></span><span style=display:flex><span><span style=color:#75715e>    { type: &#39;diamond&#39;, amount: 20, reason: &#39;VIP专属升级奖励&#39; }
</span></span></span><span style=display:flex><span><span style=color:#75715e>  ],
</span></span></span><span style=display:flex><span><span style=color:#75715e>  vipLevel: 2,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  expBonus: 20,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  bonusRate: &#39;20.0%&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  vipPrivilege: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    savedFeeds: 0,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    message: &#39;VIP2特权为您节省了0次喂养&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  }
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 3. 传说宠物喂养（连击3次，返回类型为 LegendaryFeedingResponse）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>legendaryService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>&lt;<span style=color:#f92672>LegendaryFeedingResponse</span>&gt;(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>petRepository</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LegendaryFeedingStrategy</span>(<span style=color:#a6e22e>eventManager</span>)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result3</span>: <span style=color:#66d9ef>LegendaryFeedingResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>legendaryService</span>.<span style=color:#a6e22e>feedPet</span>(<span style=color:#e6db74>&#39;pet-789&#39;</span>, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;传说宠物结果:&#39;</span>, <span style=color:#a6e22e>result3</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>/* 输出:
</span></span></span><span style=display:flex><span><span style=color:#75715e>{
</span></span></span><span style=display:flex><span><span style=color:#75715e>  level: 6,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  exp: 100,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  expProgress: &#39;83.33%&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  hp: 180,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  attack: 90,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  levelUpCount: 1,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  rewards: [
</span></span></span><span style=display:flex><span><span style=color:#75715e>    { type: &#39;gold&#39;, amount: 100, reason: &#39;宠物升级奖励&#39; },
</span></span></span><span style=display:flex><span><span style=color:#75715e>    { type: &#39;diamond&#39;, amount: 50, reason: &#39;传说宠物升级奖励&#39; },
</span></span></span><span style=display:flex><span><span style=color:#75715e>    { type: &#39;special_item&#39;, itemId: &#39;legendary_food&#39;, amount: 1, reason: &#39;3连击特殊奖励&#39; }
</span></span></span><span style=display:flex><span><span style=color:#75715e>  ],
</span></span></span><span style=display:flex><span><span style=color:#75715e>  comboInfo: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    comboCount: 3,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    comboBonus: 40,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    nextComboAt: 1696852345000,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    comboStatus: &#39;AMAZING!&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  },
</span></span></span><span style=display:flex><span><span style=color:#75715e>  dailyLimit: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    remaining: 2,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    total: 3,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    resetAt: 1696867200000
</span></span></span><span style=display:flex><span><span style=color:#75715e>  },
</span></span></span><span style=display:flex><span><span style=color:#75715e>  specialEvents: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    triggered: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    events: [
</span></span></span><span style=display:flex><span><span style=color:#75715e>      { type: &#39;special_item&#39;, itemId: &#39;legendary_food&#39;, amount: 1, reason: &#39;3连击特殊奖励&#39; }
</span></span></span><span style=display:flex><span><span style=color:#75715e>    ],
</span></span></span><span style=display:flex><span><span style=color:#75715e>    message: &#39;⚡ 恭喜触发传说事件！&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  },
</span></span></span><span style=display:flex><span><span style=color:#75715e>  legendaryStats: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    totalBonus: 90,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    legendaryBonus: 50,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    efficiency: &#39;90%&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    rank: &#39;C级普通&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  }
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><h5 id=扩展点模式的优势>扩展点模式的优势<a hidden class=anchor aria-hidden=true href=#扩展点模式的优势>#</a></h5><ol><li><p><strong>开闭原则</strong>：</p><ul><li>核心流程（<code>feedPet</code>方法）保持稳定,无需修改</li><li>新增业务类型只需实现新的策略类</li></ul></li><li><p><strong>职责清晰</strong>：</p><ul><li><code>BasePetFeedingService</code>：负责流程编排</li><li>策略类：负责具体业务逻辑</li><li>领域模型：负责核心业务规则</li><li><code>FeedingResult</code>：负责结构化返回数据</li></ul></li><li><p><strong>返回结果可扩展</strong>：</p><ul><li>定义了统一的 <code>FeedingResult</code> 接口</li><li>每个策略可以通过 <code>extendResult</code> 添加自己的扩展字段</li><li>客户端获得完整且类型安全的响应数据</li><li>避免了返回结果的"上帝对象"问题</li></ul></li><li><p><strong>易于测试</strong>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 可以轻松mock策略进行测试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;喂养流程应该调用所有扩展点&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mockStrategy</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>beforeFeed</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>fn</span>().<span style=color:#a6e22e>mockResolvedValue</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>calculateExpBonus</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>fn</span>().<span style=color:#a6e22e>mockReturnValue</span>(<span style=color:#ae81ff>50</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>generateRewards</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>fn</span>().<span style=color:#a6e22e>mockReturnValue</span>([]),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>afterFeed</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>fn</span>()
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>service</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>(<span style=color:#a6e22e>mockRepo</span>, <span style=color:#a6e22e>mockStrategy</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>feedPet</span>(<span style=color:#e6db74>&#39;pet-1&#39;</span>, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>mockStrategy</span>.<span style=color:#a6e22e>beforeFeed</span>).<span style=color:#a6e22e>toHaveBeenCalled</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>mockStrategy</span>.<span style=color:#a6e22e>calculateExpBonus</span>).<span style=color:#a6e22e>toHaveBeenCalled</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>mockStrategy</span>.<span style=color:#a6e22e>generateRewards</span>).<span style=color:#a6e22e>toHaveBeenCalled</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>mockStrategy</span>.<span style=color:#a6e22e>afterFeed</span>).<span style=color:#a6e22e>toHaveBeenCalled</span>();
</span></span><span style=display:flex><span>});
</span></span></code></pre></div></li><li><p><strong>灵活组合</strong>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 可以通过组合模式支持多种策略叠加
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CompositeStrategy</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>IFeedingStrategy</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>strategies</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>strategies</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>strategies</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>foodValue</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>strategies</span>.<span style=color:#a6e22e>reduce</span>(
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>total</span>, <span style=color:#a6e22e>strategy</span>) =&gt; <span style=color:#a6e22e>total</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>calculateExpBonus</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>foodValue</span>),
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>levelUpCount</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>strategy</span> <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>strategies</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>afterFeed</span>(<span style=color:#a6e22e>pet</span>, <span style=color:#a6e22e>levelUpCount</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 同时应用VIP和节日双倍经验
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>compositeService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>petRepository</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CompositeStrategy</span>([
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>VipFeedingStrategy</span>(<span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>HolidayBonusStrategy</span>()
</span></span><span style=display:flex><span>  ])
</span></span><span style=display:flex><span>);
</span></span></code></pre></div></li><li><p><strong>运行时切换</strong>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 可以根据运行时条件动态选择策略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>createFeedingService</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>pet</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>strategy</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>quality</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;legendary&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LegendaryFeedingStrategy</span>(<span style=color:#a6e22e>eventManager</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>vipLevel</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>VipFeedingStrategy</span>(<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>vipLevel</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NormalFeedingStrategy</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasePetFeedingService</span>(<span style=color:#a6e22e>petRepository</span>, <span style=color:#a6e22e>strategy</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol><h5 id=架构示意图>架构示意图<a hidden class=anchor aria-hidden=true href=#架构示意图>#</a></h5><pre tabindex=0><code class=language-mermaid data-lang=mermaid>classDiagram
    class BasePetFeedingService {
        -petRepository
        -feedingStrategy
        +feedPet(petId, foodValue)
    }

    class IFeedingStrategy {
        &lt;&lt;interface&gt;&gt;
        +calculateExpBonus(pet, foodValue)
        +beforeFeed(pet, foodValue)
        +afterFeed(pet, levelUpCount)
        +generateRewards(pet, levelUpCount)
    }

    class NormalFeedingStrategy {
        +calculateExpBonus()
        +generateRewards()
    }

    class VipFeedingStrategy {
        -vipLevel
        +calculateExpBonus()
        +generateRewards()
        +afterFeed()
    }

    class LegendaryFeedingStrategy {
        -eventManager
        -comboCount
        +beforeFeed()
        +calculateExpBonus()
        +generateRewards()
        +afterFeed()
    }

    BasePetFeedingService --&gt; IFeedingStrategy : 依赖
    IFeedingStrategy &lt;|.. NormalFeedingStrategy : 实现
    IFeedingStrategy &lt;|.. VipFeedingStrategy : 实现
    IFeedingStrategy &lt;|.. LegendaryFeedingStrategy : 实现
</code></pre><p>通过这种扩展点设计,我们实现了：</p><ul><li><strong>统一流程</strong>：所有宠物喂养都遵循相同的流程骨架</li><li><strong>差异化定制</strong>：不同业务场景可以定制自己的逻辑</li><li><strong>解耦扩展</strong>：新增业务类型不影响现有代码</li><li><strong>便于维护</strong>：每个策略职责单一,易于理解和修改</li></ul><p>这正是 DDD 中"将可变的业务逻辑与稳定的流程分离"的最佳实践。</p><h5 id=项目结构>项目结构<a hidden class=anchor aria-hidden=true href=#项目结构>#</a></h5><p><strong>目录结构</strong></p><p>base 中包含基础设施（infrastructure）和功能组件（component）和骨架实现（skeleton）</p><ul><li>基础设施主要指的是一些二三方的依赖的封装，通过内部API的形式进行提供</li><li>功能组件就是一些相对完整，独立的功能模块</li><li>骨架实现一般是一些功能接维度的通用骨架逻辑实现，包含接口请求来的参数校验、核心处理、结构封装返回等</li></ul><p>sdk 是接口定义和契约层，base 中针对SDK 中定义的接口进行实现，sdk 中主要包含系统的所有接口、策略扩展点、数据模型、常量和工具类</p><p>module 则是具体的游戏业务实现，会引用SDK，但是不直接引用base，完成具体的策略扩展点的重写，从而实现定制化的业务功能</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── base
</span></span><span style=display:flex><span>│   ├── component
</span></span><span style=display:flex><span>│   ├── infrastructure
</span></span><span style=display:flex><span>│   └── skeleton
</span></span><span style=display:flex><span>├── sdk
</span></span><span style=display:flex><span>└── module
</span></span><span style=display:flex><span>    └── gameBusiness
</span></span></code></pre></div><p><strong>依赖关系图</strong></p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>flowchart TB
 subgraph subGraph0[&#34;业务模块层 (module)&#34;]
        PM[&#34;promotion-module&#34;]
        P618[&#34;promotion618&#34;]
        P1111[&#34;promotion1111&#34;]
  end
 subgraph subGraph1[&#34;SDK层 (sdk)&#34;]
        SDK[&#34;sdk&#34;]
        SDK_COMMON[&#34;sdk/common&#34;]
        SDK_COMPONENT[&#34;sdk/component&#34;]
        SDK_INFRA[&#34;sdk/infrastructure&#34;]
        SDK_SKELETON[&#34;sdk/skeleton&#34;]
  end
 subgraph subGraph2[&#34;基础实现层 (base)&#34;]
        BASE[&#34;base&#34;]
        BASE_INFRA[&#34;infrastructure&#34;]
        BASE_COMPONENT[&#34;component&#34;]
        BASE_SKELETON[&#34;skeleton&#34;]
        BASE_DRAW[&#34;draw&#34;]
        BASE_PET[&#34;pet&#34;]
  end
    PM --&gt; P618 &amp; P1111
    SDK --&gt; SDK_COMMON &amp; SDK_COMPONENT &amp; SDK_INFRA &amp; SDK_SKELETON
    BASE --&gt; BASE_INFRA &amp; BASE_COMPONENT &amp; BASE_SKELETON
    BASE_COMPONENT --&gt; BASE_DRAW
    BASE_SKELETON --&gt; BASE_PET
    PM -. 依赖 .-&gt; SDK
    P618 -. 依赖 .-&gt; SDK
    P1111 -. 依赖 .-&gt; SDK
    BASE_INFRA -. 依赖 .-&gt; SDK
    BASE_COMPONENT -. 依赖 .-&gt; SDK &amp; BASE_INFRA
    BASE_SKELETON -. 依赖 .-&gt; SDK &amp; BASE_INFRA
</code></pre><h4 id=ddd方式的优势>DDD方式的优势<a hidden class=anchor aria-hidden=true href=#ddd方式的优势>#</a></h4><p>通过上面的对比可以看到：</p><ol><li><p><strong>业务逻辑内聚</strong>：</p><ul><li>经验计算、升级判断、属性提升都封装在对应的领域对象中</li><li>Service层变得非常薄，只负责编排</li></ul></li><li><p><strong>易于测试</strong>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 单元测试不需要数据库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;宠物喂养后应该获得经验&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Pet</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;1&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Pikachu&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;rare&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;rare&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PetStats</span>(<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;rare&#39;</span>)
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>feed</span>(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>pet</span>.<span style=color:#a6e22e>experience</span>.<span style=color:#a6e22e>current</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;史诗宠物升级所需经验更多&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>exp1</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;common&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>exp2</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Experience</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;epic&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>exp2</span>.<span style=color:#a6e22e>getRequiredForNextLevel</span>())
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>toBeGreaterThan</span>(<span style=color:#a6e22e>exp1</span>.<span style=color:#a6e22e>getRequiredForNextLevel</span>());
</span></span><span style=display:flex><span>});
</span></span></code></pre></div></li><li><p><strong>业务规则清晰可见</strong>：</p><ul><li>代码直接表达业务概念：<code>pet.feed()</code>, <code>experience.canLevelUp()</code></li><li>新人可以通过阅读领域模型快速理解业务</li></ul></li><li><p><strong>易于扩展</strong>：</p><ul><li>添加新品质的宠物？只需修改值对象中的配置</li><li>修改升级公式？只在Experience中修改</li><li>添加新的宠物行为？在Pet实体中添加方法</li></ul></li><li><p><strong>事件驱动</strong>：</p><ul><li>通过领域事件解耦副作用（通知、日志、统计等）</li><li>便于实现复杂的业务流程</li></ul></li><li><p><strong>状态一致性</strong>：</p><ul><li>聚合根保证宠物状态的一致性</li><li>不会出现"经验已扣除但等级未提升"的情况</li></ul></li></ol><h2 id=nodejs上现有的实现>NodeJS上现有的实现<a hidden class=anchor aria-hidden=true href=#nodejs上现有的实现>#</a></h2><p><a href=https://github.com/stemmlerjs/white-label>white-label</a>是基于源码级别的 <code>Domain-Driven Design Demo</code>，有非常高的参考性</p><p><a href=https://github.com/4lessandrodev/type-ddd>type-ddd</a> 这个是<code>NodeJS</code>中针对是 <code>Domain-Driven Design</code> 的一个封装，主要是提供<code>utils</code>、 <code>Entity</code>、<code>Value Objects</code>、<code>Factories</code>、<code>Aggregates</code>、<code>Repository</code>、<code>Domain events</code>等来建立复杂的应用，可以看下项目的 <code>README</code> 有最基本的用法示例</p><p>针对这两个项目，可以先看下 <code>white-label</code>，之后实践过程中则可以使用 <code>type-ddd</code> 进行具体的编码实现</p><h2 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h2><ul><li>DDD中类型接口：<a href=https://github.com/4lessandrodev/type-ddd>https://github.com/4lessandrodev/type-ddd</a></li><li>DDD教程：<a href=https://github.com/stemmlerjs/ddd-forum>https://github.com/stemmlerjs/ddd-forum</a></li><li>NodeJS 中的示例： <a href=https://github.com/stemmlerjs/white-label>https://github.com/stemmlerjs/white-label</a></li><li>Rich-Domain:<a href=https://github.com/4lessandrodev/rich-domain>https://github.com/4lessandrodev/rich-domain</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://genluo.github.io/my-blog/tags/%E6%9C%8D%E5%8A%A1%E7%AB%AF/>服务端</a></li></ul><nav class=paginav><a class=prev href=https://genluo.github.io/my-blog/posts/agent/><span class=title>« Prev</span><br><span>Agent 技术调研</span>
</a><a class=next href=https://genluo.github.io/my-blog/posts/clangformat/><span class=title>Next »</span><br><span>Clangformat</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 领域驱动设计 on x" href="https://x.com/intent/tweet/?text=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1&amp;url=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f&amp;hashtags=%e6%9c%8d%e5%8a%a1%e7%ab%af"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 领域驱动设计 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f&amp;title=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1&amp;summary=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1&amp;source=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 领域驱动设计 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f&title=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 领域驱动设计 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 领域驱动设计 on whatsapp" href="https://api.whatsapp.com/send?text=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1%20-%20https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 领域驱动设计 on telegram" href="https://telegram.me/share/url?text=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1&amp;url=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 领域驱动设计 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e9%a2%86%e5%9f%9f%e9%a9%b1%e5%8a%a8%e8%ae%be%e8%ae%a1&u=https%3a%2f%2fgenluo.github.io%2fmy-blog%2fposts%2fddd%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://genluo.github.io/my-blog/>Genluo</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>